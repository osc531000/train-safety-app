<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∏∞Ï∞® ÏïàÏ†Ñ Í≤ΩÍ≥† ÏãúÏä§ÌÖú</title>
    
    <!-- HTTPS ÌïÑÏàò ÏïåÎ¶º -->
    <meta name="description" content="GPS Í∏∞Î∞ò Í∏∞Ï∞® ÏïàÏ†Ñ Í≤ΩÍ≥† ÏãúÏä§ÌÖú - HTTPS ÌôòÍ≤Ω ÌïÑÏöî">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            border-radius: 15px;
            color: white;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .https-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .https-warning.show {
            display: block;
        }

        .https-warning.hide {
            display: none;
        }

        .mode-selector {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .status-safe {
            background: #4caf50;
        }

        .status-warning {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        .status-danger {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        #map {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .info-panel {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-panel h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .warning-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            display: none;
        }

        .warning-message.show {
            display: block;
            animation: shake 0.5s ease-in-out;
        }

        .train-item.urgent {
            animation: urgentPulse 1s infinite;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .train-item.warning {
            animation: warningPulse 2s infinite;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }

        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .distance-input, select.distance-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            background: white;
            color: #333;
        }

        select.distance-input {
            cursor: pointer;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="m0 1 2 2 2-2z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 40px;
        }

        .train-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .train-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            font-size: 14px;
        }

        .train-item.subway {
            border-left-color: #2196f3;
        }

        .train-item.korail {
            border-left-color: #ff5722;
        }

        .train-item .train-line {
            font-weight: bold;
            color: #333;
        }

        .train-item .train-info {
            color: #666;
            margin-top: 5px;
        }

        .train-item .train-distance {
            color: #ff6b6b;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #c62828;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
            margin-top: 30px;
        }

        .nearby-stations {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }

        .station-item {
            background: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 5px;
            font-size: 13px;
            border-left: 3px solid #4caf50;
        }

        .gps-debug {
            background: #e1f5fe;
            border: 1px solid #b3e5fc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #01579b;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÜ Í∏∞Ï∞® ÏïàÏ†Ñ Í≤ΩÍ≥†</h1>
            <p>GPS Í∏∞Î∞ò Ïã§ÏãúÍ∞Ñ ÏïàÏ†Ñ Î™®ÎãàÌÑ∞ÎßÅ</p>
        </div>

        <!-- HTTPS Í≤ΩÍ≥† -->
        <div id="https-warning" class="https-warning">
            <strong>‚ö†Ô∏è Ï§ëÏöî!</strong><br>
            GPS Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ <strong>HTTPS ÌôòÍ≤Ω</strong>Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.<br>
            <small>GitHub PagesÏóê Î∞∞Ìè¨ÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú HTTPSÍ∞Ä Ï†ÅÏö©Îê©ÎãàÎã§.</small>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('gps')">GPS Í∏∞Î∞ò Í≤ΩÍ≥†</button>
            <button class="mode-btn" onclick="switchMode('manual')">ÏàòÎèô ÏúÑÏπò ÏÑ†ÌÉù</button>
        </div>

        <!-- GPS Í∏∞Î∞ò Î™®Îìú -->
        <div id="gps-mode" class="content-section active">
            <div class="status-card">
                <div id="gps-status-indicator" class="status-indicator status-safe">üìç</div>
                <h3 id="gps-status-text">GPS ÏúÑÏπò ÌôïÏù∏ Ï§ë...</h3>
                <p id="gps-location-text">ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Í≥† ÏûàÏäµÎãàÎã§</p>
            </div>

            <!-- GPS ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ -->
            <div id="gps-debug" class="gps-debug" style="display:none;">
                <strong>GPS ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥:</strong><br>
                <span id="debug-info">ÌôïÏù∏ Ï§ë...</span>
            </div>

            <div class="control-panel">
                <button id="start-monitoring" class="button btn-primary">Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë</button>
                <button id="stop-monitoring" class="button btn-danger" style="display:none;">Î™®ÎãàÌÑ∞ÎßÅ Ï§ëÏßÄ</button>
                <button id="retry-gps" class="button btn-secondary" style="display:none;">GPS Ïû¨ÏãúÎèÑ</button>
                
                <div style="margin-top: 15px;">
                    <label for="alert-distance">Í≤ΩÍ≥† Í±∞Î¶¨ (ÎØ∏ÌÑ∞):</label>
                    <input type="number" id="alert-distance" class="distance-input" value="500" min="100" max="2000">
                    
                    <label for="update-interval">Í∞±Ïã† Ï£ºÍ∏∞:</label>
                    <select id="update-interval" class="distance-input" style="height: 50px;">
                        <option value="5000">‚ö° 5Ï¥à (Í≥†ÏÑ±Îä•)</option>
                        <option value="10000">üî• 10Ï¥à (Îπ†Î¶Ñ)</option>
                        <option value="20000">‚öñÔ∏è 20Ï¥à (Í∑†Ìòï)</option>
                        <option value="30000" selected>üîã 30Ï¥à (Ï†àÏïΩ)</option>
                        <option value="60000">üí§ 60Ï¥à (Ï†ÄÏ†ÑÎ†•)</option>
                    </select>
                </div>
            </div>

            <div id="gps-warning" class="warning-message">
                <strong>‚ö†Ô∏è Í∏∞Ï∞® Ï†ëÍ∑º Í≤ΩÍ≥†!</strong><br>
                <span id="warning-details"></span>
            </div>

            <div class="info-panel">
                <h3>üìä Î™®ÎãàÌÑ∞ÎßÅ Ï†ïÎ≥¥</h3>
                <div class="info-item">
                    <span>ÏÉÅÌÉú:</span>
                    <span id="monitoring-status">ÎåÄÍ∏∞ Ï§ë</span>
                </div>
                <div class="info-item">
                    <span>Í∞±Ïã† Ï£ºÍ∏∞:</span>
                    <span id="current-interval">30Ï¥à</span>
                </div>
                <div class="info-item">
                    <span>ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏:</span>
                    <span id="last-update">-</span>
                </div>
                <div class="info-item">
                    <span>Í∑ºÏ≤ò Ïó≠ Ïàò:</span>
                    <span id="nearby-stations-count">0</span>
                </div>
            </div>

            <div id="nearby-stations" class="nearby-stations" style="display:none;">
                <h4>üìç Í∑ºÏ≤ò ÏßÄÌïòÏ≤†Ïó≠</h4>
                <div id="stations-list"></div>
            </div>
        </div>

        <!-- ÏàòÎèô ÏÑ†ÌÉù Î™®Îìú -->
        <div id="manual-mode" class="content-section">
            <div class="status-card">
                <div id="manual-status-indicator" class="status-indicator status-safe">üìç</div>
                <h3 id="manual-status-text">ÏúÑÏπòÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</h3>
                <p>ÏßÄÎèÑÏóêÏÑú Î™®ÎãàÌÑ∞ÎßÅÌï† ÏúÑÏπòÎ•º ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</p>
            </div>

            <div id="map"></div>

            <div class="control-panel">
                <button id="start-manual-monitoring" class="button btn-primary" disabled>ÏÑ†ÌÉùÌïú ÏúÑÏπò Î™®ÎãàÌÑ∞ÎßÅ</button>
                <button id="stop-manual-monitoring" class="button btn-danger" style="display:none;">Î™®ÎãàÌÑ∞ÎßÅ Ï§ëÏßÄ</button>
                
                <div style="margin-top: 15px;">
                    <label for="manual-alert-distance">Í≤ΩÍ≥† Í±∞Î¶¨ (ÎØ∏ÌÑ∞):</label>
                    <input type="number" id="manual-alert-distance" class="distance-input" value="500" min="100" max="2000">
                    
                    <label for="manual-update-interval">Í∞±Ïã† Ï£ºÍ∏∞:</label>
                    <select id="manual-update-interval" class="distance-input" style="height: 50px;">
                        <option value="5000">‚ö° 5Ï¥à (Í≥†ÏÑ±Îä•)</option>
                        <option value="10000">üî• 10Ï¥à (Îπ†Î¶Ñ)</option>
                        <option value="20000">‚öñÔ∏è 20Ï¥à (Í∑†Ìòï)</option>
                        <option value="30000" selected>üîã 30Ï¥à (Ï†àÏïΩ)</option>
                        <option value="60000">üí§ 60Ï¥à (Ï†ÄÏ†ÑÎ†•)</option>
                    </select>
                </div>
            </div>

            <div id="manual-warning" class="warning-message">
                <strong>‚ö†Ô∏è Í∏∞Ï∞® Ï†ëÍ∑º Í≤ΩÍ≥†!</strong><br>
                <span id="manual-warning-details"></span>
            </div>

            <div class="info-panel">
                <h3>üìç ÏÑ†ÌÉùÌïú ÏúÑÏπò</h3>
                <div class="info-item">
                    <span>ÏúÑÎèÑ:</span>
                    <span id="selected-lat">-</span>
                </div>
                <div class="info-item">
                    <span>Í≤ΩÎèÑ:</span>
                    <span id="selected-lng">-</span>
                </div>
                <div class="info-item">
                    <span>Ï£ºÏÜå:</span>
                    <span id="selected-address">-</span>
                </div>
            </div>
        </div>

        <div class="train-list" id="train-list" style="display:none;">
            <h3>üöÜ Ïã§ÏãúÍ∞Ñ Ïó¥Ï∞® Ï†ïÎ≥¥</h3>
            <div id="train-items"></div>
        </div>

        <div id="error-display" class="error-message" style="display:none;"></div>

        <div class="footer">
            <p>ÏïàÏ†ÑÏùÑ ÏúÑÌïú Ï∞∏Í≥†Ïö©ÏúºÎ°úÎßå ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî</p>
            <p>¬© 2025 Train Safety Alert System</p>
        </div>
    </div>

    <!-- Ïò§ÎîîÏò§ ÏöîÏÜå (ÏïåÎûåÏùå) -->
    <audio id="alarm-sound" preload="auto" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMe" type="audio/wav">
    </audio>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentPosition = null;
        let selectedPosition = null;
        let map = null;
        let marker = null;
        let monitoringInterval = null;
        let isMonitoring = false;
        let alarmSound = null;
        let nearbyStations = [];

        // API ÌÇ§Îì§
        const API_KEYS = {
            subway: '4a4d5943506f73633531764f4d6854',
            korail: 'b94e2e220ed1c348f7fe613a70da4ac557a1888a5d25f0e6e3d0e91e41ce4618'
        };

        // ÏÑúÏö∏ ÏßÄÌïòÏ≤†Ïó≠ + ÏΩîÎ†àÏùº Ï£ºÏöî Ïó≠ Îç∞Ïù¥ÌÑ∞ (Ï¢åÌëú Ìè¨Ìï®)
        const TRAIN_STATIONS = [
            // ÏßÄÌïòÏ≤†Ïó≠
            {name: 'ÏÑúÏö∏Ïó≠', lat: 37.5547, lng: 126.9706, lines: ['1Ìò∏ÏÑ†', '4Ìò∏ÏÑ†', 'KTX', 'Í≥µÌï≠Ï≤†ÎèÑ'], type: 'both'},
            {name: 'Ï¢ÖÎ°ú3Í∞Ä', lat: 37.5714, lng: 126.9910, lines: ['1Ìò∏ÏÑ†', '3Ìò∏ÏÑ†', '5Ìò∏ÏÑ†'], type: 'subway'},
            {name: 'ÏùÑÏßÄÎ°ú3Í∞Ä', lat: 37.5660, lng: 126.9911, lines: ['2Ìò∏ÏÑ†', '3Ìò∏ÏÑ†'], type: 'subway'},
            {name: 'Î™ÖÎèô', lat: 37.5634, lng: 126.9864, lines: ['4Ìò∏ÏÑ†'], type: 'subway'},
            {name: 'ÎèôÎåÄÎ¨∏', lat: 37.5714, lng: 127.0098, lines: ['1Ìò∏ÏÑ†', '4Ìò∏ÏÑ†'], type: 'subway'},
            {name: 'Í∞ïÎÇ®', lat: 37.4979, lng: 127.0276, lines: ['2Ìò∏ÏÑ†', 'Ïã†Î∂ÑÎãπÏÑ†'], type: 'subway'},
            {name: 'ÌôçÎåÄÏûÖÍµ¨', lat: 37.5574, lng: 126.9233, lines: ['2Ìò∏ÏÑ†', '6Ìò∏ÏÑ†', 'Í≥µÌï≠Ï≤†ÎèÑ'], type: 'subway'},
            {name: 'Ïã†Ï¥å', lat: 37.5556, lng: 126.9364, lines: ['2Ìò∏ÏÑ†'], type: 'subway'},
            {name: 'Ïù¥ÌÉúÏõê', lat: 37.5346, lng: 126.9947, lines: ['6Ìò∏ÏÑ†'], type: 'subway'},
            {name: 'ÏÇ¨Îãπ', lat: 37.4767, lng: 126.9814, lines: ['2Ìò∏ÏÑ†', '4Ìò∏ÏÑ†'], type: 'subway'},
            {name: 'Ïû†Ïã§', lat: 37.5134, lng: 127.1000, lines: ['2Ìò∏ÏÑ†', '8Ìò∏ÏÑ†'], type: 'subway'},
            {name: 'Í±¥ÎåÄÏûÖÍµ¨', lat: 37.5403, lng: 127.0701, lines: ['2Ìò∏ÏÑ†', '7Ìò∏ÏÑ†'], type: 'subway'},
            {name: 'ÍπÄÌè¨Í≥µÌï≠', lat: 37.5588, lng: 126.8014, lines: ['5Ìò∏ÏÑ†', '9Ìò∏ÏÑ†', 'Í≥µÌï≠Ï≤†ÎèÑ'], type: 'subway'},
            {name: 'ÏôïÏã≠Î¶¨', lat: 37.5617, lng: 127.0378, lines: ['2Ìò∏ÏÑ†', '5Ìò∏ÏÑ†', 'Î∂ÑÎãπÏÑ†', 'Ï§ëÏïôÏÑ†'], type: 'subway'},
            {name: 'Í≥†ÏÜçÌÑ∞ÎØ∏ÎÑê', lat: 37.5044, lng: 127.0051, lines: ['3Ìò∏ÏÑ†', '7Ìò∏ÏÑ†', '9Ìò∏ÏÑ†'], type: 'subway'},
            
            // ÏΩîÎ†àÏùº Ï£ºÏöî Ïó≠ Ï∂îÍ∞Ä
            {name: 'Ïö©ÏÇ∞Ïó≠', lat: 37.5297, lng: 126.9645, lines: ['KTX', 'ÏÉàÎßàÏùÑÌò∏', 'Î¨¥Í∂ÅÌôîÌò∏'], type: 'korail'},
            {name: 'Ï≤≠ÎüâÎ¶¨Ïó≠', lat: 37.5806, lng: 127.0472, lines: ['KTX', 'ITX-Ï≤≠Ï∂ò', 'Î¨¥Í∂ÅÌôîÌò∏'], type: 'korail'},
            {name: 'ÏòÅÎì±Ìè¨Ïó≠', lat: 37.5150, lng: 126.9076, lines: ['KTX', 'ÏÉàÎßàÏùÑÌò∏', 'Î¨¥Í∂ÅÌôîÌò∏'], type: 'korail'},
            {name: 'ÏàòÏõêÏó≠', lat: 37.2663, lng: 127.0011, lines: ['KTX', 'ÏÉàÎßàÏùÑÌò∏', 'Î¨¥Í∂ÅÌôîÌò∏', '1Ìò∏ÏÑ†'], type: 'both'},
            {name: 'ÎåÄÏ†ÑÏó≠', lat: 36.3315, lng: 127.4344, lines: ['KTX', 'ÏÉàÎßàÏùÑÌò∏', 'Î¨¥Í∂ÅÌôîÌò∏'], type: 'korail'},
            {name: 'ÎèôÎåÄÍµ¨Ïó≠', lat: 35.8790, lng: 128.6286, lines: ['KTX', 'ÏÉàÎßàÏùÑÌò∏', 'Î¨¥Í∂ÅÌôîÌò∏'], type: 'korail'},
            {name: 'Î∂ÄÏÇ∞Ïó≠', lat: 35.1155, lng: 129.0422, lines: ['KTX', 'ÏÉàÎßàÏùÑÌò∏', 'Î¨¥Í∂ÅÌôîÌò∏'], type: 'korail'},
            {name: 'Í¥ëÏ£ºÏÜ°Ï†ïÏó≠', lat: 35.1401, lng: 126.7935, lines: ['KTX', 'ÏÉàÎßàÏùÑÌò∏'], type: 'korail'},
            {name: 'Î™©Ìè¨Ïó≠', lat: 34.7947, lng: 126.3849, lines: ['KTX', 'Î¨¥Í∂ÅÌôîÌò∏'], type: 'korail'},
            {name: 'Í∞ïÎ¶âÏó≠', lat: 37.7635, lng: 128.8989, lines: ['KTX'], type: 'korail'},
            {name: 'Ìè¨Ìï≠Ïó≠', lat: 36.0413, lng: 129.3456, lines: ['ÏÉàÎßàÏùÑÌò∏', 'Î¨¥Í∂ÅÌôîÌò∏'], type: 'korail'}
        ];

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // HTTPS Ï≤¥ÌÅ¨
            checkHTTPS();
            
            // Ïò§ÎîîÏò§ Ï¥àÍ∏∞Ìôî
            alarmSound = document.getElementById('alarm-sound');
            
            // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
            initializeMap();
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupEventListeners();
            
            // GPS Í∂åÌïú ÏöîÏ≤≠
            requestLocationPermission();
        }

        function checkHTTPS() {
            const httpsWarning = document.getElementById('https-warning');
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                httpsWarning.className = 'https-warning show';
                updateDebugInfo('HTTP ÌôòÍ≤ΩÏóêÏÑúÎäî GPS Ï†ëÍ∑ºÏù¥ Ï†úÌïúÎê† Ïàò ÏûàÏäµÎãàÎã§');
            } else {
                httpsWarning.className = 'https-warning hide';
            }
        }

        function updateDebugInfo(info) {
            const debugDiv = document.getElementById('gps-debug');
            const debugInfo = document.getElementById('debug-info');
            debugInfo.textContent = info;
            debugDiv.style.display = 'block';
        }

        function setupEventListeners() {
            // GPS Î™®Îìú Î≤ÑÌäºÎì§
            document.getElementById('start-monitoring').addEventListener('click', startGPSMonitoring);
            document.getElementById('stop-monitoring').addEventListener('click', stopGPSMonitoring);
            document.getElementById('retry-gps').addEventListener('click', requestLocationPermission);
            
            // ÏàòÎèô Î™®Îìú Î≤ÑÌäºÎì§
            document.getElementById('start-manual-monitoring').addEventListener('click', startManualMonitoring);
            document.getElementById('stop-manual-monitoring').addEventListener('click', stopManualMonitoring);
            
            // Í∞±Ïã† Ï£ºÍ∏∞ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏
            document.getElementById('update-interval').addEventListener('change', function() {
                if (isMonitoring) {
                    // Î™®ÎãàÌÑ∞ÎßÅ Ï§ëÏù¥Î©¥ Ï¶âÏãú Ïû¨ÏãúÏûë
                    stopGPSMonitoring();
                    setTimeout(() => startGPSMonitoring(), 100);
                }
            });
            
            document.getElementById('manual-update-interval').addEventListener('change', function() {
                if (isMonitoring) {
                    // Î™®ÎãàÌÑ∞ÎßÅ Ï§ëÏù¥Î©¥ Ï¶âÏãú Ïû¨ÏãúÏûë
                    stopManualMonitoring();
                    setTimeout(() => startManualMonitoring(), 100);
                }
            });
        }

        function switchMode(mode) {
            // ÌôúÏÑ± Î≤ÑÌäº Î≥ÄÍ≤Ω
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // ÏΩòÌÖêÏ∏† ÏÑπÏÖò Î≥ÄÍ≤Ω
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            if (mode === 'gps') {
                document.getElementById('gps-mode').classList.add('active');
            } else {
                document.getElementById('manual-mode').classList.add('active');
            }
            
            // Í∏∞Ï°¥ Î™®ÎãàÌÑ∞ÎßÅ Ï§ëÏßÄ
            if (isMonitoring) {
                stopAllMonitoring();
            }
        }

        function initializeMap() {
            // Leaflet ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
            map = L.map('map').setView([37.5665, 126.9780], 10);

            // OpenStreetMap ÌÉÄÏùº Ï∂îÍ∞Ä
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            map.on('click', function(e) {
                setSelectedPosition(e.latlng.lat, e.latlng.lng);
            });

            // Í∏∞Ï∞®Ïó≠Îì§ ÎßàÏª§ Ï∂îÍ∞Ä
            TRAIN_STATIONS.forEach(station => {
                let markerColor = '#2196F3';
                let markerSize = 8;
                
                if (station.type === 'korail') {
                    markerColor = '#FF5722';
                    markerSize = 10;
                } else if (station.type === 'both') {
                    markerColor = '#9C27B0';
                    markerSize = 12;
                }
                
                const stationMarker = L.marker([station.lat, station.lng])
                    .bindPopup(`<b>${station.name}</b><br>${station.lines.join(', ')}<br><small>(${station.type === 'subway' ? 'ÏßÄÌïòÏ≤†' : station.type === 'korail' ? 'ÏΩîÎ†àÏùº' : 'ÏßÄÌïòÏ≤†+ÏΩîÎ†àÏùº'})</small>`)
                    .addTo(map);
                
                // Ïó≠ ÌÉÄÏûÖÎ≥Ñ Îã§Î•∏ ÏïÑÏù¥ÏΩò
                stationMarker.setIcon(L.divIcon({
                    html: `<div style="background:${markerColor};width:${markerSize}px;height:${markerSize}px;border-radius:50%;border:2px solid white;"></div>`,
                    iconSize: [markerSize + 4, markerSize + 4],
                    className: 'train-station-marker'
                }));
            });
        }

        function requestLocationPermission() {
            if (!navigator.geolocation) {
                updateGPSStatus('GPS ÎØ∏ÏßÄÏõê', 'Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî GPSÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§');
                updateDebugInfo('Geolocation APIÍ∞Ä ÏßÄÏõêÎêòÏßÄ ÏïäÏäµÎãàÎã§');
                document.getElementById('retry-gps').style.display = 'block';
                return;
            }

            document.getElementById('gps-status-text').textContent = 'GPS Í∂åÌïú ÏöîÏ≤≠ Ï§ë...';
            updateDebugInfo('GPS Í∂åÌïú ÏöîÏ≤≠ Ï§ë...');
            
            // GPS ÏòµÏÖò ÏÑ§Ï†ï
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,  // 15Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
                maximumAge: 300000  // 5Î∂ÑÍπåÏßÄ Ï∫êÏãúÎêú ÏúÑÏπò ÌóàÏö©
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    updateGPSStatus('ÏúÑÏπò ÌôïÏù∏ ÏôÑÎ£å', `ÏúÑÎèÑ: ${currentPosition.lat.toFixed(6)}, Í≤ΩÎèÑ: ${currentPosition.lng.toFixed(6)}`);
                    updateDebugInfo(`Ï†ïÌôïÎèÑ: ${Math.round(position.coords.accuracy)}m, ÏãúÍ∞Ñ: ${new Date(position.timestamp).toLocaleTimeString()}`);
                    
                    findNearbyStations(currentPosition);
                    document.getElementById('retry-gps').style.display = 'none';
                },
                function(error) {
                    let errorMsg = 'GPS Ïò§Î•ò: ';
                    let debugMsg = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'ÏúÑÏπò Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§';
                            debugMsg = 'PERMISSION_DENIED - ÏÇ¨Ïö©ÏûêÍ∞Ä ÏúÑÏπò Ï†ëÍ∑ºÏùÑ Í±∞Î∂ÄÌñàÏäµÎãàÎã§';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§';
                            debugMsg = 'POSITION_UNAVAILABLE - GPS Ïã†Ìò∏Î•º Î∞õÏùÑ Ïàò ÏóÜÏäµÎãàÎã§';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'ÏúÑÏπò ÏöîÏ≤≠ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§';
                            debugMsg = 'TIMEOUT - 15Ï¥à ÎÇ¥Ïóê ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§';
                            break;
                        default:
                            errorMsg += 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§';
                            debugMsg = `UNKNOWN ERROR (${error.code}): ${error.message}`;
                            break;
                    }
                    
                    updateGPSStatus('GPS Ïò§Î•ò', errorMsg);
                    updateDebugInfo(debugMsg);
                    document.getElementById('retry-gps').style.display = 'block';
                    
                    console.error('GPS Error:', error);
                },
                options
            );
        }

        function updateGPSStatus(status, location) {
            document.getElementById('gps-status-text').textContent = status;
            document.getElementById('gps-location-text').textContent = location;
        }

        function setSelectedPosition(lat, lng) {
            selectedPosition = { lat: lat, lng: lng };
            
            // Í∏∞Ï°¥ ÎßàÏª§ Ï†úÍ±∞
            if (marker) {
                map.removeLayer(marker);
            }
            
            // ÏÉà ÎßàÏª§ Ï∂îÍ∞Ä
            marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup('ÏÑ†ÌÉùÌïú ÏúÑÏπò').openPopup();
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('selected-lat').textContent = lat.toFixed(6);
            document.getElementById('selected-lng').textContent = lng.toFixed(6);
            document.getElementById('start-manual-monitoring').disabled = false;
            
            // Ï£ºÏÜåÎäî Í∞ÑÎã®Ìûà Ï¢åÌëúÎ°ú ÌëúÏãú (Nominatim API ÏÇ¨Ïö© Ïãú Ïó≠ÏßÄÏò§ÏΩîÎî© Í∞ÄÎä•)
            document.getElementById('selected-address').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            
            // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('manual-status-text').textContent = 'ÏúÑÏπò ÏÑ†ÌÉù ÏôÑÎ£å';
        }

        function findNearbyStations(position) {
            nearbyStations = TRAIN_STATIONS.filter(station => {
                const distance = calculateDistance(position.lat, position.lng, station.lat, station.lng);
                return distance <= 5000; // 5km Ïù¥ÎÇ¥
            }).map(station => ({
                ...station,
                distance: calculateDistance(position.lat, position.lng, station.lat, station.lng)
            })).sort((a, b) => a.distance - b.distance);

            document.getElementById('nearby-stations-count').textContent = nearbyStations.length;
            
            if (nearbyStations.length > 0) {
                displayNearbyStations(nearbyStations.slice(0, 8)); // ÏÉÅÏúÑ 8Í∞ú ÌëúÏãú
            }
        }

        function displayNearbyStations(stations) {
            const nearbyStationsDiv = document.getElementById('nearby-stations');
            const stationsList = document.getElementById('stations-list');
            
            stationsList.innerHTML = '';
            
            stations.forEach(station => {
                const stationDiv = document.createElement('div');
                stationDiv.className = 'station-item';
                
                let typeIcon = 'üöá';
                if (station.type === 'korail') typeIcon = 'üöÑ';
                if (station.type === 'both') typeIcon = 'üöÜ';
                
                stationDiv.innerHTML = `
                    ${typeIcon} <strong>${station.name}</strong> - ${Math.round(station.distance)}m<br>
                    <small>${station.lines.join(', ')}</small>
                `;
                stationsList.appendChild(stationDiv);
            });
            
            nearbyStationsDiv.style.display = 'block';
        }

        function startGPSMonitoring() {
            if (!currentPosition) {
                alert('GPS ÏúÑÏπò Ï†ïÎ≥¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§');
                return;
            }
            
            isMonitoring = true;
            document.getElementById('start-monitoring').style.display = 'none';
            document.getElementById('stop-monitoring').style.display = 'block';
            document.getElementById('monitoring-status').textContent = 'Î™®ÎãàÌÑ∞ÎßÅ Ï§ë';
            
            // ÏÑ†ÌÉùÎêú Í∞±Ïã† Ï£ºÍ∏∞ Ï†ÅÏö©
            const updateInterval = parseInt(document.getElementById('update-interval').value);
            
            // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Î™®ÎãàÌÑ∞ÎßÅ
            monitoringInterval = setInterval(() => {
                checkNearbyTrains(currentPosition);
            }, updateInterval);
            
            // Ï¶âÏãú Ìïú Î≤à Ïã§Ìñâ
            checkNearbyTrains(currentPosition);
            
            // Í∞±Ïã† Ï£ºÍ∏∞ ÌëúÏãú
            updateMonitoringInfo(0, updateInterval);
        }

        function stopGPSMonitoring() {
            stopAllMonitoring();
            document.getElementById('start-monitoring').style.display = 'block';
            document.getElementById('stop-monitoring').style.display = 'none';
            document.getElementById('monitoring-status').textContent = 'ÎåÄÍ∏∞ Ï§ë';
        }

        function startManualMonitoring() {
            if (!selectedPosition) {
                alert('ÏßÄÎèÑÏóêÏÑú ÏúÑÏπòÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
                return;
            }
            
            isMonitoring = true;
            document.getElementById('start-manual-monitoring').style.display = 'none';
            document.getElementById('stop-manual-monitoring').style.display = 'block';
            
            // ÏÑ†ÌÉùÎêú Í∞±Ïã† Ï£ºÍ∏∞ Ï†ÅÏö©
            const updateInterval = parseInt(document.getElementById('manual-update-interval').value);
            
            // Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Î™®ÎãàÌÑ∞ÎßÅ
            monitoringInterval = setInterval(() => {
                checkNearbyTrains(selectedPosition);
            }, updateInterval);
            
            // Ï¶âÏãú Ìïú Î≤à Ïã§Ìñâ
            checkNearbyTrains(selectedPosition);
        }

        function stopManualMonitoring() {
            stopAllMonitoring();
            document.getElementById('start-manual-monitoring').style.display = 'block';
            document.getElementById('stop-manual-monitoring').style.display = 'none';
        }

        function stopAllMonitoring() {
            isMonitoring = false;
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            hideWarning();
            stopAlarm();
            document.getElementById('train-list').style.display = 'none';
        }

        async function checkNearbyTrains(position) {
            const alertDistance = parseInt(
                document.getElementById('alert-distance').value || 
                document.getElementById('manual-alert-distance').value
            );
            
            try {
                // Í∑ºÏ≤ò Ïó≠Îì§Ïóê ÎåÄÌï¥ Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
                const stationsInRange = nearbyStations.length > 0 ? 
                    nearbyStations.filter(station => station.distance <= alertDistance * 3) :
                    TRAIN_STATIONS.filter(station => {
                        const distance = calculateDistance(position.lat, position.lng, station.lat, station.lng);
                        return distance <= alertDistance * 3;
                    }).slice(0, 5);

                let allTrainData = [];
                let dangerousTrains = [];

                for (const station of stationsInRange.slice(0, 5)) { // ÏÉÅÏúÑ 5Í∞ú Ïó≠Îßå Ï≤¥ÌÅ¨
                    try {
                        let trainData = [];
                        
                        // ÏßÄÌïòÏ≤† Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
                        if (station.type === 'subway' || station.type === 'both') {
                            const subwayData = await fetchSubwayRealtime(station.name);
                            trainData = [...trainData, ...subwayData];
                        }
                        
                        // ÏΩîÎ†àÏùº Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
                        if (station.type === 'korail' || station.type === 'both') {
                            const korailData = await fetchKorailData(station.name, position);
                            trainData = [...trainData, ...korailData];
                        }
                        
                        allTrainData = [...allTrainData, ...trainData];
                        
                        // ÏúÑÌóò Í±∞Î¶¨ ÎÇ¥ Ïó¥Ï∞® ÌôïÏù∏
                        const nearTrains = trainData.filter(train => {
                            const trainDistance = calculateDistance(position.lat, position.lng, station.lat, station.lng);
                            return trainDistance < alertDistance;
                        });
                        
                        dangerousTrains = [...dangerousTrains, ...nearTrains];
                    } catch (error) {
                        console.error(`${station.name} Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïò§Î•ò:`, error);
                    }
                }

                // Í≤ΩÍ≥† Ï≤òÎ¶¨
                if (dangerousTrains.length > 0) {
                    showWarning(dangerousTrains);
                    triggerAlarm();
                } else {
                    hideWarning();
                }

                // Ïó¥Ï∞® Ï†ïÎ≥¥ ÌëúÏãú
                displayTrainInfo(allTrainData);
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateMonitoringInfo(stationsInRange.length);
                
            } catch (error) {
                console.error('Î™®ÎãàÌÑ∞ÎßÅ ÏóêÎü¨:', error);
                showError('Î™®ÎãàÌÑ∞ÎßÅ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        async function fetchSubwayRealtime(stationName) {
            try {
                // Ïã§Ï†ú ÏÑúÏö∏Ïãú ÏßÄÌïòÏ≤† Ïã§ÏãúÍ∞Ñ ÎèÑÏ∞©Ï†ïÎ≥¥ API Ìò∏Ï∂ú
                const url = `http://swopenAPI.seoul.go.kr/api/subway/${API_KEYS.subway}/json/realtimeStationArrival/0/10/${encodeURIComponent(stationName)}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`API ÏùëÎãµ Ïò§Î•ò: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.errorMessage) {
                    throw new Error(data.errorMessage.message || 'API Ïò§Î•ò');
                }
                
                const arrivals = data.realtimeArrivalList || [];
                
                return arrivals.map(arrival => ({
                    type: 'subway',
                    station: stationName,
                    line: arrival.subwayId || arrival.trainLineNm,
                    direction: arrival.updnLine,
                    destination: arrival.bstatnNm,
                    arrivalMessage: arrival.arvlMsg2 || arrival.arvlMsg3,
                    arrivalCode: arrival.arvlCd,
                    currentStation: arrival.arvlMsg3,
                    timestamp: arrival.recptnDt
                }));
                
            } catch (error) {
                console.error(`${stationName} ÏßÄÌïòÏ≤† Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:`, error);
                // Î™®Ïùò Îç∞Ïù¥ÌÑ∞ Î∞òÌôò (Í∞úÎ∞ú Ïãú)
                return generateMockSubwayData(stationName);
            }
        }

        async function fetchKorailData(stationName, position) {
            try {
                // Ïã§Ï†ú ÏΩîÎ†àÏùº Ïó¨Í∞ùÏó¥Ï∞® Ïö¥ÌñâÏ†ïÎ≥¥ API Ìò∏Ï∂ú
                const stationCode = getKorailStationCode(stationName);
                if (!stationCode) {
                    return await generateMockKorailData(stationName, position);
                }

                const currentTime = new Date();
                const timeWindow = 30; // 30Î∂Ñ Ïù¥ÎÇ¥ Ïó¥Ï∞®Îßå Ï°∞Ìöå
                
                // Ïó¨Í∞ùÏó¥Ï∞® Ïö¥ÌñâÏ†ïÎ≥¥ Ï°∞Ìöå
                const url = `https://apis.data.go.kr/1613000/TrainInfoService/getSttnAcctoTrainSttnList?serviceKey=${API_KEYS.korail}&stationCd=${stationCode}&traincCd=01&_type=json&pageNo=1&numOfRows=20`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`ÏΩîÎ†àÏùº API ÏùëÎãµ Ïò§Î•ò: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.response?.header?.resultCode !== '00') {
                    throw new Error(data.response?.header?.resultMsg || 'ÏΩîÎ†àÏùº API Ïò§Î•ò');
                }
                
                const trains = data.response?.body?.items?.item || [];
                const upcomingTrains = [];
                
                trains.forEach(train => {
                    const departureTime = parseKorailTime(train.deptm);
                    const arrivalTime = parseKorailTime(train.arrplandtime);
                    const timeDiff = (departureTime - currentTime) / (1000 * 60); // Î∂Ñ Îã®ÏúÑ
                    
                    // 30Î∂Ñ Ïù¥ÎÇ¥Ïóê Ï∂úÎ∞úÌïòÍ±∞ÎÇò ÎèÑÏ∞©ÌïòÎäî Ïó¥Ï∞®Îßå Ìè¨Ìï®
                    if (timeDiff >= -5 && timeDiff <= timeWindow) {
                        upcomingTrains.push({
                            type: 'korail',
                            station: stationName,
                            line: getTrainTypeName(train.traincCd),
                            trainNo: train.trainno,
                            direction: train.upperdowndistinction === '1' ? 'ÏÉÅÌñâ' : 'ÌïòÌñâ',
                            destination: train.arrstncd !== stationCode ? getStationName(train.arrstncd) : getStationName(train.depstncd),
                            arrivalMessage: generateArrivalMessage(timeDiff, train),
                            arrivalCode: timeDiff <= 5 ? '0' : '1',
                            departureTime: train.deptm,
                            arrivalTime: train.arrplandtime,
                            delay: train.dlayhr || '0',
                            timestamp: new Date().toISOString()
                        });
                    }
                });
                
                return upcomingTrains;
                
            } catch (error) {
                console.error(`${stationName} ÏΩîÎ†àÏùº Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:`, error);
                return await generateEnhancedKorailData(stationName, position);
            }
        }

        function getKorailStationCode(stationName) {
            // Ï£ºÏöî ÏΩîÎ†àÏùº Ïó≠ ÏΩîÎìú Îß§Ìïë
            const stationCodes = {
                'ÏÑúÏö∏Ïó≠': 'NAT010000',
                'Ïö©ÏÇ∞Ïó≠': 'NAT010900', 
                'Ï≤≠ÎüâÎ¶¨Ïó≠': 'NAT014100',
                'ÏòÅÎì±Ìè¨Ïó≠': 'NAT010700',
                'ÏàòÏõêÏó≠': 'NAT031300',
                'ÎåÄÏ†ÑÏó≠': 'DAE050000',
                'ÎèôÎåÄÍµ¨Ïó≠': 'DGU050000',
                'Î∂ÄÏÇ∞Ïó≠': 'PUS050000',
                'Í¥ëÏ£ºÏÜ°Ï†ïÏó≠': 'GWJ050000',
                'Î™©Ìè¨Ïó≠': 'MOP050000',
                'Í∞ïÎ¶âÏó≠': 'GRG050000',
                'Ìè¨Ìï≠Ïó≠': 'PHG050000'
            };
            
            return stationCodes[stationName] || null;
        }

        function getTrainTypeName(trainCode) {
            const trainTypes = {
                '01': 'KTX',
                '02': 'ÏÉàÎßàÏùÑÌò∏',
                '03': 'Î¨¥Í∂ÅÌôîÌò∏',
                '04': 'ITX-ÏÉàÎßàÏùÑ',
                '05': 'ITX-Ï≤≠Ï∂ò',
                '06': 'KTX-ÏÇ∞Ï≤ú',
                '07': 'KTX-Ïù¥Ïùå'
            };
            
            return trainTypes[trainCode] || `Ïó¥Ï∞®(${trainCode})`;
        }

        function parseKorailTime(timeStr) {
            if (!timeStr || timeStr.length < 4) return new Date();
            
            const today = new Date();
            const hours = parseInt(timeStr.substring(0, 2));
            const minutes = parseInt(timeStr.substring(2, 4));
            
            const trainTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
            
            // ÏûêÏ†ïÏùÑ ÎÑòÍ∏¥ ÏãúÍ∞ÑÏùò Í≤ΩÏö∞ Îã§Ïùå ÎÇ†Î°ú Ï≤òÎ¶¨
            if (trainTime < today && hours < 6) {
                trainTime.setDate(trainTime.getDate() + 1);
            }
            
            return trainTime;
        }

        function getStationName(stationCode) {
            // Í∞ÑÎã®Ìïú Ïó≠ÏΩîÎìú -> Ïó≠Î™Ö Î≥ÄÌôò (Ïã§Ï†úÎ°úÎäî Îçî ÎßéÏùÄ Îß§Ìïë ÌïÑÏöî)
            const stations = {
                'NAT010000': 'ÏÑúÏö∏',
                'PUS050000': 'Î∂ÄÏÇ∞',
                'DAE050000': 'ÎåÄÏ†Ñ',
                'DGU050000': 'ÎèôÎåÄÍµ¨',
                'GWJ050000': 'Í¥ëÏ£ºÏÜ°Ï†ï',
                'MOP050000': 'Î™©Ìè¨'
            };
            
            return stations[stationCode] || 'ÎèÑÏ∞©ÏßÄ';
        }

        function generateArrivalMessage(timeDiff, train) {
            if (timeDiff <= -2) {
                return 'Ïù¥ÎØ∏ Ï∂úÎ∞ú';
            } else if (timeDiff <= 0) {
                return 'Ï∂úÎ∞ú Ï§ë';
            } else if (timeDiff <= 5) {
                return `${Math.round(timeDiff)}Î∂Ñ ÌõÑ Ï∂úÎ∞ú`;
            } else if (timeDiff <= 15) {
                return `${Math.round(timeDiff)}Î∂Ñ ÌõÑ Ï∂úÎ∞ú`;
            } else {
                const hours = Math.floor(timeDiff / 60);
                const minutes = Math.round(timeDiff % 60);
                if (hours > 0) {
                    return `${hours}ÏãúÍ∞Ñ ${minutes}Î∂Ñ ÌõÑ Ï∂úÎ∞ú`;
                } else {
                    return `${minutes}Î∂Ñ ÌõÑ Ï∂úÎ∞ú`;
                }
            }
        }

        function generateMockSubwayData(stationName) {
            // Í∞úÎ∞úÏö© ÏßÄÌïòÏ≤† Î™®Ïùò Îç∞Ïù¥ÌÑ∞
            if (Math.random() > 0.6) {
                return [{
                    type: 'subway',
                    station: stationName,
                    line: ['2Ìò∏ÏÑ†', '4Ìò∏ÏÑ†', '1Ìò∏ÏÑ†'][Math.floor(Math.random() * 3)],
                    direction: Math.random() > 0.5 ? 'ÎÇ¥ÏÑ†ÏàúÌôò' : 'Ïô∏ÏÑ†ÏàúÌôò',
                    destination: ['Í∞ïÎÇ®', 'Ïã†ÎèÑÎ¶º', 'ÏÇ¨Îãπ'][Math.floor(Math.random() * 3)],
                    arrivalMessage: ['2Î∂Ñ ÌõÑ ÎèÑÏ∞©', 'ÏßÑÏûÖÏ§ë', '5Î∂Ñ ÌõÑ ÎèÑÏ∞©'][Math.floor(Math.random() * 3)],
                    arrivalCode: Math.random() > 0.7 ? '0' : '1',
                    currentStation: 'Ï†ÑÏó≠ Ï∂úÎ∞ú',
                    timestamp: new Date().toISOString()
                }];
            }
            return [];
        }

        async function generateEnhancedKorailData(stationName, position) {
            // Ïã§Ï†ú ÏãúÍ∞ÑÌëú Í∏∞Î∞ò Ìñ•ÏÉÅÎêú Î™®Ïùò Îç∞Ïù¥ÌÑ∞
            const currentTime = new Date();
            const hour = currentTime.getHours();
            
            // ÏãúÍ∞ÑÎåÄÎ≥Ñ Ïó¥Ï∞® Ïö¥Ìñâ ÎπàÎèÑ Ï°∞Ï†ï
            let trainProbability = 0.3; // Í∏∞Î≥∏ 30%
            
            if (hour >= 6 && hour <= 9) trainProbability = 0.8; // Ï∂úÍ∑º ÏãúÍ∞Ñ
            else if (hour >= 17 && hour <= 20) trainProbability = 0.7; // Ìá¥Í∑º ÏãúÍ∞Ñ
            else if (hour >= 22 || hour <= 5) trainProbability = 0.1; // Ïã¨Ïïº ÏãúÍ∞Ñ
            
            if (Math.random() > trainProbability) {
                return [];
            }

            const trainTypes = [
                { name: 'KTX', destinations: ['Î∂ÄÏÇ∞', 'ÎåÄÍµ¨', 'Í¥ëÏ£ºÏÜ°Ï†ï', 'Î™©Ìè¨', 'Í∞ïÎ¶â'] },
                { name: 'ÏÉàÎßàÏùÑÌò∏', destinations: ['Î∂ÄÏÇ∞', 'ÎåÄÏ†Ñ', 'Í¥ëÏ£º', 'Î™©Ìè¨', 'Ìè¨Ìï≠'] },
                { name: 'Î¨¥Í∂ÅÌôîÌò∏', destinations: ['Î∂ÄÏÇ∞', 'ÎåÄÏ†Ñ', 'ÎåÄÍµ¨', 'Í¥ëÏ£º', 'Î™©Ìè¨', 'Ï∂òÏ≤ú', 'Í∞ïÎ¶â'] },
                { name: 'ITX-ÏÉàÎßàÏùÑ', destinations: ['Î∂ÄÏÇ∞', 'ÎåÄÏ†Ñ', 'ÎßàÏÇ∞'] }
            ];
            
            const trains = [];
            const numTrains = Math.floor(Math.random() * 3) + 1; // 1-3ÎåÄ
            
            for (let i = 0; i < numTrains; i++) {
                const trainType = trainTypes[Math.floor(Math.random() * trainTypes.length)];
                const destination = trainType.destinations[Math.floor(Math.random() * trainType.destinations.length)];
                const minutesUntilDeparture = Math.floor(Math.random() * 45) + 5; // 5-50Î∂Ñ ÌõÑ
                
                trains.push({
                    type: 'korail',
                    station: stationName,
                    line: trainType.name,
                    trainNo: generateRealisticTrainNumber(trainType.name),
                    direction: Math.random() > 0.5 ? 'ÏÉÅÌñâ' : 'ÌïòÌñâ',
                    destination: destination,
                    arrivalMessage: generateRealisticArrivalMessage(minutesUntilDeparture),
                    arrivalCode: minutesUntilDeparture <= 10 ? '0' : '1',
                    departureTime: addMinutesToTime(currentTime, minutesUntilDeparture),
                    delay: Math.random() > 0.8 ? Math.floor(Math.random() * 15) + 'Î∂Ñ ÏßÄÏó∞' : 'Ï†ïÏÉÅ',
                    timestamp: new Date().toISOString()
                });
            }
            
            return trains;
        }

        function generateRealisticTrainNumber(trainType) {
            const prefixes = {
                'KTX': ['100', '120', '140', '160'],
                'ÏÉàÎßàÏùÑÌò∏': ['1', '3', '5', '7'],
                'Î¨¥Í∂ÅÌôîÌò∏': ['80', '90', '120', '140'],
                'ITX-ÏÉàÎßàÏùÑ': ['20', '22', '24']
            };
            
            const prefix = prefixes[trainType] || ['100'];
            const selectedPrefix = prefix[Math.floor(Math.random() * prefix.length)];
            const suffix = Math.floor(Math.random() * 99).toString().padStart(2, '0');
            
            return selectedPrefix + suffix;
        }

        function generateRealisticArrivalMessage(minutes) {
            if (minutes <= 2) {
                return 'Í≥ß Ï∂úÎ∞ú';
            } else if (minutes <= 5) {
                return `${minutes}Î∂Ñ ÌõÑ Ï∂úÎ∞ú`;
            } else if (minutes <= 15) {
                return `${minutes}Î∂Ñ ÌõÑ Ï∂úÎ∞ú`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                if (hours > 0) {
                    return `${hours}ÏãúÍ∞Ñ ${remainingMinutes}Î∂Ñ ÌõÑ Ï∂úÎ∞ú`;
                } else {
                    return `${minutes}Î∂Ñ ÌõÑ Ï∂úÎ∞ú`;
                }
            }
        }

        function addMinutesToTime(baseTime, minutes) {
            const newTime = new Date(baseTime);
            newTime.setMinutes(newTime.getMinutes() + minutes);
            return newTime.toTimeString().substring(0, 5); // HH:MM ÌòïÏãù
        }

        function displayTrainInfo(trainData) {
            const trainList = document.getElementById('train-list');
            const trainItems = document.getElementById('train-items');
            
            if (trainData.length === 0) {
                trainList.style.display = 'none';
                return;
            }
            
            trainItems.innerHTML = '';
            
            // Ï∂úÎ∞ú ÏãúÍ∞ÑÏàúÏúºÎ°ú Ï†ïÎ†¨
            trainData.sort((a, b) => {
                if (a.arrivalCode === '0' && b.arrivalCode !== '0') return -1;
                if (b.arrivalCode === '0' && a.arrivalCode !== '0') return 1;
                return 0;
            });
            
            trainData.forEach(train => {
                const trainDiv = document.createElement('div');
                trainDiv.className = `train-item ${train.type}`;
                
                let statusColor = '#4caf50';
                let typeIcon = train.type === 'subway' ? 'üöá' : 'üöÑ';
                let urgencyClass = '';
                
                if (train.arrivalCode === '0' || train.arrivalMessage?.includes('ÏßÑÏûÖ') || train.arrivalMessage?.includes('Í≥ß') || train.arrivalMessage?.includes('Ï∂úÎ∞ú Ï§ë')) {
                    statusColor = '#f44336';
                    urgencyClass = ' urgent';
                } else if (train.arrivalMessage?.includes('1Î∂Ñ') || train.arrivalMessage?.includes('2Î∂Ñ') || train.arrivalMessage?.includes('3Î∂Ñ') || train.arrivalMessage?.includes('5Î∂Ñ')) {
                    statusColor = '#ff9800';
                    urgencyClass = ' warning';
                }
                
                trainDiv.style.borderLeftColor = statusColor;
                trainDiv.className += urgencyClass;
                
                let additionalInfo = '';
                if (train.type === 'korail') {
                    additionalInfo = `
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                            üöÑ Ïó¥Ï∞®Î≤àÌò∏: ${train.trainNo}
                            ${train.delay && train.delay !== 'Ï†ïÏÉÅ' ? `<br>‚è∞ ${train.delay}` : ''}
                            ${train.departureTime ? `<br>üïê Ï∂úÎ∞úÏãúÍ∞Ñ: ${train.departureTime}` : ''}
                        </div>
                    `;
                }
                
                trainDiv.innerHTML = `
                    <div class="train-line">${typeIcon} ${train.line} - ${train.station}</div>
                    <div class="train-info">
                        ${train.direction} | ${train.destination} Î∞©Î©¥<br>
                        <span style="color:${statusColor};font-weight:bold;">${train.arrivalMessage}</span>
                        ${additionalInfo}
                    </div>
                `;
                trainItems.appendChild(trainDiv);
            });
            
            trainList.style.display = 'block';
        }

        function showWarning(trains) {
            const isGPSMode = document.getElementById('gps-mode').classList.contains('active');
            const warningElement = isGPSMode ? 
                document.getElementById('gps-warning') : 
                document.getElementById('manual-warning');
            const detailsElement = isGPSMode ? 
                document.getElementById('warning-details') : 
                document.getElementById('manual-warning-details');
            
            const urgentTrain = trains.find(train => 
                train.arrivalCode === '0' || train.arrivalMessage?.includes('ÏßÑÏûÖ')
            ) || trains[0];
            
            const typeIcon = urgentTrain.type === 'subway' ? 'üöá' : 'üöÑ';
            detailsElement.textContent = 
                `${typeIcon} ${urgentTrain.line} ${urgentTrain.station} - ${urgentTrain.arrivalMessage}`;
            
            warningElement.classList.add('show');
            
            // ÏÉÅÌÉú ÌëúÏãúÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            const indicator = isGPSMode ? 
                document.getElementById('gps-status-indicator') : 
                document.getElementById('manual-status-indicator');
            
            indicator.className = 'status-indicator status-danger';
            indicator.textContent = '‚ö†Ô∏è';
        }

        function hideWarning() {
            document.getElementById('gps-warning').classList.remove('show');
            document.getElementById('manual-warning').classList.remove('show');
            
            // ÏÉÅÌÉú ÌëúÏãúÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            const indicators = [
                document.getElementById('gps-status-indicator'),
                document.getElementById('manual-status-indicator')
            ];
            
            indicators.forEach(indicator => {
                indicator.className = 'status-indicator status-safe';
                indicator.textContent = 'üìç';
            });
        }

        function triggerAlarm() {
            // ÏßÑÎèô (Î™®Î∞îÏùºÏóêÏÑúÎßå ÏûëÎèô)
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            // ÏïåÎûåÏùå Ïû¨ÏÉù
            if (alarmSound) {
                alarmSound.play().catch(e => console.log('ÏïåÎûåÏùå Ïû¨ÏÉù Ïã§Ìå®:', e));
            }
        }

        function stopAlarm() {
            if (alarmSound) {
                alarmSound.pause();
                alarmSound.currentTime = 0;
            }
        }

        function updateMonitoringInfo(stationCount, interval = null) {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            document.getElementById('nearby-stations-count').textContent = stationCount;
            
            if (interval) {
                const intervalText = interval >= 60000 ? 
                    `${interval/60000}Î∂Ñ` : 
                    `${interval/1000}Ï¥à`;
                document.getElementById('current-interval').textContent = intervalText;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Îëê ÏßÄÏ†ê Í∞ÑÏùò Í±∞Î¶¨ Í≥ÑÏÇ∞ (ÎØ∏ÌÑ∞ Îã®ÏúÑ)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // PWA ÏßÄÏõêÏùÑ ÏúÑÌïú ÏÑúÎπÑÏä§ ÏõåÏª§ Îì±Î°ù
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // ÌïÑÏöîÏãú ÏÑúÎπÑÏä§ ÏõåÏª§ Íµ¨ÌòÑ
            });
        }
    </script>
</body>
</html>