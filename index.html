<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ì°¨ ì•ˆì „ ê²½ê³  ì‹œìŠ¤í…œ</title>
    
    <meta name="description" content="GPS ê¸°ë°˜ ê¸°ì°¨ ì•ˆì „ ê²½ê³  ì‹œìŠ¤í…œ - HTTPS í™˜ê²½ í•„ìš”">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            padding-bottom: 20px;
            color: #4CAF50;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        p.subtitle {
            font-size: 0.9em;
            color: #777;
        }
        
        #map {
            height: 250px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }

        .status-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-box {
            padding: 15px;
            border-radius: 8px;
            background: #f7f7f7;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .status-box h2 {
            font-size: 1.2em;
            margin-bottom: 5px;
            color: #555;
        }

        .status-text {
            font-size: 1.8em;
            font-weight: bold;
            color: #4CAF50;
        }

        .warning-status {
            color: #F44336;
        }

        .info-box {
            background: #e9e9e9;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
            margin-top: 20px;
        }

        #manual-location-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: #eef;
            border-radius: 8px;
            margin-top: 20px;
        }

        #manual-location-form h3 {
            font-size: 1.1em;
            color: #444;
            margin-bottom: 5px;
        }

        #manual-location-form input[type="text"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #manual-location-form button {
            padding: 10px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #error-display {
            background-color: #fdd;
            color: #d33;
            border: 1px solid #f99;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            display: none;
            margin-top: 10px;
        }
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-200YyS0I3u0Lp4R0K00cK0S7y6g0/cT0b6G6y2B0v8s="
            crossorigin=""></script>
</head>
<body>

    <div class="container">
        <header>
            <h1>ğŸš‚ ê¸°ì°¨ ì•ˆì „ ê²½ê³  ì‹œìŠ¤í…œ</h1>
            <p class="subtitle">ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—´ì°¨ ìš´í–‰ ê²½ê³ ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</p>
        </header>

        <div id="map"></div>

        <div class="status-section">
            <div class="status-box">
                <h2>í˜„ì¬ ìœ„ì¹˜</h2>
                <p id="location-status" class="status-text">... ìœ„ì¹˜ë¥¼ ì°¾ëŠ” ì¤‘</p>
            </div>
            <div class="status-box">
                <h2>ê°€ì¥ ê°€ê¹Œìš´ ì—­</h2>
                <p id="nearest-station-status" class="status-text">...</p>
            </div>
            <div class="status-box">
                <h2>ì—´ì°¨ ìš´í–‰ ê²½ê³ </h2>
                <p id="warning-status" class="status-text">...</p>
            </div>
        </div>

        <div id="manual-location-form">
            <h3>ìˆ˜ë™ìœ¼ë¡œ ì—­ ìœ„ì¹˜ ì§€ì •í•˜ê¸°</h3>
            <p style="font-size:0.8em; color:#666;">ì •í™•í•œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì–»ê¸° ìœ„í•´ ì—­ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ìš©ì‚°)</p>
            <input type="text" id="manual-station-input" placeholder="ì—­ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button onclick="setManualLocation()">ì—­ ì§€ì •</button>
            <div style="font-size:0.9em; margin-top:10px;">
                <p>ìˆ˜ë™ ì§€ì • ì—­: <span id="manual-station-name">ì—†ìŒ</span></p>
                <p>ìˆ˜ë™ ì§€ì • ê²½ê³  ìƒíƒœ: <span id="manual-warning-status">...</span></p>
            </div>
        </div>
        
        <div id="error-display"></div>

    </div>

    <script>
        // í˜„ì¬ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—­ ì •ë³´ë¥¼ ì°¾ëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œì…ë‹ˆë‹¤.
        const TRAIN_STATIONS = [
            { name: 'ì„œìš¸ì—­', line: '1í˜¸ì„ ', lat: 37.5558, lng: 126.9723 },
            { name: 'ìš©ì‚°ì—­', line: '1í˜¸ì„ ', lat: 37.5298, lng: 126.9646 },
            { name: 'ì¢…ê°ì—­', line: '1í˜¸ì„ ', lat: 37.5701, lng: 126.9831 },
            { name: 'ì‹œì²­ì—­', line: '2í˜¸ì„ ', lat: 37.5657, lng: 126.9771 },
            { name: 'ì„ì§€ë¡œì…êµ¬ì—­', line: '2í˜¸ì„ ', lat: 37.5663, lng: 126.9826 },
            { name: 'ì„ì§€ë¡œ3ê°€ì—­', line: '2í˜¸ì„ ', lat: 37.5668, lng: 126.9912 },
            { name: 'ì„ì§€ë¡œ4ê°€ì—­', line: '2í˜¸ì„ ', lat: 37.5665, lng: 126.9972 },
            { name: 'ë™ëŒ€ë¬¸ì—­ì‚¬ë¬¸í™”ê³µì›ì—­', line: '2í˜¸ì„ ', lat: 37.5654, lng: 127.0089 },
            { name: 'ì‹ ë‹¹ì—­', line: '2í˜¸ì„ ', lat: 37.5659, lng: 127.0177 },
            { name: 'ì™•ì‹­ë¦¬ì—­', line: '2í˜¸ì„ ', lat: 37.5612, lng: 127.0366 },
            { name: 'ì„±ìˆ˜ì—­', line: '2í˜¸ì„ ', lat: 37.5445, lng: 127.0560 },
            { name: 'ì ì‹¤ì—­', line: '2í˜¸ì„ ', lat: 37.5135, lng: 127.1002 },
            { name: 'ê°•ë‚¨ì—­', line: '2í˜¸ì„ ', lat: 37.4981, lng: 127.0276 },
            { name: 'ì‚¬ë‹¹ì—­', line: '2í˜¸ì„ ', lat: 37.4766, lng: 126.9818 },
            { name: 'ì‹ ë¦¼ì—­', line: '2í˜¸ì„ ', lat: 37.4842, lng: 126.9298 },
            { name: 'ëŒ€ë¦¼ì—­', line: '2í˜¸ì„ ', lat: 37.4913, lng: 126.8973 },
            { name: 'êµ¬ë¡œë””ì§€í„¸ë‹¨ì§€ì—­', line: '2í˜¸ì„ ', lat: 37.4852, lng: 126.9015 },
            { name: 'í•©ì •ì—­', line: '2í˜¸ì„ ', lat: 37.5504, lng: 126.9150 },
            { name: 'í™ëŒ€ì…êµ¬ì—­', line: '2í˜¸ì„ ', lat: 37.5574, lng: 126.9238 },
            { name: 'ì´ëŒ€ì—­', line: '2í˜¸ì„ ', lat: 37.5583, lng: 126.9463 },
            { name: 'ì‹ ì´Œì—­', line: '2í˜¸ì„ ', lat: 37.5599, lng: 126.9405 },
            { name: 'ì„œìš¸ëŒ€ì…êµ¬ì—­', line: '2í˜¸ì„ ', lat: 37.4811, lng: 126.9529 },
            { name: 'ì¢…ë¡œ3ê°€ì—­', line: '3í˜¸ì„ ', lat: 37.5704, lng: 126.9922 },
            { name: 'ë™ëŒ€ì…êµ¬ì—­', line: '3í˜¸ì„ ', lat: 37.5597, lng: 127.0049 },
            { name: 'êµëŒ€ì—­', line: '3í˜¸ì„ ', lat: 37.4917, lng: 127.0134 },
            { name: 'ê³ ì†í„°ë¯¸ë„ì—­', line: '3í˜¸ì„ ', lat: 37.5049, lng: 127.0048 },
            { name: 'ê²½ë³µê¶ì—­', line: '3í˜¸ì„ ', lat: 37.5759, lng: 126.9734 },
            { name: 'ì¶©ë¬´ë¡œì—­', line: '3í˜¸ì„ ', lat: 37.5612, lng: 126.9936 },
            { name: 'ëª…ë™ì—­', line: '4í˜¸ì„ ', lat: 37.5609, lng: 126.9863 },
            { name: 'í˜œí™”ì—­', line: '4í˜¸ì„ ', lat: 37.5822, lng: 127.0019 },
            { name: 'ë™ëŒ€ë¬¸ì—­', line: '4í˜¸ì„ ', lat: 37.5714, lng: 127.0097 },
            { name: 'ì‚¬ë‹¹ì—­', line: '4í˜¸ì„ ', lat: 37.4766, lng: 126.9818 },
            { name: 'ì´ì‹ ëŒ€ì…êµ¬ì—­(ì´ìˆ˜ì—­)', line: '4í˜¸ì„ ', lat: 37.4862, lng: 126.9829 },
            { name: 'ì‹ ê¸¸ì—­', line: '5í˜¸ì„ ', lat: 37.5178, lng: 126.9150 },
            { name: 'ì—¬ì˜ë„ì—­', line: '5í˜¸ì„ ', lat: 37.5218, lng: 126.9254 },
            { name: 'ì˜ë“±í¬êµ¬ì²­ì—­', line: '5í˜¸ì„ ', lat: 37.5230, lng: 126.9032 },
            { name: 'ê¹Œì¹˜ì‚°ì—­', line: '5í˜¸ì„ ', lat: 37.5317, lng: 126.8468 },
            { name: 'ê¹€í¬ê³µí•­ì—­', line: '5í˜¸ì„ ', lat: 37.5621, lng: 126.8010 },
            { name: 'êµ°ìì—­', line: '5í˜¸ì„ ', lat: 37.5574, lng: 127.0782 },
            { name: 'ê´‘í™”ë¬¸ì—­', line: '5í˜¸ì„ ', lat: 37.5701, lng: 126.9774 },
            { name: 'ë³´ë¼ë§¤ì—­', line: '7í˜¸ì„ ', lat: 37.5000, lng: 126.9200 },
            { name: 'ê°€ì‚°ë””ì§€í„¸ë‹¨ì§€ì—­', line: '7í˜¸ì„ ', lat: 37.4820, lng: 126.8824 },
            { name: 'ê³ ì†í„°ë¯¸ë„ì—­', line: '7í˜¸ì„ ', lat: 37.5049, lng: 127.0048 },
            { name: 'ì–´ë¦°ì´ëŒ€ê³µì›ì—­', line: '7í˜¸ì„ ', lat: 37.5476, lng: 127.0743 },
            { name: 'ì²­ë‹´ì—­', line: '7í˜¸ì„ ', lat: 37.5197, lng: 127.0543 },
            { name: 'ê³µë•ì—­', line: '6í˜¸ì„ ', lat: 37.5448, lng: 126.9565 },
            { name: 'ì´íƒœì›ì—­', line: '6í˜¸ì„ ', lat: 37.5342, lng: 126.9942 },
            { name: 'ë…¹ì‚¬í‰ì—­', line: '6í˜¸ì„ ', lat: 37.5349, lng: 126.9880 },
            { name: 'ë””ì§€í„¸ë¯¸ë””ì–´ì‹œí‹°ì—­', line: '6í˜¸ì„ ', lat: 37.5770, lng: 126.8906 }
        ];

        // ì´ˆê¸°í™”
        let map;
        let userMarker;
        let lastWarningTrain = null;
        let lastLocationUpdateTime = 0;
        let currentStatus = 'safe'; // 'safe', 'warning'

        // ìœ„ì¹˜ ì¶”ì  ì‹œì‘
        function startTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updatePosition, showError, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            } else {
                showError("ìœ„ì¹˜ ì •ë³´ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
            }
        }

        // Leaflet ì§€ë„ ì´ˆê¸°í™”
        function initMap(lat, lng) {
            if (map) {
                map.remove();
            }
            map = L.map('map').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            userMarker = L.marker([lat, lng]).addTo(map)
                .bindPopup("í˜„ì¬ ë‚˜ì˜ ìœ„ì¹˜").openPopup();
        }

        // í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updatePosition(position) {
            const currentTime = new Date().getTime();
            if (currentTime - lastLocationUpdateTime < 3000) {
                // 3ì´ˆ ì´ë‚´ì— ì—…ë°ì´íŠ¸ëœ ê²½ìš° ë¬´ì‹œ
                return;
            }
            lastLocationUpdateTime = currentTime;

            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            document.getElementById('location-status').textContent = `âœ… ìœ„ì¹˜ íŒŒì•… ì™„ë£Œ`;

            if (!map) {
                initMap(lat, lng);
            } else {
                userMarker.setLatLng([lat, lng]);
                map.setView([lat, lng]);
            }

            const nearestStation = findNearestStation(lat, lng);
            document.getElementById('nearest-station-status').textContent = `${nearestStation.line} - ${nearestStation.name}`;

            fetchTrainData(nearestStation);
        }

        // APIë¥¼ í†µí•´ ì—´ì°¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì„œìš¸ì‹œ ì§€í•˜ì²  + ì½”ë ˆì¼)
        async function fetchTrainData(station) {
            const seoulApiKey = '4a4d5943506f73633531764f4d6854';
            const korailApiKey = 'b94e2e220ed1c348f7fe613a70da4ac557a1888a5d25f0e6e3d0e91e41ce4618';

            const allTrains = [];
            const isSeoulSubway = !['ì„œìš¸ì—­', 'ìš©ì‚°ì—­'].includes(station.name); // ì˜ˆì‹œë¡œ ì„œìš¸ì—­, ìš©ì‚°ì—­ë§Œ ì½”ë ˆì¼ë¡œ ê°„ì£¼

            // 1. ì„œìš¸ì‹œ ì§€í•˜ì²  API í˜¸ì¶œ
            if (isSeoulSubway) {
                const seoulUrl = `http://swopenapi.seoul.go.kr/api/subway/${seoulApiKey}/json/realtimeStationArrival/0/5/${encodeURIComponent(station.name)}`;
                try {
                    const response = await fetch(seoulUrl);
                    const data = await response.json();
                    if (data.realtimeStationArrival) {
                        allTrains.push(...data.realtimeStationArrival);
                    }
                } catch (error) {
                    console.error('ì„œìš¸ì‹œ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                }
            }

            // 2. ì½”ë ˆì¼ API í˜¸ì¶œ
            if (!isSeoulSubway) {
                const korailUrl = `https://openapis.korail.com/samples/public/run/travelerTrainRunInfo?serviceKey=${korailApiKey}&stn_cd=${encodeURIComponent(station.name)}`;
                try {
                    const response = await fetch(korailUrl);
                    const data = await response.json();
                    // ì½”ë ˆì¼ API ì‘ë‹µ í˜•íƒœì— ë”°ë¼ ë°ì´í„° íŒŒì‹± ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    if (data.response && data.response.body && data.response.body.items) {
                        allTrains.push(...data.response.body.items.item);
                    }
                } catch (error) {
                    console.error('ì½”ë ˆì¼ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                }
            }
            
            checkWarnings(station, allTrains);
        }

        // ê²½ê³  í™•ì¸ ë¡œì§
        function checkWarnings(nearestStation, trains) {
            const warningDistance = 500; // ê²½ê³ ë¥¼ ë°œìƒì‹œí‚¬ ê±°ë¦¬ (ë¯¸í„°)
            let isWarning = false;
            let warningTrain = null;
            
            if (trains && Array.isArray(trains)) {
                for (const train of trains) {
                    const trainStatus = train.arvlMsg2 || train.ì •ì°¨êµ¬ë¶„ëª…;
                    
                    if (trainStatus && (trainStatus.includes('ì§„ì…') || trainStatus.includes('ë„ì°©') || trainStatus.includes('ì¶œë°œ'))) {
                        isWarning = true;
                        warningTrain = train;
                        break;
                    }
                }
            }

            if (isWarning && lastWarningTrain !== (warningTrain.trainNo || warningTrain.ì—´ì°¨ë²ˆí˜¸)) {
                const trainMsg = warningTrain.arvlMsg2 || `${warningTrain.ì—´ì°¨ë²ˆí˜¸}ì—´ì°¨ê°€ ${warningTrain.ì •ì°¨êµ¬ë¶„ëª…} ì¤‘`;
                document.getElementById('warning-status').textContent = `ğŸš¨ ê²½ê³ : ${trainMsg}`;
                document.getElementById('warning-status').className = 'status-text warning-status';
                lastWarningTrain = warningTrain.trainNo || warningTrain.ì—´ì°¨ë²ˆí˜¸;
                currentStatus = 'warning';
            } else if (!isWarning && currentStatus !== 'safe') {
                document.getElementById('warning-status').textContent = 'âœ… ì•ˆì „';
                document.getElementById('warning-status').className = 'status-text';
                lastWarningTrain = null;
                currentStatus = 'safe';
            }
            
            updateManualWarningStatus();
        }

        // ê°€ì¥ ê°€ê¹Œìš´ ì—­ ì°¾ê¸°
        function findNearestStation(lat, lng) {
            let nearest = null;
            let minDistance = Infinity;

            for (const station of TRAIN_STATIONS) {
                const distance = calculateDistance(lat, lng, station.lat, station.lng);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = station;
                }
            }
            return nearest;
        }

        // ìˆ˜ë™ìœ¼ë¡œ ì—­ ìœ„ì¹˜ ì§€ì •
        function setManualLocation() {
            const stationName = document.getElementById('manual-station-input').value.trim();
            if (!stationName) {
                showError('ì—­ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }

            const station = TRAIN_STATIONS.find(s => s.name === stationName);
            if (station) {
                document.getElementById('manual-station-name').textContent = station.name;
                if (!map) {
                    initMap(station.lat, station.lng);
                } else {
                    userMarker.setLatLng([station.lat, station.lng]);
                    map.setView([station.lat, station.lng]);
                }
                
                fetchTrainData(station);
            } else {
                showError(`${stationName}ì€(ëŠ”) ëª©ë¡ì— ì—†ëŠ” ì—­ì…ë‹ˆë‹¤.`);
            }
        }
        
        // ìˆ˜ë™ ì§€ì • ì—­ì˜ ê²½ê³  ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateManualWarningStatus() {
            const manualStationName = document.getElementById('manual-station-name').textContent;
            const manualWarningStatusElement = document.getElementById('manual-warning-status');
            
            if (manualStationName === 'ì—†ìŒ') {
                manualWarningStatusElement.textContent = '...';
                manualWarningStatusElement.style.color = '#333';
                manualWarningStatusElement.style.fontWeight = 'normal';
                return;
            }
            
            if (currentStatus === 'warning') {
                const warningStatusText = document.getElementById('warning-status').textContent;
                manualWarningStatusElement.textContent = warningStatusText;
                manualWarningStatusElement.style.color = '#F44336';
                manualWarningStatusElement.style.fontWeight = 'bold';
            } else {
                manualWarningStatusElement.textContent = 'âœ… ì•ˆì „';
                manualWarningStatusElement.style.color = '#4caf50';
                manualWarningStatusElement.style.fontWeight = 'normal';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // ë‘ ì§€ì  ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Earth's radius in meters
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘
        window.onload = startTracking;
    </script>
</body>
</html>
