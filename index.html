<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기차 안전 경고 시스템</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .setting-group {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }
        
        .setting-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .setting-group input, .setting-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .map-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        #map {
            height: 400px;
            width: 100%;
        }
        
        .status {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: bold;
            color: #666;
        }
        
        .status-value {
            font-size: 14px;
            color: #333;
        }
        
        .alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #ff4757 0%, #ff3838 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(255,71,87,0.3);
            z-index: 9999;
            text-align: center;
            animation: alertPulse 1s infinite;
            display: none;
        }
        
        .alert h2 {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .alert p {
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .alert .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
        }
        
        @keyframes alertPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        .train-info {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #4facfe;
        }
        
        .train-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .train-item:last-child {
            border-bottom: none;
        }
        
        .distance-warning {
            color: #ff4757;
            font-weight: bold;
        }
        
        .distance-safe {
            color: #2ed573;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .settings {
                grid-template-columns: 1fr;
            }
            
            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚊 기차 안전 경고 시스템</h1>
            <p>GPS 추적 또는 수동 위치 설정으로 기차 근접 시 안전 경고를 받으세요</p>
        </div>
        
        <div class="controls">
            <div class="button-group">
                <button id="startGpsBtn" class="btn btn-primary">📍 GPS 추적 시작</button>
                <button id="stopGpsBtn" class="btn btn-secondary" disabled>⏹️ GPS 추적 중지</button>
                <button id="manualModeBtn" class="btn btn-secondary">📍 수동 위치 설정</button>
                <button id="clearMarkersBtn" class="btn btn-danger">🗑️ 마커 지우기</button>
            </div>
            
            <div class="settings">
                <div class="setting-group">
                    <label for="alertDistance">경고 거리 (미터)</label>
                    <input type="number" id="alertDistance" value="500" min="100" max="2000" step="100">
                </div>
                <div class="setting-group">
                    <label for="updateInterval">업데이트 간격 (초)</label>
                    <input type="number" id="updateInterval" value="30" min="10" max="300" step="10">
                </div>
                <div class="setting-group">
                    <label for="alertSound">경고음</label>
                    <select id="alertSound">
                        <option value="beep">비프음</option>
                        <option value="siren">사이렌</option>
                        <option value="bell">벨소리</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="vibration">진동 사용</label>
                    <select id="vibration">
                        <option value="true">사용함</option>
                        <option value="false">사용 안함</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <div class="status">
            <h3>📊 시스템 상태</h3>
            <div class="status-item">
                <span class="status-label">현재 모드:</span>
                <span id="currentMode" class="status-value">대기 중</span>
            </div>
            <div class="status-item">
                <span class="status-label">GPS 상태:</span>
                <span id="gpsStatus" class="status-value">비활성</span>
            </div>
            <div class="status-item">
                <span class="status-label">현재 위치:</span>
                <span id="currentPosition" class="status-value">위치 정보 없음</span>
            </div>
            <div class="status-item">
                <span class="status-label">마지막 업데이트:</span>
                <span id="lastUpdate" class="status-value">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">근처 기차 수:</span>
                <span id="nearbyTrains" class="status-value">0</span>
            </div>
        </div>
        
        <div class="train-info" id="trainInfo" style="display: none;">
            <h4>🚊 근처 기차 정보</h4>
            <div id="trainList"></div>
        </div>
    </div>
    
    <div id="alertModal" class="alert">
        <h2>⚠️ 기차 접근 경고!</h2>
        <p id="alertMessage">근처에 기차가 접근하고 있습니다!</p>
        <button class="btn" onclick="hideAlert()">확인</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 전역 변수
        let map;
        let currentLocationMarker;
        let manualMarker;
        let gpsWatchId;
        let isGpsActive = false;
        let isManualMode = false;
        let trainMarkers = [];
        let alertAudio;
        let monitoringInterval;
        
        // API 키
        const SEOUL_SUBWAY_API_KEY = '4a4d5943506f73633531764f4d6854';
        const KORAIL_API_KEY = 'b94e2e220ed1c348f7fe613a70da4ac557a1888a5d25f0e6e3d0e91e41ce4618';
        
        // 서울 지하철 역 데이터 (주요 역만 샘플)
        const seoulSubwayStations = [
            {name: '강남역', line: '2호선', lat: 37.4979, lng: 127.0276},
            {name: '홍대입구역', line: '2호선', lat: 37.5579, lng: 126.9245},
            {name: '서울역', line: '1호선', lat: 37.5547, lng: 126.9707},
            {name: '종로3가역', line: '1호선', lat: 37.5705, lng: 126.9923},
            {name: '명동역', line: '4호선', lat: 37.5632, lng: 126.9854},
            {name: '잠실역', line: '2호선', lat: 37.5133, lng: 127.1000},
            {name: '신림역', line: '2호선', lat: 37.4843, lng: 126.9297},
            {name: '사당역', line: '2호선', lat: 37.4767, lng: 126.9815}
        ];
        
        // 코레일 주요역 데이터 (샘플)
        const korailStations = [
            {name: '서울역', lat: 37.5547, lng: 126.9707},
            {name: '용산역', lat: 37.5299, lng: 126.9645},
            {name: '영등포역', lat: 37.5156, lng: 126.9073},
            {name: '수원역', lat: 37.2656, lng: 127.0011},
            {name: '대전역', lat: 36.3315, lng: 127.4344}
        ];
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initEventListeners();
            initAudio();
        });
        
        // 지도 초기화
        function initMap() {
            // 서울 중심으로 지도 생성
            map = L.map('map').setView([37.5665, 126.9780], 12);
            
            // OpenStreetMap 타일 레이어 추가
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // 지하철역 마커 추가
            seoulSubwayStations.forEach(station => {
                L.marker([station.lat, station.lng])
                    .addTo(map)
                    .bindPopup(`🚇 ${station.name} (${station.line})`);
            });
            
            // 코레일역 마커 추가
            korailStations.forEach(station => {
                L.marker([station.lat, station.lng])
                    .addTo(map)
                    .bindPopup(`🚄 ${station.name}`);
            });
            
            // 지도 클릭 이벤트 (수동 모드에서 사용)
            map.on('click', function(e) {
                if (isManualMode) {
                    setManualLocation(e.latlng.lat, e.latlng.lng);
                }
            });
        }
        
        // 이벤트 리스너 초기화
        function initEventListeners() {
            document.getElementById('startGpsBtn').addEventListener('click', startGpsTracking);
            document.getElementById('stopGpsBtn').addEventListener('click', stopGpsTracking);
            document.getElementById('manualModeBtn').addEventListener('click', toggleManualMode);
            document.getElementById('clearMarkersBtn').addEventListener('click', clearMarkers);
        }
        
        // 오디오 초기화
        function initAudio() {
            alertAudio = new Audio();
        }
        
        // GPS 추적 시작
        function startGpsTracking() {
            if (!navigator.geolocation) {
                alert('이 브라우저는 GPS를 지원하지 않습니다.');
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };
            
            gpsWatchId = navigator.geolocation.watchPosition(
                onLocationUpdate,
                onLocationError,
                options
            );
            
            isGpsActive = true;
            isManualMode = false;
            updateUI();
            startMonitoring();
        }
        
        // GPS 추적 중지
        function stopGpsTracking() {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            
            isGpsActive = false;
            updateUI();
            stopMonitoring();
        }
        
        // 수동 모드 토글
        function toggleManualMode() {
            isManualMode = !isManualMode;
            
            if (isManualMode) {
                stopGpsTracking();
                alert('지도를 클릭하여 위치를 설정하세요.');
            } else {
                if (manualMarker) {
                    map.removeLayer(manualMarker);
                    manualMarker = null;
                }
                stopMonitoring();
            }
            
            updateUI();
        }
        
        // 수동 위치 설정
        function setManualLocation(lat, lng) {
            if (manualMarker) {
                map.removeLayer(manualMarker);
            }
            
            manualMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12.5" cy="12.5" r="10" fill="#ff4757" stroke="#fff" stroke-width="2"/>
                            <text x="12.5" y="17" text-anchor="middle" fill="white" font-size="12">📍</text>
                        </svg>
                    `),
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                })
            }).addTo(map);
            
            manualMarker.bindPopup('🏃 현재 설정된 위치').openPopup();
            
            // 위치 정보 업데이트
            updateCurrentPosition(lat, lng);
            startMonitoring();
        }
        
        // 위치 업데이트 콜백
        function onLocationUpdate(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            updateCurrentPosition(lat, lng);
            
            // 현재 위치 마커 업데이트
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            
            currentLocationMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="25" height="25" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12.5" cy="12.5" r="10" fill="#4facfe" stroke="#fff" stroke-width="2"/>
                            <text x="12.5" y="17" text-anchor="middle" fill="white" font-size="12">📍</text>
                        </svg>
                    `),
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                })
            }).addTo(map);
            
            currentLocationMarker.bindPopup('🏃 현재 위치').openPopup();
            
            // 지도 중심을 현재 위치로 이동
            map.setView([lat, lng], 14);
        }
        
        // 위치 에러 콜백
        function onLocationError(error) {
            let message = '위치 정보를 가져올 수 없습니다: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += '위치 접근 권한이 거부되었습니다.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += '위치 정보를 사용할 수 없습니다.';
                    break;
                case error.TIMEOUT:
                    message += '위치 요청이 시간 초과되었습니다.';
                    break;
                default:
                    message += '알 수 없는 오류가 발생했습니다.';
                    break;
            }
            
            alert(message);
            document.getElementById('gpsStatus').textContent = '오류';
        }
        
        // 현재 위치 정보 업데이트
        function updateCurrentPosition(lat, lng) {
            document.getElementById('currentPosition').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        // 모니터링 시작
        function startMonitoring() {
            const interval = document.getElementById('updateInterval').value * 1000;
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            monitoringInterval = setInterval(() => {
                checkTrainProximity();
            }, interval);
            
            // 즉시 한 번 체크
            checkTrainProximity();
        }
        
        // 모니터링 중지
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
        }
        
        // 기차 근접도 체크
        async function checkTrainProximity() {
            let currentLat, currentLng;
            
            // 현재 위치 가져오기
            if (isGpsActive && currentLocationMarker) {
                const pos = currentLocationMarker.getLatLng();
                currentLat = pos.lat;
                currentLng = pos.lng;
            } else if (isManualMode && manualMarker) {
                const pos = manualMarker.getLatLng();
                currentLat = pos.lat;
                currentLng = pos.lng;
            } else {
                return;
            }
            
            const alertDistance = parseInt(document.getElementById('alertDistance').value);
            let nearbyTrainCount = 0;
            const nearbyTrains = [];
            
            // 지하철역과의 거리 체크
            seoulSubwayStations.forEach(station => {
                const distance = calculateDistance(currentLat, currentLng, station.lat, station.lng);
                
                if (distance <= alertDistance) {
                    nearbyTrainCount++;
                    nearbyTrains.push({
                        name: station.name,
                        line: station.line,
                        distance: Math.round(distance),
                        type: '지하철'
                    });
                }
            });
            
            // 코레일역과의 거리 체크
            korailStations.forEach(station => {
                const distance = calculateDistance(currentLat, currentLng, station.lat, station.lng);
                
                if (distance <= alertDistance) {
                    nearbyTrainCount++;
                    nearbyTrains.push({
                        name: station.name,
                        distance: Math.round(distance),
                        type: '일반철도'
                    });
                }
            });
            
            // UI 업데이트
            document.getElementById('nearbyTrains').textContent = nearbyTrainCount;
            
            if (nearbyTrains.length > 0) {
                showTrainInfo(nearbyTrains);
                
                // 경고 발생
                if (nearbyTrains.some(train => train.distance <= alertDistance / 2)) {
                    triggerAlert(`${nearbyTrains[0].name}까지 ${nearbyTrains[0].distance}m`);
                }
            } else {
                hideTrainInfo();
            }
            
            // 실제 API 호출 (데모용으로 주석 처리)
            // await fetchSeoulSubwayData();
            // await fetchKorailData();
        }
        
        // 거리 계산 (하버사인 공식)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // 지구 반지름 (미터)
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lng2-lng1) * Math.PI/180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // 경고 발생
        function triggerAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'block';
            
            // 진동
            if (document.getElementById('vibration').value === 'true' && 'vibrate' in navigator) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            // 소리
            playAlertSound();
        }
        
        // 경고 소리 재생
        function playAlertSound() {
            const soundType = document.getElementById('alertSound').value;
            let frequency = 800;
            let duration = 500;
            
            switch(soundType) {
                case 'siren':
                    frequency = 1000;
                    duration = 1000;
                    break;
                case 'bell':
                    frequency = 600;
                    duration = 800;
                    break;
                default: // beep
                    frequency = 800;
                    duration = 500;
            }
            
            // Web Audio API를 사용한 소리 생성
            if (typeof(AudioContext) !== "undefined" || typeof(webkitAudioContext) !== "undefined") {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration/1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration/1000);
            }
        }
        
        // 경고 숨기기
        function hideAlert() {
            document.getElementById('alertModal').style.display = 'none';
        }
        
        // 기차 정보 표시
        function showTrainInfo(trains) {
            const trainInfo = document.getElementById('trainInfo');
            const trainList = document.getElementById('trainList');
            
            trainList.innerHTML = '';
            
            trains.forEach(train => {
                const trainItem = document.createElement('div');
                trainItem.className = 'train-item';
                
                const distanceClass = train.distance <= 200 ? 'distance-warning' : 'distance-safe';
                
                trainItem.innerHTML = `
                    <div>
                        <strong>${train.name}</strong>
                        ${train.line ? `<span>(${train.line})</span>` : ''}
                        <small>[${train.type}]</small>
                    </div>
                    <div class="${distanceClass}">${train.distance}m</div>
                `;
                
                trainList.appendChild(trainItem);
            });
            
            trainInfo.style.display = 'block';
        }
        
        // 기차 정보 숨기기
        function hideTrainInfo() {
            document.getElementById('trainInfo').style.display = 'none';
        }
        
        // 마커 지우기
        function clearMarkers() {
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
                currentLocationMarker = null;
            }
            
            if (manualMarker) {
                map.removeLayer(manualMarker);
                manualMarker = null;
            }
            
            trainMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            trainMarkers = [];
            
            stopGpsTracking();
            isManualMode = false;
            updateUI();
        }
        
        // UI 업데이트
        function updateUI() {
            const startBtn = document.getElementById('startGpsBtn');
            const stopBtn = document.getElementById('stopGpsBtn');
            const manualBtn = document.getElementById('manualModeBtn');
            const currentMode = document.getElementById('currentMode');
            const gpsStatus = document.getElementById('gpsStatus');
            
            if (isGpsActive) {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                manualBtn.disabled = true;
                currentMode.textContent = 'GPS 자동 추적';
                gpsStatus.textContent = '활성';
                gpsStatus.style.color = '#2ed573';
            } else if (isManualMode) {
                startBtn.disabled = true;
                stopBtn.disabled = true;
                manualBtn.disabled = false;
                manualBtn.textContent = '🏃 수동 모드 (활성)';
                currentMode.textContent = '수동 위치 설정';
                gpsStatus.textContent = '비활성';
                gpsStatus.style.color = '#ff6b6b';
            } else {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                manualBtn.disabled = false;
                manualBtn.textContent = '📍 수동 위치 설정';
                currentMode.textContent = '대기 중';
                gpsStatus.textContent = '비활성';
                gpsStatus.style.color = '#ff6b6b';
            }
        }
        
        // 서울시 지하철 API 호출 (실제 구현)
        async function fetchSeoulSubwayData() {
            try {
                const response = await fetch(`http://swopenAPI.seoul.go.kr/api/subway/${SEOUL_SUBWAY_API_KEY}/json/realtimeStationArrival/0/100/`);
                const data = await response.json();
                
                // API 데이터 처리 로직
                console.log('서울시 지하철 데이터:', data);
                
            } catch (error) {
                console.error('서울시 지하철 API 오류:', error);
            }
        }
        
        // 코레일 API 호출 (실제 구현)
        async function fetchKorailData() {
            try {
                const response = await fetch(`http://apis.data.go.kr/B551457/run/v2/routeWithWay?serviceKey=${KORAIL_API_KEY}&numOfRows=100&pageNo=1&_type=json`);
                const data = await response.json();
                
                // API 데이터 처리 로직
                console.log('코레일 데이터:', data);
                
            } catch (error) {
                console.error('코레일 API 오류:', error);
            }
        }
    </script>
</body>
</html>
