<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš† ì—´ì°¨ ì ‘ê·¼ ì˜ˆì¸¡ ì‹œìŠ¤í…œ (êµìœ¡ìš©)</title>
    
    <!-- HTTPS í•„ìˆ˜ ì•Œë¦¼ -->
    <meta name="description" content="GPS ê¸°ë°˜ ì‹œê°„ ì˜ˆì¸¡ ì—´ì°¨ ì•ˆì „ ê²½ê³  ì‹œìŠ¤í…œ - êµìœ¡ ë° ì—°êµ¬ ëª©ì ">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            border-radius: 15px;
            color: white;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 13px;
        }

        .education-notice {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }

        .education-notice strong {
            color: #1976d2;
            display: block;
            margin-bottom: 8px;
        }

        .https-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .https-warning.show {
            display: block;
        }

        .https-warning.hide {
            display: none;
        }

        .mode-selector {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .status-safe {
            background: #4caf50;
        }

        .status-warning {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        .status-danger {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        #map {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .info-panel {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-panel h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .prediction-panel {
            background: #f3e5f5;
            border: 2px solid #9c27b0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .prediction-panel h3 {
            color: #7b1fa2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .warning-message {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            display: none;
            position: sticky;
            top: 10px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .warning-message.show {
            display: block;
            animation: shake 0.5s ease-in-out, persistentGlow 2s infinite;
        }

        @keyframes persistentGlow {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
                border-color: #ffc107;
            }
            50% { 
                box-shadow: 0 4px 20px rgba(255, 87, 34, 0.5);
                border-color: #ff5722;
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .warning-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .warning-time {
            font-size: 12px;
            opacity: 0.8;
            font-weight: normal;
        }

        .train-item.urgent {
            animation: urgentPulse 1s infinite;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .train-item.warning {
            animation: warningPulse 2s infinite;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }

        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .distance-input, select.distance-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            background: white;
            color: #333;
        }

        select.distance-input {
            cursor: pointer;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="m0 1 2 2 2-2z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 40px;
        }

        .train-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .train-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            font-size: 14px;
        }

        .train-item.subway {
            border-left-color: #2196f3;
        }

        .train-item.korail {
            border-left-color: #ff5722;
        }

        .train-item .train-line {
            font-weight: bold;
            color: #333;
        }

        .train-item .train-info {
            color: #666;
            margin-top: 5px;
        }

        .train-item .train-distance {
            color: #ff6b6b;
            font-weight: bold;
        }

        .prediction-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #9c27b0;
        }

        .prediction-item.imminent {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .prediction-item.warning {
            border-left-color: #ff9800;
            background: #fff8e1;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #c62828;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
            margin-top: 30px;
        }

        .gps-debug {
            background: #e1f5fe;
            border: 1px solid #b3e5fc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #01579b;
        }

        .countdown-display {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .countdown-safe { background: #e8f5e8; color: #2e7d32; }
        .countdown-warning { background: #fff3e0; color: #f57c00; }
        .countdown-danger { background: #ffebee; color: #c62828; }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš† ì—´ì°¨ ì ‘ê·¼ ì˜ˆì¸¡ ì‹œìŠ¤í…œ v2.0</h1>
            <p>GPS + ODsay API ê¸°ë°˜ ì‹œê°„ ì˜ˆì¸¡ ê²½ê³  (êµìœ¡ìš©)</p>
        </div>

        <!-- êµìœ¡ìš© ì•Œë¦¼ -->
        <div class="education-notice">
            <strong>ğŸ“š êµìœ¡ ë° ì—°êµ¬ ëª©ì  ì‹œìŠ¤í…œ</strong>
            ì´ ì‹œìŠ¤í…œì€ êµìœ¡ìš© ë°ëª¨ì…ë‹ˆë‹¤. ì‹¤ì œ ì•ˆì „ì— ì˜ì¡´í•˜ì§€ ë§ˆì„¸ìš”.<br>
            ì‹¤ì œ ìƒí™©ì—ì„œëŠ” í•­ìƒ ì‹œê°ì , ì²­ê°ì  í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </div>

        <!-- HTTPS ê²½ê³  -->
        <div id="https-warning" class="https-warning">
            <strong>âš ï¸ ì¤‘ìš”!</strong><br>
            GPS ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ <strong>HTTPS í™˜ê²½</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
            <small>GitHub Pagesì— ë°°í¬í•˜ë©´ ìë™ìœ¼ë¡œ HTTPSê°€ ì ìš©ë©ë‹ˆë‹¤.</small>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('gps')">GPS ê¸°ë°˜ ì˜ˆì¸¡</button>
            <button class="mode-btn" onclick="switchMode('manual')">ìˆ˜ë™ ìœ„ì¹˜ ì„ íƒ</button>
        </div>

        <!-- GPS ê¸°ë°˜ ëª¨ë“œ -->
        <div id="gps-mode" class="content-section active">
            <div class="status-card">
                <div id="gps-status-indicator" class="status-indicator status-safe">ğŸ“</div>
                <h3 id="gps-status-text">GPS ìœ„ì¹˜ í™•ì¸ ì¤‘...</h3>
                <p id="gps-location-text">ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤</p>
            </div>

            <!-- GPS ë””ë²„ê·¸ ì •ë³´ -->
            <div id="gps-debug" class="gps-debug" style="display:none;">
                <strong>GPS ë””ë²„ê·¸ ì •ë³´:</strong><br>
                <span id="debug-info">í™•ì¸ ì¤‘...</span>
            </div>

            <div class="control-panel">
                <button id="start-monitoring" class="button btn-primary">ì˜ˆì¸¡ ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
                <button id="stop-monitoring" class="button btn-danger" style="display:none;">ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
                <button id="retry-gps" class="button btn-secondary" style="display:none;">GPS ì¬ì‹œë„</button>
                
                <div style="margin-top: 15px;">
                    <label for="alert-time">ê²½ê³  ì‹œê°„ (ì´ˆ):</label>
                    <input type="number" id="alert-time" class="distance-input" value="120" min="30" max="300">
                    
                    <label for="update-interval">ê°±ì‹  ì£¼ê¸°:</label>
                    <select id="update-interval" class="distance-input" style="height: 50px;">
                        <option value="10000">âš¡ 10ì´ˆ (ê³ ì„±ëŠ¥)</option>
                        <option value="15000" selected>ğŸ”¥ 15ì´ˆ (ê¶Œì¥)</option>
                        <option value="30000">âš–ï¸ 30ì´ˆ (ê· í˜•)</option>
                        <option value="60000">ğŸ”‹ 60ì´ˆ (ì ˆì•½)</option>
                    </select>
                </div>
            </div>

            <div id="gps-warning" class="warning-message">
                <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë‚´ìš© ìƒì„± -->
            </div>

            <!-- ì˜ˆì¸¡ ì •ë³´ íŒ¨ë„ -->
            <div id="prediction-panel" class="prediction-panel" style="display:none;">
                <h3>ğŸ”® ì—´ì°¨ ì ‘ê·¼ ì˜ˆì¸¡</h3>
                <div id="countdown-display" class="countdown-display countdown-safe">
                    ì•ˆì „ êµ¬ê°„
                </div>
                <div id="predictions-list"></div>
            </div>

            <div class="info-panel">
                <h3>ğŸ“Š ëª¨ë‹ˆí„°ë§ ì •ë³´</h3>
                <div class="info-item">
                    <span>ìƒíƒœ:</span>
                    <span id="monitoring-status">ëŒ€ê¸° ì¤‘</span>
                </div>
                <div class="info-item">
                    <span>ê²½ê³  ìƒíƒœ:</span>
                    <span id="warning-status">ì•ˆì „</span>
                </div>
                <div class="info-item">
                    <span>ì˜ˆì¸¡ ëª¨ë¸:</span>
                    <span id="prediction-model">ODsay + ì‹œê°„ ê¸°ë°˜ v2.0</span>
                </div>
                <div class="info-item">
                    <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</span>
                    <span id="last-update">-</span>
                </div>
                <div class="info-item">
                    <span>ê·¼ì²˜ ì—­ ìˆ˜:</span>
                    <span id="nearby-stations-count">0</span>
                </div>
                <div class="info-item">
                    <span>í™œì„± ì˜ˆì¸¡:</span>
                    <span id="active-predictions">0ê°œ</span>
                </div>
            </div>
        </div>

        <!-- ìˆ˜ë™ ì„ íƒ ëª¨ë“œ -->
        <div id="manual-mode" class="content-section">
            <div class="status-card">
                <div id="manual-status-indicator" class="status-indicator status-safe">ğŸ“</div>
                <h3 id="manual-status-text">ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
                <p>ì§€ë„ì—ì„œ ëª¨ë‹ˆí„°ë§í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”</p>
            </div>

            <div id="map"></div>

            <div class="control-panel">
                <button id="start-manual-monitoring" class="button btn-primary" disabled>ì„ íƒí•œ ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§</button>
                <button id="stop-manual-monitoring" class="button btn-danger" style="display:none;">ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
                
                <div style="margin-top: 15px;">
                    <label for="manual-alert-time">ê²½ê³  ì‹œê°„ (ì´ˆ):</label>
                    <input type="number" id="manual-alert-time" class="distance-input" value="120" min="30" max="300">
                    
                    <label for="manual-update-interval">ê°±ì‹  ì£¼ê¸°:</label>
                    <select id="manual-update-interval" class="distance-input" style="height: 50px;">
                        <option value="10000">âš¡ 10ì´ˆ (ê³ ì„±ëŠ¥)</option>
                        <option value="15000" selected>ğŸ”¥ 15ì´ˆ (ê¶Œì¥)</option>
                        <option value="30000">âš–ï¸ 30ì´ˆ (ê· í˜•)</option>
                        <option value="60000">ğŸ”‹ 60ì´ˆ (ì ˆì•½)</option>
                    </select>
                </div>
            </div>

            <div id="manual-warning" class="warning-message">
                <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë‚´ìš© ìƒì„± -->
            </div>

            <!-- ìˆ˜ë™ ëª¨ë“œ ì˜ˆì¸¡ íŒ¨ë„ -->
            <div id="manual-prediction-panel" class="prediction-panel" style="display:none;">
                <h3>ğŸ”® ì—´ì°¨ ì ‘ê·¼ ì˜ˆì¸¡</h3>
                <div id="manual-countdown-display" class="countdown-display countdown-safe">
                    ì•ˆì „ êµ¬ê°„
                </div>
                <div id="manual-predictions-list"></div>
            </div>

            <div class="info-panel">
                <h3>ğŸ“Š ëª¨ë‹ˆí„°ë§ ì •ë³´</h3>
                <div class="info-item">
                    <span>ìƒíƒœ:</span>
                    <span id="manual-monitoring-status">ëŒ€ê¸° ì¤‘</span>
                </div>
                <div class="info-item">
                    <span>ê²½ê³  ìƒíƒœ:</span>
                    <span id="manual-warning-status">ì•ˆì „</span>
                </div>
                <div class="info-item">
                    <span>ì˜ˆì¸¡ ëª¨ë¸:</span>
                    <span id="manual-prediction-model">ODsay + ì‹œê°„ ê¸°ë°˜ v2.0</span>
                </div>
                <div class="info-item">
                    <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</span>
                    <span id="manual-last-update">-</span>
                </div>
                <div class="info-item">
                    <span>í™œì„± ì˜ˆì¸¡:</span>
                    <span id="manual-active-predictions">0ê°œ</span>
                </div>
            </div>

            <div class="info-panel">
                <h3>ğŸ“ ì„ íƒí•œ ìœ„ì¹˜</h3>
                <div class="info-item">
                    <span>ìœ„ë„:</span>
                    <span id="selected-lat">-</span>
                </div>
                <div class="info-item">
                    <span>ê²½ë„:</span>
                    <span id="selected-lng">-</span>
                </div>
                <div class="info-item">
                    <span>ì£¼ì†Œ:</span>
                    <span id="selected-address">-</span>
                </div>
            </div>
        </div>

        <div class="train-list" id="train-list" style="display:none;">
            <h3>ğŸš† ì‹¤ì‹œê°„ ì—´ì°¨ ì •ë³´</h3>
            <div id="train-items"></div>
        </div>

        <div id="error-display" class="error-message" style="display:none;"></div>

        <div class="footer">
            <p><strong>âš ï¸ êµìœ¡ìš© ì‹œìŠ¤í…œ ì•ˆì „ ê²½ê³  âš ï¸</strong></p>
            <p>ì´ ì‹œìŠ¤í…œì€ êµìœ¡ ëª©ì ìœ¼ë¡œë§Œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <p>ì‹¤ì œ ì•ˆì „ì„ ìœ„í•´ì„œëŠ” í•­ìƒ í˜„ì¥ì˜ ì‹œê°ì , ì²­ê°ì  ì‹ í˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
            <p>Â© 2025 Train Prediction System (Educational Purpose)</p>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ ìš”ì†Œ (ì•ŒëŒìŒ) -->
    <audio id="alarm-sound" preload="auto" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMe" type="audio/wav">
    </audio>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentPosition = null;
        let selectedPosition = null;
        let map = null;
        let marker = null;
        let monitoringInterval = null;
        let isMonitoring = false;
        let alarmSound = null;
        let nearbyStations = [];
        let activePredictions = [];
        
        // ê²½ê³  ìƒíƒœ ê´€ë¦¬
        let currentWarningState = {
            isActive: false,
            lastWarningTrain: null,
            warningStartTime: null,
            lastUpdateTime: null,
            countdownValue: null
        };

        // ì—´ì°¨ ì†ë„ ë°ì´í„° (km/h)
        const TRAIN_SPEEDS = {
            subway: {
                average: 35,
                maxSpeed: 80,
                stationInterval: 1.2 // í‰ê·  ì—­ê°„ ê±°ë¦¬ (km)
            },
            bus: {
                average: 25,
                maxSpeed: 60,
                stopInterval: 0.5 // í‰ê·  ì •ë¥˜ì¥ê°„ ê±°ë¦¬ (km)
            },
            train: {
                average: 80,
                maxSpeed: 200,
                stationInterval: 15 // í‰ê·  ì—­ê°„ ê±°ë¦¬ (km)
            }
        };

        // API í‚¤ë“¤ - ODsay API í‚¤ë¥¼ ì—¬ê¸°ì— ì„¤ì •í•˜ì„¸ìš”
        const API_KEYS = {
            subway: '4a4d5943506f73633531764f4d6854', // ì„œìš¸ì‹œ ì§€í•˜ì²  API
            odsay: 'oIigBsG+BF0JEVx/Ra6yFQ' // ODsay API í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
        };

        // ì„œìš¸ ì§€í•˜ì² ì—­ + ì£¼ìš” êµí†µ ì •ë³´ ë°ì´í„° (ìˆ˜ì • ë° ë³´ì™„)
        const TRAIN_STATIONS = [
            // === 1í˜¸ì„  ì£¼ìš”ì—­ ===
            {name: 'ì„œìš¸ì—­', lat: 37.5547, lng: 126.9706, lines: ['1í˜¸ì„ ', 'KTX', 'ê³µí•­ì² ë„'], type: 'both'},
            {name: 'ì¢…ê°', lat: 37.5699, lng: 126.9825, lines: ['1í˜¸ì„ '], type: 'subway'},
            {name: 'ì¢…ë¡œ3ê°€', lat: 37.5714, lng: 126.9910, lines: ['1í˜¸ì„ ', '3í˜¸ì„ ', '5í˜¸ì„ '], type: 'subway'},
            {name: 'ë™ëŒ€ë¬¸', lat: 37.5714, lng: 127.0098, lines: ['1í˜¸ì„ ', '4í˜¸ì„ '], type: 'subway'},
            {name: 'ì‹ ì„¤ë™', lat: 37.5751, lng: 127.0255, lines: ['1í˜¸ì„ '], type: 'subway'},
            {name: 'ì˜ë“±í¬', lat: 37.5150, lng: 126.9076, lines: ['1í˜¸ì„ '], type: 'subway'},
            {name: 'êµ¬ë¡œ', lat: 37.5033, lng: 126.8817, lines: ['1í˜¸ì„ '], type: 'subway'},
            {name: 'ì¸ì²œ', lat: 37.4436, lng: 126.6434, lines: ['1í˜¸ì„ '], type: 'subway'},
            
            // === 2í˜¸ì„  ì£¼ìš”ì—­ ===
            {name: 'ì‹œì²­', lat: 37.5659, lng: 126.9777, lines: ['1í˜¸ì„ ', '2í˜¸ì„ '], type: 'subway'},
            {name: 'ì„ì§€ë¡œì…êµ¬', lat: 37.5663, lng: 126.9820, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'ì„ì§€ë¡œ3ê°€', lat: 37.5660, lng: 126.9911, lines: ['2í˜¸ì„ ', '3í˜¸ì„ '], type: 'subway'},
            {name: 'ë™ëŒ€ë¬¸ì—­ì‚¬ë¬¸í™”ê³µì›', lat: 37.5665, lng: 127.0078, lines: ['2í˜¸ì„ ', '4í˜¸ì„ ', '5í˜¸ì„ '], type: 'subway'},
            {name: 'ì‹ ë‹¹', lat: 37.5662, lng: 127.0177, lines: ['2í˜¸ì„ ', '6í˜¸ì„ '], type: 'subway'},
            {name: 'ì„±ìˆ˜', lat: 37.5448, lng: 127.0557, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'ê±´ëŒ€ì…êµ¬', lat: 37.5403, lng: 127.0701, lines: ['2í˜¸ì„ ', '7í˜¸ì„ '], type: 'subway'},
            {name: 'ê°•ë³€', lat: 37.5353, lng: 127.0944, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'ì ì‹¤ë‚˜ë£¨', lat: 37.5203, lng: 127.1038, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'ì ì‹¤', lat: 37.5134, lng: 127.1000, lines: ['2í˜¸ì„ ', '8í˜¸ì„ '], type: 'subway'},
            {name: 'ì¢…í•©ìš´ë™ì¥', lat: 37.5109, lng: 127.0732, lines: ['2í˜¸ì„ ', '9í˜¸ì„ '], type: 'subway'},
            {name: 'ì‚¼ì„±', lat: 37.5086, lng: 127.0633, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'ì„ ë¦‰', lat: 37.5045, lng: 127.0493, lines: ['2í˜¸ì„ ', 'ë¶„ë‹¹ì„ '], type: 'subway'},
            {name: 'ì—­ì‚¼', lat: 37.4996, lng: 127.0364, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'ê°•ë‚¨', lat: 37.4979, lng: 127.0276, lines: ['2í˜¸ì„ ', 'ì‹ ë¶„ë‹¹ì„ '], type: 'subway'},
            {name: 'êµëŒ€', lat: 37.4938, lng: 127.0146, lines: ['2í˜¸ì„ ', '3í˜¸ì„ '], type: 'subway'},
            {name: 'ì„œì´ˆ', lat: 37.4837, lng: 127.0054, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'ë°©ë°°', lat: 37.4813, lng: 126.9976, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'ì‚¬ë‹¹', lat: 37.4767, lng: 126.9814, lines: ['2í˜¸ì„ ', '4í˜¸ì„ '], type: 'subway'},
            {name: 'ì‹ ë¦¼', lat: 37.4844, lng: 126.9295, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'êµ¬ë¡œë””ì§€í„¸ë‹¨ì§€', lat: 37.4853, lng: 126.9012, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'ì‹ ë„ë¦¼', lat: 37.5089, lng: 126.8912, lines: ['1í˜¸ì„ ', '2í˜¸ì„ '], type: 'subway'},
            {name: 'ë‹¹ì‚°', lat: 37.5344, lng: 126.9024, lines: ['2í˜¸ì„ ', '9í˜¸ì„ '], type: 'subway'},
            {name: 'í•©ì •', lat: 37.5497, lng: 126.9135, lines: ['2í˜¸ì„ ', '6í˜¸ì„ '], type: 'subway'},
            {name: 'í™ëŒ€ì…êµ¬', lat: 37.5574, lng: 126.9233, lines: ['2í˜¸ì„ ', '6í˜¸ì„ ', 'ê³µí•­ì² ë„'], type: 'subway'},
            {name: 'ì‹ ì´Œ', lat: 37.5556, lng: 126.9364, lines: ['2í˜¸ì„ '], type: 'subway'},
            {name: 'ì´ëŒ€', lat: 37.5563, lng: 126.9464, lines: ['2í˜¸ì„ '], type: 'subway'},
            
            // === 3í˜¸ì„  ì£¼ìš”ì—­ ===
            {name: 'ëŒ€í™”', lat: 37.6585, lng: 126.7670, lines: ['3í˜¸ì„ '], type: 'subway'},
            {name: 'ë¶ˆê´‘', lat: 37.6108, lng: 126.9298, lines: ['3í˜¸ì„ ', '6í˜¸ì„ '], type: 'subway'},
            {name: 'ì—°ì‹ ë‚´', lat: 37.6186, lng: 126.9210, lines: ['3í˜¸ì„ '], type: 'subway'},
            {name: 'ë…ë¦½ë¬¸', lat: 37.5742, lng: 126.9567, lines: ['3í˜¸ì„ '], type: 'subway'},
            {name: 'ê²½ë³µê¶', lat: 37.5759, lng: 126.9732, lines: ['3í˜¸ì„ '], type: 'subway'},
            {name: 'ì•ˆêµ­', lat: 37.5760, lng: 126.9852, lines: ['3í˜¸ì„ '], type: 'subway'},
            {name: 'ì¶©ë¬´ë¡œ', lat: 37.5614, lng: 126.9936, lines: ['3í˜¸ì„ ', '4í˜¸ì„ '], type: 'subway'},
            {name: 'ë™êµ­ëŒ€ì…êµ¬', lat: 37.5584, lng: 126.9988, lines: ['3í˜¸ì„ '], type: 'subway'},
            {name: 'ê³ ì†í„°ë¯¸ë„', lat: 37.5044, lng: 127.0051, lines: ['3í˜¸ì„ ', '7í˜¸ì„ ', '9í˜¸ì„ '], type: 'subway'},
            {name: 'ë‚¨ë¶€í„°ë¯¸ë„', lat: 37.4766, lng: 127.0037, lines: ['3í˜¸ì„ '], type: 'subway'},
            {name: 'ì–‘ì¬', lat: 37.4674, lng: 127.0347, lines: ['3í˜¸ì„ '], type: 'subway'},
            
            // === ì¶”ê°€ ì£¼ìš” êµí†µ í—ˆë¸Œ (ODsay API ëŒ€ìƒ) ===
            {name: 'ê°•ë‚¨í„°ë¯¸ë„', lat: 37.5044, lng: 127.0051, lines: ['ë²„ìŠ¤í„°ë¯¸ë„'], type: 'transit'},
            {name: 'ë™ì„œìš¸í„°ë¯¸ë„', lat: 37.5203, lng: 127.1038, lines: ['ë²„ìŠ¤í„°ë¯¸ë„'], type: 'transit'},
            {name: 'ì¸ì²œê³µí•­', lat: 37.4602, lng: 126.4407, lines: ['ê³µí•­ì² ë„', 'ë²„ìŠ¤'], type: 'transit'},
            {name: 'ê¹€í¬ê³µí•­', lat: 37.5588, lng: 126.8014, lines: ['5í˜¸ì„ ', '9í˜¸ì„ ', 'ê³µí•­ì² ë„'], type: 'both'},
            
            // ë” ë§ì€ ì—­ë“¤ì„ ì¶”ê°€í•  ìˆ˜ ìˆì§€ë§Œ, ì£¼ìš” ì—­ë“¤ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì „êµ­ì„ ì»¤ë²„í•˜ë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.
        ];

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // HTTPS ì²´í¬
            checkHTTPS();
            
            // ì˜¤ë””ì˜¤ ì´ˆê¸°í™”
            alarmSound = document.getElementById('alarm-sound');
            
            // ì§€ë„ ì´ˆê¸°í™”
            initializeMap();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
            
            // GPS ê¶Œí•œ ìš”ì²­
            requestLocationPermission();
        }

        function checkHTTPS() {
            const httpsWarning = document.getElementById('https-warning');
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                httpsWarning.className = 'https-warning show';
                updateDebugInfo('HTTP í™˜ê²½ì—ì„œëŠ” GPS ì ‘ê·¼ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
            } else {
                httpsWarning.className = 'https-warning hide';
            }
        }

        function updateDebugInfo(info) {
            const debugDiv = document.getElementById('gps-debug');
            const debugInfo = document.getElementById('debug-info');
            debugInfo.textContent = info;
            debugDiv.style.display = 'block';
        }

        function setupEventListeners() {
            // GPS ëª¨ë“œ ë²„íŠ¼ë“¤
            document.getElementById('start-monitoring').addEventListener('click', startGPSMonitoring);
            document.getElementById('stop-monitoring').addEventListener('click', stopGPSMonitoring);
            document.getElementById('retry-gps').addEventListener('click', requestLocationPermission);
            
            // ìˆ˜ë™ ëª¨ë“œ ë²„íŠ¼ë“¤
            document.getElementById('start-manual-monitoring').addEventListener('click', startManualMonitoring);
            document.getElementById('stop-manual-monitoring').addEventListener('click', stopManualMonitoring);
            
            // ê°±ì‹  ì£¼ê¸° ë³€ê²½ ì´ë²¤íŠ¸
            document.getElementById('update-interval').addEventListener('change', function() {
                if (isMonitoring) {
                    stopGPSMonitoring();
                    setTimeout(() => startGPSMonitoring(), 100);
                }
            });
            
            document.getElementById('manual-update-interval').addEventListener('change', function() {
                if (isMonitoring) {
                    stopManualMonitoring();
                    setTimeout(() => startManualMonitoring(), 100);
                }
            });
        }

        function switchMode(mode) {
            // í™œì„± ë²„íŠ¼ ë³€ê²½
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // ì½˜í…ì¸  ì„¹ì…˜ ë³€ê²½
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            if (mode === 'gps') {
                document.getElementById('gps-mode').classList.add('active');
            } else {
                document.getElementById('manual-mode').classList.add('active');
            }
            
            // ê¸°ì¡´ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
            if (isMonitoring) {
                stopAllMonitoring();
            }
        }

        function initializeMap() {
            // Leaflet ì§€ë„ ì´ˆê¸°í™”
            map = L.map('map').setView([37.5665, 126.9780], 10);

            // OpenStreetMap íƒ€ì¼ ì¶”ê°€
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
            map.on('click', function(e) {
                setSelectedPosition(e.latlng.lat, e.latlng.lng);
            });

            // ê¸°ì°¨ì—­ë“¤ ë§ˆì»¤ ì¶”ê°€
            TRAIN_STATIONS.forEach(station => {
                let markerColor = '#2196F3';
                let markerSize = 8;
                
                if (station.type === 'transit') {
                    markerColor = '#FF5722';
                    markerSize = 10;
                } else if (station.type === 'both') {
                    markerColor = '#9C27B0';
                    markerSize = 12;
                }
                
                const stationMarker = L.marker([station.lat, station.lng])
                    .bindPopup(`<b>${station.name}</b><br>${station.lines.join(', ')}<br><small>(${station.type === 'subway' ? 'ì§€í•˜ì² /ê²½ì „ì² ' : station.type === 'transit' ? 'êµí†µí—ˆë¸Œ' : 'ì§€í•˜ì² +êµí†µí—ˆë¸Œ'})</small>`)
                    .addTo(map);
                
                stationMarker.setIcon(L.divIcon({
                    html: `<div style="background:${markerColor};width:${markerSize}px;height:${markerSize}px;border-radius:50%;border:2px solid white;"></div>`,
                    iconSize: [markerSize + 4, markerSize + 4],
                    className: 'train-station-marker'
                }));
            });
        }

        function requestLocationPermission() {
            if (!navigator.geolocation) {
                updateGPSStatus('GPS ë¯¸ì§€ì›', 'ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                updateDebugInfo('Geolocation APIê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                document.getElementById('retry-gps').style.display = 'block';
                return;
            }

            document.getElementById('gps-status-text').textContent = 'GPS ê¶Œí•œ ìš”ì²­ ì¤‘...';
            updateDebugInfo('GPS ê¶Œí•œ ìš”ì²­ ì¤‘...');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 300000
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    updateGPSStatus('ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ', `ìœ„ë„: ${currentPosition.lat.toFixed(6)}, ê²½ë„: ${currentPosition.lng.toFixed(6)}`);
                    updateDebugInfo(`ì •í™•ë„: ${Math.round(position.coords.accuracy)}m, ì‹œê°„: ${new Date(position.timestamp).toLocaleTimeString()}`);
                    
                    findNearbyStations(currentPosition);
                    document.getElementById('retry-gps').style.display = 'none';
                },
                function(error) {
                    let errorMsg = 'GPS ì˜¤ë¥˜: ';
                    let debugMsg = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤';
                            debugMsg = 'PERMISSION_DENIED - ì‚¬ìš©ìê°€ ìœ„ì¹˜ ì ‘ê·¼ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                            debugMsg = 'POSITION_UNAVAILABLE - GPS ì‹ í˜¸ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤';
                            debugMsg = 'TIMEOUT - 15ì´ˆ ë‚´ì— ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                            break;
                        default:
                            errorMsg += 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                            debugMsg = `UNKNOWN ERROR (${error.code}): ${error.message}`;
                            break;
                    }
                    
                    updateGPSStatus('GPS ì˜¤ë¥˜', errorMsg);
                    updateDebugInfo(debugMsg);
                    document.getElementById('retry-gps').style.display = 'block';
                    
                    console.error('GPS Error:', error);
                },
                options
            );
        }

        function updateGPSStatus(status, location) {
            document.getElementById('gps-status-text').textContent = status;
            document.getElementById('gps-location-text').textContent = location;
        }

        function setSelectedPosition(lat, lng) {
            selectedPosition = { lat: lat, lng: lng };
            
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            if (marker) {
                map.removeLayer(marker);
            }
            
            // ìƒˆ ë§ˆì»¤ ì¶”ê°€
            marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup('ì„ íƒí•œ ìœ„ì¹˜').openPopup();
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('selected-lat').textContent = lat.toFixed(6);
            document.getElementById('selected-lng').textContent = lng.toFixed(6);
            document.getElementById('start-manual-monitoring').disabled = false;
            
            document.getElementById('selected-address').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            document.getElementById('manual-status-text').textContent = 'ìœ„ì¹˜ ì„ íƒ ì™„ë£Œ';
        }

        function findNearbyStations(position) {
            nearbyStations = TRAIN_STATIONS.filter(station => {
                const distance = calculateDistance(position.lat, position.lng, station.lat, station.lng);
                return distance <= 10000; // 10km ì´ë‚´
            }).map(station => ({
                ...station,
                distance: calculateDistance(position.lat, position.lng, station.lat, station.lng)
            })).sort((a, b) => a.distance - b.distance);

            console.log(`ğŸšƒ ê·¼ì²˜ ì—­ ${nearbyStations.length}ê°œ ë°œê²¬:`);
            nearbyStations.slice(0, 10).forEach(station => {
                console.log(`   ${station.type === 'subway' ? 'ğŸš‡' : station.type === 'transit' ? 'ğŸšŒ' : 'ğŸš†'} ${station.name}: ${Math.round(station.distance)}m`);
            });

            document.getElementById('nearby-stations-count').textContent = nearbyStations.length;
            
            if (nearbyStations.length > 0) {
                updateDebugInfo(`ê·¼ì²˜ ì—­: ${nearbyStations.length}ê°œ ë°œê²¬ (10km ë°˜ê²½)`);
            } else {
                updateDebugInfo('ê·¼ì²˜ì— ì—­ì´ ì—†ìŠµë‹ˆë‹¤ (10km ë°˜ê²½)');
            }
        }

        function startGPSMonitoring() {
            if (!currentPosition) {
                alert('GPS ìœ„ì¹˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤');
                return;
            }
            
            isMonitoring = true;
            document.getElementById('start-monitoring').style.display = 'none';
            document.getElementById('stop-monitoring').style.display = 'block';
            document.getElementById('monitoring-status').textContent = 'ì˜ˆì¸¡ ëª¨ë‹ˆí„°ë§ ì¤‘';
            document.getElementById('prediction-panel').style.display = 'block';
            
            const updateInterval = parseInt(document.getElementById('update-interval').value);
            
            monitoringInterval = setInterval(() => {
                performTrainPrediction(currentPosition, false);
            }, updateInterval);
            
            // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
            performTrainPrediction(currentPosition, false);
        }

        function stopGPSMonitoring() {
            stopAllMonitoring();
            document.getElementById('start-monitoring').style.display = 'block';
            document.getElementById('stop-monitoring').style.display = 'none';
            document.getElementById('monitoring-status').textContent = 'ëŒ€ê¸° ì¤‘';
            document.getElementById('prediction-panel').style.display = 'none';
        }

        function startManualMonitoring() {
            if (!selectedPosition) {
                alert('ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            isMonitoring = true;
            document.getElementById('start-manual-monitoring').style.display = 'none';
            document.getElementById('stop-manual-monitoring').style.display = 'block';
            document.getElementById('manual-monitoring-status').textContent = 'ì˜ˆì¸¡ ëª¨ë‹ˆí„°ë§ ì¤‘';
            document.getElementById('manual-prediction-panel').style.display = 'block';
            
            const updateInterval = parseInt(document.getElementById('manual-update-interval').value);
            
            monitoringInterval = setInterval(() => {
                performTrainPrediction(selectedPosition, true);
            }, updateInterval);
            
            // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
            performTrainPrediction(selectedPosition, true);
        }

        function stopManualMonitoring() {
            stopAllMonitoring();
            document.getElementById('start-manual-monitoring').style.display = 'block';
            document.getElementById('stop-manual-monitoring').style.display = 'none';
            document.getElementById('manual-monitoring-status').textContent = 'ëŒ€ê¸° ì¤‘';
            document.getElementById('manual-prediction-panel').style.display = 'none';
        }

        function stopAllMonitoring() {
            isMonitoring = false;
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            // ê²½ê³  ìƒíƒœ ì´ˆê¸°í™”
            hideWarning();
            stopAlarm();
            currentWarningState.isActive = false;
            currentWarningState.lastWarningTrain = null;
            currentWarningState.warningStartTime = null;
            currentWarningState.countdownValue = null;
            
            activePredictions = [];
            document.getElementById('train-list').style.display = 'none';
            document.getElementById('prediction-panel').style.display = 'none';
            document.getElementById('manual-prediction-panel').style.display = 'none';
        }

        async function performTrainPrediction(position, isManualMode) {
            const alertTime = parseInt(
                isManualMode ? 
                document.getElementById('manual-alert-time').value : 
                document.getElementById('alert-time').value
            );
            
            try {
                // ê·¼ì²˜ ì—­ì‚¬ë“¤ì— ëŒ€í•´ ì—´ì°¨ ì •ë³´ ìˆ˜ì§‘
                const stationsToCheck = nearbyStations.length > 0 ? 
                    nearbyStations.filter(station => station.distance <= 5000).slice(0, 5) :
                    TRAIN_STATIONS.filter(station => {
                        const distance = calculateDistance(position.lat, position.lng, station.lat, station.lng);
                        return distance <= 5000;
                    }).slice(0, 5);

                let allPredictions = [];
                let trainData = [];

                for (const station of stationsToCheck) {
                    try {
                        // ì—´ì°¨ ë„ì°©/ì¶œë°œ ì •ë³´ ìˆ˜ì§‘
                        let stationTrains = [];
                        
                        if (station.type === 'subway' || station.type === 'both') {
                            const subwayData = await fetchSubwayRealtime(station.name, station.lines);
                            stationTrains = [...stationTrains, ...subwayData];
                        }
                        
                        if (station.type === 'transit' || station.type === 'both') {
                            const odsayData = await fetchOdsayData(station.name, station.lines, position);
                            stationTrains = [...stationTrains, ...odsayData];
                        }
                        
                        trainData = [...trainData, ...stationTrains];
                        
                        // ê° ì—´ì°¨ì— ëŒ€í•´ GPS ìœ„ì¹˜ í†µê³¼ ì‹œê°„ ì˜ˆì¸¡
                        for (const train of stationTrains) {
                            const prediction = predictTrainPassingTime(train, station, position);
                            if (prediction && prediction.timeToPass <= alertTime * 2) { // ê²½ê³ ì‹œê°„ì˜ 2ë°° ì´ë‚´ë§Œ í‘œì‹œ
                                allPredictions.push(prediction);
                            }
                        }
                        
                    } catch (error) {
                        console.error(`${station.name} ì˜ˆì¸¡ ì˜¤ë¥˜:`, error);
                    }
                }

                // ì˜ˆì¸¡ ê²°ê³¼ ì •ë ¬ (í†µê³¼ ì‹œê°„ì´ ë¹ ë¥¸ ìˆœ)
                allPredictions.sort((a, b) => a.timeToPass - b.timeToPass);
                activePredictions = allPredictions;

                console.log(`ğŸ”® ì´ ì˜ˆì¸¡: ${allPredictions.length}ê°œ`);
                
                // ê²½ê³  ì²˜ë¦¬
                const imminentTrains = allPredictions.filter(p => p.timeToPass <= alertTime);
                
                if (imminentTrains.length > 0) {
                    if (!currentWarningState.isActive) {
                        currentWarningState.isActive = true;
                        currentWarningState.warningStartTime = new Date();
                        triggerAlarm();
                    }
                    
                    currentWarningState.lastWarningTrain = imminentTrains[0];
                    currentWarningState.countdownValue = imminentTrains[0].timeToPass;
                    showPredictionWarning(imminentTrains, isManualMode);
                    
                } else {
                    if (currentWarningState.isActive) {
                        hideWarning();
                        currentWarningState.isActive = false;
                        currentWarningState.countdownValue = null;
                        stopAlarm();
                    }
                }

                // UI ì—…ë°ì´íŠ¸
                displayPredictions(allPredictions, isManualMode);
                displayTrainInfo(trainData);
                updateMonitoringInfo(stationsToCheck.length, isManualMode, allPredictions.length);
                
            } catch (error) {
                console.error('ì˜ˆì¸¡ ìˆ˜í–‰ ì˜¤ë¥˜:', error);
                showError('ì˜ˆì¸¡ ìˆ˜í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ODsay API í˜¸ì¶œ í•¨ìˆ˜
        async function fetchOdsayData(stationName, stationLines, position) {
            try {
                // ODsay API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ëª¨ì˜ ë°ì´í„° ë°˜í™˜
                if (API_KEYS.odsay === 'oIigBsG+BF0JEVx/Ra6yFQ') {
                    console.log(`ODsay API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ. ${stationName}ì— ëŒ€í•œ ëª¨ì˜ ë°ì´í„° ìƒì„±`);
                    return generateOdsayMockData(stationName, stationLines);
                }

                // ODsay APIë¥¼ í†µí•œ ëŒ€ì¤‘êµí†µ ì •ë³´ ì¡°íšŒ
                // 1. ë¨¼ì € ì •ë¥˜ì¥/ì—­ ê²€ìƒ‰
                const searchUrl = `https://api.odsay.com/v1/api/searchPubTransPath?SX=${position.lng}&SY=${position.lat}&EX=${position.lng}&EY=${position.lat}&apiKey=${API_KEYS.odsay}`;
                
                const searchResponse = await fetch(searchUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!searchResponse.ok) {
                    throw new Error(`ODsay API ì‘ë‹µ ì˜¤ë¥˜: ${searchResponse.status}`);
                }
                
                const searchData = await searchResponse.json();
                
                if (searchData.error) {
                    throw new Error(searchData.error.message || 'ODsay API ì˜¤ë¥˜');
                }

                // 2. ì‹¤ì‹œê°„ ë„ì°© ì •ë³´ ì¡°íšŒ
                const transitData = [];
                
                if (searchData.result && searchData.result.path) {
                    for (const path of searchData.result.path) {
                        if (path.subPath) {
                            for (const subPath of path.subPath) {
                                if (subPath.trafficType === 1 || subPath.trafficType === 2) { // ì§€í•˜ì²  ë˜ëŠ” ë²„ìŠ¤
                                    const arrivalInfo = await fetchOdsayArrivalInfo(subPath);
                                    if (arrivalInfo) {
                                        transitData.push({
                                            type: subPath.trafficType === 1 ? 'subway' : 'bus',
                                            station: stationName,
                                            line: subPath.lane ? subPath.lane[0].name : 'Unknown',
                                            direction: subPath.way || 'ë°©í–¥ì •ë³´ì—†ìŒ',
                                            destination: subPath.endName || 'ëª©ì ì§€',
                                            arrivalMessage: arrivalInfo.message,
                                            arrivalCode: arrivalInfo.code,
                                            timestamp: new Date().toISOString()
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
                
                return transitData;
                
            } catch (error) {
                console.error(`${stationName} ODsay ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:`, error);
                // ì˜¤ë¥˜ ì‹œ ëª¨ì˜ ë°ì´í„° ë°˜í™˜
                return generateOdsayMockData(stationName, stationLines);
            }
        }

        // ODsay ì‹¤ì‹œê°„ ë„ì°©ì •ë³´ ì¡°íšŒ
        async function fetchOdsayArrivalInfo(subPath) {
            try {
                // ODsayì˜ ì‹¤ì‹œê°„ ë„ì°©ì •ë³´ API í˜¸ì¶œ (ì‹¤ì œ êµ¬í˜„ì‹œ ì ì ˆí•œ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
                // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•œ ëª¨ì˜ êµ¬í˜„
                const arrivalTime = Math.floor(Math.random() * 10) + 1; // 1-10ë¶„
                
                return {
                    message: `${arrivalTime}ë¶„ í›„ ë„ì°©`,
                    code: arrivalTime <= 3 ? '0' : '1'
                };
                
            } catch (error) {
                console.error('ODsay ë„ì°©ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                return null;
            }
        }

        // ODsay ëª¨ì˜ ë°ì´í„° ìƒì„± í•¨ìˆ˜
        function generateOdsayMockData(stationName, stationLines) {
            console.log(`ğŸ“Š ${stationName} ODsay ëª¨ì˜ ë°ì´í„° ìƒì„±`);
            
            const hour = new Date().getHours();
            let probability = 0.8; // ê¸°ë³¸ í™•ë¥ 
            
            // ì‹œê°„ëŒ€ë³„ í™•ë¥  ì¡°ì •
            if (hour >= 6 && hour <= 9) probability = 0.9;
            else if (hour >= 17 && hour <= 20) probability = 0.9;
            else if (hour >= 22 || hour <= 5) probability = 0.6;
            
            if (Math.random() > probability) {
                return [];
            }
            
            const transitData = [];
            const numItems = Math.floor(Math.random() * 4) + 2; // 2-5ê°œ
            
            const transitTypes = ['ë²„ìŠ¤', 'ë§ˆì„ë²„ìŠ¤', 'ê´‘ì—­ë²„ìŠ¤', 'ê³µí•­ë²„ìŠ¤'];
            const arrivalTimes = [
                { message: 'ê³§ ë„ì°©', weight: 0.1 },
                { message: '1ë¶„ í›„ ë„ì°©', weight: 0.15 },
                { message: '2ë¶„ í›„ ë„ì°©', weight: 0.2 },
                { message: '3ë¶„ í›„ ë„ì°©', weight: 0.2 },
                { message: '5ë¶„ í›„ ë„ì°©', weight: 0.15 },
                { message: '7ë¶„ í›„ ë„ì°©', weight: 0.1 },
                { message: '10ë¶„ í›„ ë„ì°©', weight: 0.1 }
            ];
            
            for (let i = 0; i < numItems; i++) {
                const transitType = transitTypes[Math.floor(Math.random() * transitTypes.length)];
                const busNumber = generateBusNumber(transitType);
                const arrival = selectWeightedRandom(arrivalTimes);
                
                transitData.push({
                    type: 'bus',
                    station: stationName,
                    line: `${busNumber}ë²ˆ ${transitType}`,
                    direction: Math.random() > 0.5 ? 'ìƒí–‰' : 'í•˜í–‰',
                    destination: getRandomBusDestination(),
                    arrivalMessage: arrival.message,
                    arrivalCode: arrival.message.includes('ê³§') ? '0' : '1',
                    timestamp: new Date().toISOString()
                });
            }
            
            console.log(`âœ… ${stationName} ODsay ëª¨ì˜ ë°ì´í„° ${transitData.length}ê°œ ìƒì„± ì™„ë£Œ`);
            return transitData;
        }

        function generateBusNumber(type) {
            switch (type) {
                case 'ë²„ìŠ¤':
                    return Math.floor(Math.random() * 999) + 1;
                case 'ë§ˆì„ë²„ìŠ¤':
                    return `ë§ˆì„${Math.floor(Math.random() * 99) + 1}`;
                case 'ê´‘ì—­ë²„ìŠ¤':
                    return `${Math.floor(Math.random() * 900) + 100}`;
                case 'ê³µí•­ë²„ìŠ¤':
                    return `${Math.floor(Math.random() * 90) + 600}A`;
                default:
                    return Math.floor(Math.random() * 999) + 1;
            }
        }

        function getRandomBusDestination() {
            const destinations = [
                'ê°•ë‚¨í„°ë¯¸ë„', 'ì ì‹¤', 'í™ëŒ€ì…êµ¬', 'ëª…ë™', 'ì´íƒœì›', 'êµ¬ë¡œë””ì§€í„¸ë‹¨ì§€',
                'ì—¬ì˜ë„', 'ì„ì§€ë¡œ', 'ë™ëŒ€ë¬¸', 'ì‹ ì´Œ', 'ì••êµ¬ì •', 'ì„ ë¦‰', 'ì—­ì‚¼',
                'ì„œìš¸ì—­', 'ìš©ì‚°', 'ì„±ìˆ˜', 'ê±´ëŒ€ì…êµ¬', 'ì™•ì‹­ë¦¬', 'ì²­ëŸ‰ë¦¬'
            ];
            return destinations[Math.floor(Math.random() * destinations.length)];
        }

        function predictTrainPassingTime(train, station, gpsPosition) {
            try {
                // ì—´ì°¨ê°€ í˜„ì¬ ì–´ë””ì— ìˆëŠ”ì§€ ì¶”ì •
                const trainCurrentLocation = estimateTrainLocation(train, station);
                if (!trainCurrentLocation) return null;
                
                // GPS ìœ„ì¹˜ì™€ ì—­ì‚¬ ì‚¬ì´ì˜ ê±°ë¦¬
                const distanceToGPS = calculateDistance(
                    gpsPosition.lat, gpsPosition.lng,
                    station.lat, station.lng
                );
                
                // ì—´ì°¨ê°€ GPS ìœ„ì¹˜ë¥¼ í†µê³¼í•˜ëŠ” ì‹œê°„ ê³„ì‚°
                const timeToPass = calculatePassingTime(train, trainCurrentLocation, station, gpsPosition, distanceToGPS);
                
                if (timeToPass === null || timeToPass < 0) return null;
                
                return {
                    train: train,
                    station: station,
                    timeToPass: Math.round(timeToPass),
                    confidence: calculatePredictionConfidence(train, distanceToGPS),
                    estimatedLocation: trainCurrentLocation.description,
                    gpsDistance: Math.round(distanceToGPS)
                };
                
            } catch (error) {
                console.error('ì—´ì°¨ í†µê³¼ì‹œê°„ ì˜ˆì¸¡ ì˜¤ë¥˜:', error);
                return null;
            }
        }

        function estimateTrainLocation(train, station) {
            try {
                const arrivalMsg = train.arrivalMessage || '';
                
                // ì§€í•˜ì² ì˜ ê²½ìš°
                if (train.type === 'subway') {
                    if (arrivalMsg.includes('ê³§ ë„ì°©') || arrivalMsg.includes('ì§„ì…')) {
                        return { 
                            distanceFromStation: 0.2, // 200m ì „
                            description: 'ì—­ ì§„ì… ì¤‘',
                            speed: 25 // km/h
                        };
                    } else if (arrivalMsg.includes('1ë¶„')) {
                        return { 
                            distanceFromStation: 1.0, 
                            description: '1ë¶„ ê±°ë¦¬',
                            speed: 35 
                        };
                    } else if (arrivalMsg.includes('2ë¶„')) {
                        return { 
                            distanceFromStation: 2.0, 
                            description: '2ë¶„ ê±°ë¦¬',
                            speed: 35 
                        };
                    } else if (arrivalMsg.includes('3ë¶„')) {
                        return { 
                            distanceFromStation: 2.5, 
                            description: '3ë¶„ ê±°ë¦¬',
                            speed: 35 
                        };
                    }
                }
                
                // ë²„ìŠ¤ì˜ ê²½ìš°
                if (train.type === 'bus') {
                    const timeMatch = arrivalMsg.match(/(\d+)ë¶„/);
                    if (timeMatch) {
                        const minutes = parseInt(timeMatch[1]);
                        const distance = (minutes / 60) * TRAIN_SPEEDS.bus.average; // km
                        
                        return { 
                            distanceFromStation: distance, 
                            description: `${minutes}ë¶„ ê±°ë¦¬ (ì•½ ${Math.round(distance)}km)`,
                            speed: TRAIN_SPEEDS.bus.average 
                        };
                    }
                    
                    if (arrivalMsg.includes('ê³§')) {
                        return { 
                            distanceFromStation: 0.3, 
                            description: 'ì •ë¥˜ì¥ ì§„ì… ì¤‘',
                            speed: 20 
                        };
                    }
                }
                
                // ë©”ì‹œì§€ì—ì„œ ì‹œê°„ ì¶”ì¶œ
                const timeMatch = arrivalMsg.match(/(\d+)ë¶„/);
                if (timeMatch) {
                    const minutes = parseInt(timeMatch[1]);
                    let speed = 30; // ê¸°ë³¸ ì†ë„
                    
                    if (train.type === 'subway') speed = TRAIN_SPEEDS.subway.average;
                    else if (train.type === 'bus') speed = TRAIN_SPEEDS.bus.average;
                    
                    const distance = (minutes / 60) * speed; // km
                    
                    return { 
                        distanceFromStation: distance, 
                        description: `${minutes}ë¶„ ê±°ë¦¬`,
                        speed: speed 
                    };
                }
                
                return null;
                
            } catch (error) {
                console.error('ì—´ì°¨ ìœ„ì¹˜ ì¶”ì • ì˜¤ë¥˜:', error);
                return null;
            }
        }

        function calculatePassingTime(train, trainLocation, station, gpsPosition, distanceToGPS) {
            try {
                // ì—´ì°¨ê°€ ì—­ì— ë„ì°©í•˜ëŠ” ì‹œê°„
                const timeToStation = (trainLocation.distanceFromStation / trainLocation.speed) * 60; // ë¶„ ë‹¨ìœ„
                
                // ì—­ì—ì„œ GPS ìœ„ì¹˜ê¹Œì§€ì˜ ì¶”ê°€ ì‹œê°„ (ì—´ì°¨ê°€ ì—­ì„ ì§€ë‚˜ì„œ GPS ìœ„ì¹˜ê¹Œì§€)
                let additionalTime = 0;
                
                if (distanceToGPS > 500) { // GPSê°€ ì—­ì—ì„œ 500m ì´ìƒ ë–¨ì–´ì ¸ ìˆìœ¼ë©´
                    // ì—´ì°¨ê°€ ì—­ì„ ì§€ë‚˜ GPS ìœ„ì¹˜ê¹Œì§€ ê°€ëŠ” ì‹œê°„ ì¶”ê°€ ê³„ì‚°
                    const additionalDistance = (distanceToGPS - 500) / 1000; // km ë‹¨ìœ„
                    additionalTime = (additionalDistance / trainLocation.speed) * 60; // ë¶„ ë‹¨ìœ„
                }
                
                const totalTimeMinutes = timeToStation + additionalTime;
                const totalTimeSeconds = totalTimeMinutes * 60;
                
                console.log(`ğŸš‚ ${train.line} í†µê³¼ ì˜ˆì¸¡: ì—­ê¹Œì§€ ${timeToStation.toFixed(1)}ë¶„, GPSê¹Œì§€ ì¶”ê°€ ${additionalTime.toFixed(1)}ë¶„ = ì´ ${totalTimeSeconds.toFixed(0)}ì´ˆ`);
                
                return totalTimeSeconds;
                
            } catch (error) {
                console.error('í†µê³¼ ì‹œê°„ ê³„ì‚° ì˜¤ë¥˜:', error);
                return null;
            }
        }

        function calculatePredictionConfidence(train, distanceToGPS) {
            let confidence = 75; // ê¸°ë³¸ ì‹ ë¢°ë„
            
            // ì§€í•˜ì² ì€ ë” ì •í™•í•¨
            if (train.type === 'subway') {
                confidence += 15;
            } else if (train.type === 'bus') {
                confidence += 5; // ë²„ìŠ¤ëŠ” êµí†µìƒí™©ì— ì˜í–¥
            }
            
            // ê±°ë¦¬ê°€ ê°€ê¹Œìš¸ìˆ˜ë¡ ì •í™•í•¨
            if (distanceToGPS < 1000) confidence += 10;
            else if (distanceToGPS > 5000) confidence -= 20;
            
            // ë„ì°© ë©”ì‹œì§€ê°€ êµ¬ì²´ì ì¼ìˆ˜ë¡ ì •í™•í•¨
            const msg = train.arrivalMessage || '';
            if (msg.includes('ê³§') || msg.includes('ì§„ì…') || msg.includes('1ë¶„')) {
                confidence += 15;
            }
            
            return Math.min(95, Math.max(50, confidence));
        }

        async function fetchSubwayRealtime(stationName, stationLines) {
            try {
                // ì‹¤ì œ ì„œìš¸ì‹œ ì§€í•˜ì²  ì‹¤ì‹œê°„ ë„ì°©ì •ë³´ API í˜¸ì¶œ ì‹œë„
                const url = `http://swopenAPI.seoul.go.kr/api/subway/${API_KEYS.subway}/json/realtimeStationArrival/0/10/${encodeURIComponent(stationName)}`;
                
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                
                if (!response.ok) {
                    throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.errorMessage) {
                    throw new Error(data.errorMessage.message || 'API ì˜¤ë¥˜');
                }
                
                const arrivals = data.realtimeArrivalList || [];
                
                return arrivals.map(arrival => ({
                    type: 'subway',
                    station: stationName,
                    line: arrival.subwayId || arrival.trainLineNm,
                    direction: arrival.updnLine,
                    destination: arrival.bstatnNm,
                    arrivalMessage: arrival.arvlMsg2 || arrival.arvlMsg3,
                    arrivalCode: arrival.arvlCd,
                    currentStation: arrival.arvlMsg3,
                    timestamp: arrival.recptnDt
                }));
                
            } catch (error) {
                console.error(`${stationName} ì§€í•˜ì²  ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:`, error);
                // êµìœ¡ìš© ëª¨ì˜ ë°ì´í„° ë°˜í™˜
                return generateEnhancedSubwayData(stationName, stationLines);
            }
        }

        function generateEnhancedSubwayData(stationName, stationLines) {
            // ì‹œê°„ ê¸°ë°˜ í–¥ìƒëœ ì§€í•˜ì²  ëª¨ì˜ ë°ì´í„°
            const hour = new Date().getHours();
            let probability = 0.9; // ë†’ì€ í™•ë¥ ë¡œ ì—´ì°¨ ì¡´ì¬
            
            if (hour >= 6 && hour <= 9) probability = 0.95;
            if (hour >= 17 && hour <= 20) probability = 0.95;
            if (hour >= 23 || hour <= 5) probability = 0.7;
            
            if (Math.random() > probability) return [];
            
            const trains = [];
            const numTrains = Math.floor(Math.random() * 3) + 2; // 2-4ëŒ€
            
            const arrivalPatterns = [
                { message: 'ê³§ ë„ì°©', weight: 0.1 },
                { message: 'ì§„ì… ì¤‘', weight: 0.05 },
                { message: '1ë¶„ í›„ ë„ì°©', weight: 0.15 },
                { message: '2ë¶„ í›„ ë„ì°©', weight: 0.2 },
                { message: '3ë¶„ í›„ ë„ì°©', weight: 0.2 },
                { message: '4ë¶„ í›„ ë„ì°©', weight: 0.15 },
                { message: '5ë¶„ í›„ ë„ì°©', weight: 0.1 },
                { message: '7ë¶„ í›„ ë„ì°©', weight: 0.05 }
            ];
            
            for (let i = 0; i < numTrains; i++) {
                const line = stationLines[Math.floor(Math.random() * stationLines.length)];
                const pattern = selectWeightedRandom(arrivalPatterns);
                
                trains.push({
                    type: 'subway',
                    station: stationName,
                    line: line,
                    direction: Math.random() > 0.5 ? 'ìƒí–‰' : 'í•˜í–‰',
                    destination: getRandomDestination(line),
                    arrivalMessage: pattern.message,
                    arrivalCode: pattern.message.includes('ê³§') || pattern.message.includes('ì§„ì…') ? '0' : '1',
                    timestamp: new Date().toISOString()
                });
            }
            
            return trains;
        }

        function selectWeightedRandom(items) {
            const total = items.reduce((sum, item) => sum + item.weight, 0);
            let random = Math.random() * total;
            
            for (const item of items) {
                random -= item.weight;
                if (random <= 0) return item;
            }
            
            return items[items.length - 1];
        }

        function getRandomDestination(line) {
            const destinations = {
                '1í˜¸ì„ ': ['ì¸ì²œ', 'ì‹ ë„ë¦¼', 'ì„œìš¸ì—­', 'ë™ë¬˜ì•', 'ì²­ëŸ‰ë¦¬'],
                '2í˜¸ì„ ': ['ì ì‹¤', 'ê°•ë‚¨', 'í™ëŒ€ì…êµ¬', 'ì‹ ë„ë¦¼', 'ì„±ìˆ˜'],
                '3í˜¸ì„ ': ['ëŒ€í™”', 'ì˜¤ê¸ˆ'],
                '4í˜¸ì„ ': ['ë‹¹ê³ ê°œ', 'ì‚¬ë‹¹'],
                '5í˜¸ì„ ': ['ë°©í™”', 'ë§ˆì²œ', 'ìƒì¼ë™'],
                '6í˜¸ì„ ': ['ì‘ì•”', 'ë´‰í™”ì‚°'],
                '7í˜¸ì„ ': ['ì¥ì•”', 'ë¶€í‰êµ¬ì²­'],
                '8í˜¸ì„ ': ['ì•”ì‚¬', 'ëª¨ë€'],
                '9í˜¸ì„ ': ['ê°œí™”', 'ì¤‘ì•™ë³´í›ˆë³‘ì›']
            };
            
            const dests = destinations[line] || ['í„°ë¯¸ë„'];
            return dests[Math.floor(Math.random() * dests.length)];
        }

        function displayPredictions(predictions, isManualMode) {
            const prefix = isManualMode ? 'manual-' : '';
            const countdownElement = document.getElementById(prefix + 'countdown-display');
            const predictionsList = document.getElementById(prefix + 'predictions-list');
            
            if (predictions.length === 0) {
                countdownElement.textContent = 'ì•ˆì „ êµ¬ê°„';
                countdownElement.className = 'countdown-display countdown-safe';
                predictionsList.innerHTML = '<div style="text-align: center; color: #666;">ê·¼ì²˜ì— ì ‘ê·¼í•˜ëŠ” ì—´ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            // ê°€ì¥ ë¹ ë¥¸ ì—´ì°¨ì˜ ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ
            const closestTrain = predictions[0];
            const minutes = Math.floor(closestTrain.timeToPass / 60);
            const seconds = closestTrain.timeToPass % 60;
            const timeDisplay = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${seconds}ì´ˆ`;
            
            countdownElement.textContent = `${timeDisplay} - ${closestTrain.train.line}`;
            
            if (closestTrain.timeToPass <= 60) {
                countdownElement.className = 'countdown-display countdown-danger';
            } else if (closestTrain.timeToPass <= 120) {
                countdownElement.className = 'countdown-display countdown-warning';
            } else {
                countdownElement.className = 'countdown-display countdown-safe';
            }
            
            // ì˜ˆì¸¡ ëª©ë¡ í‘œì‹œ
            predictionsList.innerHTML = '';
            predictions.slice(0, 5).forEach(prediction => {
                const predictionDiv = document.createElement('div');
                predictionDiv.className = 'prediction-item';
                
                if (prediction.timeToPass <= 60) {
                    predictionDiv.className += ' imminent';
                } else if (prediction.timeToPass <= 120) {
                    predictionDiv.className += ' warning';
                }
                
                const minutes = Math.floor(prediction.timeToPass / 60);
                const seconds = prediction.timeToPass % 60;
                const timeDisplay = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
                
                const typeIcon = prediction.train.type === 'subway' ? 'ì§€í•˜ì² ' : 
                                prediction.train.type === 'bus' ? 'ë²„ìŠ¤' : 'ê¸°íƒ€êµí†µ';
                
                predictionDiv.innerHTML = `
                    <div style="font-weight: bold;">${typeIcon} ${prediction.train.line} - ${prediction.station.name}</div>
                    <div style="margin-top: 5px; color: #666;">
                        <strong>í†µê³¼ ì˜ˆìƒ: ${timeDisplay}</strong><br>
                        í˜„ì¬ ìœ„ì¹˜: ${prediction.estimatedLocation}<br>
                        ì‹ ë¢°ë„: ${prediction.confidence}%<br>
                        GPS ê±°ë¦¬: ${prediction.gpsDistance}m
                    </div>
                `;
                
                predictionsList.appendChild(predictionDiv);
            });
        }

        function showPredictionWarning(imminentTrains, isManualMode) {
            const warningElement = isManualMode ? 
                document.getElementById('manual-warning') : 
                document.getElementById('gps-warning');
            
            const urgentTrain = imminentTrains[0];
            const timeLeft = urgentTrain.timeToPass;
            
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeDisplay = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;
            
            const typeIcon = urgentTrain.train.type === 'subway' ? 'ğŸš‡' : 
                            urgentTrain.train.type === 'bus' ? 'ğŸšŒ' : 'ğŸš†';
            
            const warningDuration = currentWarningState.warningStartTime ? 
                Math.floor((new Date() - currentWarningState.warningStartTime) / 1000) : 0;
            
            warningElement.innerHTML = `
                <div class="warning-header">
                    <span>âš ï¸ ì—´ì°¨ ì ‘ê·¼ ê²½ê³ !</span>
                    <span class="warning-time">ê²½ê³  ${warningDuration}ì´ˆ</span>
                </div>
                <div>${typeIcon} ${urgentTrain.train.line} - ${urgentTrain.station.name}</div>
                <div style="font-size: 18px; font-weight: bold; margin-top: 8px; color: #d32f2f;">
                    ${timeDisplay} í›„ í†µê³¼ ì˜ˆìƒ
                </div>
                <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">
                    í˜„ì¬ ìœ„ì¹˜: ${urgentTrain.estimatedLocation} (ì‹ ë¢°ë„: ${urgentTrain.confidence}%)
                </div>
            `;
            
            warningElement.classList.add('show');
            
            // ìƒíƒœ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
            const indicator = isManualMode ? 
                document.getElementById('manual-status-indicator') : 
                document.getElementById('gps-status-indicator');
            
            indicator.className = 'status-indicator status-danger';
            indicator.textContent = 'âš ï¸';
        }

        function hideWarning() {
            document.getElementById('gps-warning').classList.remove('show');
            document.getElementById('manual-warning').classList.remove('show');
            
            // ìƒíƒœ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
            const indicators = [
                document.getElementById('gps-status-indicator'),
                document.getElementById('manual-status-indicator')
            ];
            
            indicators.forEach(indicator => {
                indicator.className = 'status-indicator status-safe';
                indicator.textContent = 'ğŸ“';
            });
        }

        function displayTrainInfo(trainData) {
            const trainList = document.getElementById('train-list');
            const trainItems = document.getElementById('train-items');
            
            if (trainData.length === 0) {
                trainList.style.display = 'none';
                return;
            }
            
            trainItems.innerHTML = '';
            
            trainData.sort((a, b) => {
                if (a.arrivalCode === '0' && b.arrivalCode !== '0') return -1;
                if (b.arrivalCode === '0' && a.arrivalCode !== '0') return 1;
                return 0;
            });
            
            trainData.forEach(train => {
                const trainDiv = document.createElement('div');
                trainDiv.className = `train-item ${train.type}`;
                
                let statusColor = '#4caf50';
                let typeIcon = train.type === 'subway' ? 'ğŸš‡' : 
                              train.type === 'bus' ? 'ğŸšŒ' : 
                              train.type === 'korail' ? 'ğŸš„' : 'ğŸš†';
                
                if (train.arrivalCode === '0' || 
                    train.arrivalMessage?.includes('ì§„ì…') || 
                    train.arrivalMessage?.includes('ê³§')) {
                    statusColor = '#f44336';
                    trainDiv.className += ' urgent';
                } else if (train.arrivalMessage?.includes('1ë¶„') || 
                           train.arrivalMessage?.includes('2ë¶„')) {
                    statusColor = '#ff9800';
                    trainDiv.className += ' warning';
                }
                
                trainDiv.style.borderLeftColor = statusColor;
                
                trainDiv.innerHTML = `
                    <div class="train-line">${typeIcon} ${train.line} - ${train.station}</div>
                    <div class="train-info">
                        ${train.direction || ''} | ${train.destination || 'ëª©ì ì§€'} ë°©ë©´<br>
                        <span style="color:${statusColor};font-weight:bold;">${train.arrivalMessage}</span>
                        ${train.trainNo ? `<br><small>ì—´ì°¨ë²ˆí˜¸: ${train.trainNo}</small>` : ''}
                        ${train.departureStation ? `<br><small>ì¶œë°œì—­: ${train.departureStation}</small>` : ''}
                    </div>
                `;
                trainItems.appendChild(trainDiv);
            });
            
            trainList.style.display = 'block';
        }

        function triggerAlarm() {
            // ì§„ë™ (ëª¨ë°”ì¼ì—ì„œë§Œ ì‘ë™)
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            // ì•ŒëŒìŒ ì¬ìƒ - 3ì´ˆë§Œ ì¬ìƒ
            if (alarmSound) {
                alarmSound.play().catch(e => console.log('ì•ŒëŒìŒ ì¬ìƒ ì‹¤íŒ¨:', e));
                
                setTimeout(() => {
                    if (alarmSound && !alarmSound.paused) {
                        alarmSound.pause();
                        alarmSound.currentTime = 0;
                    }
                }, 3000);
            }
        }

        function stopAlarm() {
            if (alarmSound) {
                alarmSound.pause();
                alarmSound.currentTime = 0;
            }
        }

        function updateMonitoringInfo(stationCount, isManualMode, predictionsCount) {
            const prefix = isManualMode ? 'manual-' : '';
            
            document.getElementById(prefix + 'last-update').textContent = new Date().toLocaleTimeString();
            document.getElementById(prefix + 'active-predictions').textContent = `${predictionsCount}ê°œ`;
            
            const warningStatusElement = document.getElementById(prefix + 'warning-status');
            if (currentWarningState.isActive) {
                const duration = Math.floor((new Date() - currentWarningState.warningStartTime) / 1000);
                warningStatusElement.textContent = `ğŸš¨ ê²½ê³  ì¤‘ (${duration}ì´ˆ)`;
                warningStatusElement.style.color = '#f44336';
                warningStatusElement.style.fontWeight = 'bold';
            } else {
                warningStatusElement.textContent = 'âœ… ì•ˆì „';
                warningStatusElement.style.color = '#4caf50';
                warningStatusElement.style.fontWeight = 'normal';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // ë‘ ì§€ì  ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Earth's radius in meters
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // PWA ì§€ì›ì„ ìœ„í•œ ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // í•„ìš”ì‹œ ì„œë¹„ìŠ¤ ì›Œì»¤ êµ¬í˜„
            });
        }
    </script>
</body>
</html>
