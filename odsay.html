<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>열차 접근 예측 시스템 (교육용)</title>
    
    <meta name="description" content="GPS 기반 시간 예측 열차 안전 경고 시스템 - 교육 및 연구 목적">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            border-radius: 15px;
            color: white;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 13px;
        }

        .education-notice {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }

        .education-notice strong {
            color: #1976d2;
            display: block;
            margin-bottom: 8px;
        }

        .mode-selector {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .status-safe {
            background: #4caf50;
        }

        .status-warning {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        .status-danger {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        #map {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .info-panel {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-panel h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .prediction-panel {
            background: #f3e5f5;
            border: 2px solid #9c27b0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .prediction-panel h3 {
            color: #7b1fa2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .warning-message {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            display: none;
            position: sticky;
            top: 10px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .warning-message.show {
            display: block;
            animation: shake 0.5s ease-in-out, persistentGlow 2s infinite;
        }

        @keyframes persistentGlow {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
                border-color: #ffc107;
            }
            50% { 
                box-shadow: 0 4px 20px rgba(255, 87, 34, 0.5);
                border-color: #ff5722;
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .distance-input, select.distance-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            background: white;
            color: #333;
        }

        select.distance-input {
            cursor: pointer;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="m0 1 2 2 2-2z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 40px;
        }

        .train-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .train-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            font-size: 14px;
        }

        .train-item.subway {
            border-left-color: #2196f3;
        }

        .train-item.korail {
            border-left-color: #ff5722;
        }

        .train-item.bus {
            border-left-color: #4caf50;
        }

        .train-item .train-line {
            font-weight: bold;
            color: #333;
        }

        .train-item .train-info {
            color: #666;
            margin-top: 5px;
        }

        .train-item.urgent {
            animation: urgentPulse 1s infinite;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .train-item.warning {
            animation: warningPulse 2s infinite;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }

        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .prediction-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #9c27b0;
        }

        .prediction-item.imminent {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .prediction-item.warning {
            border-left-color: #ff9800;
            background: #fff8e1;
        }

        .countdown-display {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .countdown-safe { background: #e8f5e8; color: #2e7d32; }
        .countdown-warning { background: #fff3e0; color: #f57c00; }
        .countdown-danger { background: #ffebee; color: #c62828; }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
            margin-top: 30px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>열차 접근 예측 시스템 v3.0</h1>
            <p>GPS + 모의 데이터 기반 시간 예측 경고 (교육용)</p>
        </div>

        <div class="education-notice">
            <strong>교육 및 연구 목적 시스템</strong>
            이 시스템은 교육용 데모입니다. 실제 안전에 의존하지 마세요.<br>
            모든 데이터는 모의 데이터이며 실제 열차 운행과 무관합니다.
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('gps')">GPS 기반 예측</button>
            <button class="mode-btn" onclick="switchMode('manual')">수동 위치 선택</button>
        </div>

        <!-- GPS 기반 모드 -->
        <div id="gps-mode" class="content-section active">
            <div class="status-card">
                <div id="gps-status-indicator" class="status-indicator status-safe">📍</div>
                <h3 id="gps-status-text">GPS 위치 확인 중...</h3>
                <p id="gps-location-text">위치 정보를 가져오고 있습니다</p>
            </div>

            <div class="control-panel">
                <button id="start-monitoring" class="button btn-primary">예측 모니터링 시작</button>
                <button id="stop-monitoring" class="button btn-danger" style="display:none;">모니터링 중지</button>
                <button id="retry-gps" class="button btn-secondary" style="display:none;">GPS 재시도</button>
                
                <div style="margin-top: 15px;">
                    <label for="alert-time">경고 시간 (초):</label>
                    <input type="number" id="alert-time" class="distance-input" value="120" min="30" max="300">
                    
                    <label for="update-interval">갱신 주기:</label>
                    <select id="update-interval" class="distance-input">
                        <option value="5000">5초 (고성능)</option>
                        <option value="10000" selected>10초 (권장)</option>
                        <option value="15000">15초 (균형)</option>
                        <option value="30000">30초 (절약)</option>
                    </select>
                </div>
            </div>

            <div id="gps-warning" class="warning-message"></div>

            <div id="prediction-panel" class="prediction-panel" style="display:none;">
                <h3>열차 접근 예측</h3>
                <div id="countdown-display" class="countdown-display countdown-safe">
                    안전 구간
                </div>
                <div id="predictions-list"></div>
            </div>

            <div class="info-panel">
                <h3>모니터링 정보</h3>
                <div class="info-item">
                    <span>상태:</span>
                    <span id="monitoring-status">대기 중</span>
                </div>
                <div class="info-item">
                    <span>경고 상태:</span>
                    <span id="warning-status">안전</span>
                </div>
                <div class="info-item">
                    <span>마지막 업데이트:</span>
                    <span id="last-update">-</span>
                </div>
                <div class="info-item">
                    <span>근처 역 수:</span>
                    <span id="nearby-stations-count">0</span>
                </div>
                <div class="info-item">
                    <span>활성 예측:</span>
                    <span id="active-predictions">0개</span>
                </div>
            </div>
        </div>

        <!-- 수동 선택 모드 -->
        <div id="manual-mode" class="content-section">
            <div class="status-card">
                <div id="manual-status-indicator" class="status-indicator status-safe">📍</div>
                <h3 id="manual-status-text">위치를 선택해주세요</h3>
                <p>지도에서 모니터링할 위치를 클릭하세요</p>
            </div>

            <div id="map"></div>

            <div class="control-panel">
                <button id="start-manual-monitoring" class="button btn-primary" disabled>선택한 위치 모니터링</button>
                <button id="stop-manual-monitoring" class="button btn-danger" style="display:none;">모니터링 중지</button>
                
                <div style="margin-top: 15px;">
                    <label for="manual-alert-time">경고 시간 (초):</label>
                    <input type="number" id="manual-alert-time" class="distance-input" value="120" min="30" max="300">
                    
                    <label for="manual-update-interval">갱신 주기:</label>
                    <select id="manual-update-interval" class="distance-input">
                        <option value="5000">5초 (고성능)</option>
                        <option value="10000" selected>10초 (권장)</option>
                        <option value="15000">15초 (균형)</option>
                        <option value="30000">30초 (절약)</option>
                    </select>
                </div>
            </div>

            <div id="manual-warning" class="warning-message"></div>

            <div id="manual-prediction-panel" class="prediction-panel" style="display:none;">
                <h3>열차 접근 예측</h3>
                <div id="manual-countdown-display" class="countdown-display countdown-safe">
                    안전 구간
                </div>
                <div id="manual-predictions-list"></div>
            </div>

            <div class="info-panel">
                <h3>모니터링 정보</h3>
                <div class="info-item">
                    <span>상태:</span>
                    <span id="manual-monitoring-status">대기 중</span>
                </div>
                <div class="info-item">
                    <span>경고 상태:</span>
                    <span id="manual-warning-status">안전</span>
                </div>
                <div class="info-item">
                    <span>마지막 업데이트:</span>
                    <span id="manual-last-update">-</span>
                </div>
                <div class="info-item">
                    <span>활성 예측:</span>
                    <span id="manual-active-predictions">0개</span>
                </div>
            </div>

            <div class="info-panel">
                <h3>선택한 위치</h3>
                <div class="info-item">
                    <span>위도:</span>
                    <span id="selected-lat">-</span>
                </div>
                <div class="info-item">
                    <span>경도:</span>
                    <span id="selected-lng">-</span>
                </div>
            </div>
        </div>

        <div class="train-list" id="train-list" style="display:none;">
            <h3>실시간 교통 정보</h3>
            <div id="train-items"></div>
        </div>

        <div class="footer">
            <p><strong>교육용 시스템 안전 경고</strong></p>
            <p>이 시스템은 교육 목적으로만 제작되었습니다.</p>
            <p>실제 안전을 위해서는 항상 현장의 시각적, 청각적 신호를 확인하세요.</p>
        </div>
    </div>

    <!-- 오디오 요소 (알람음) -->
    <audio id="alarm-sound" preload="auto" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMe" type="audio/wav">
    </audio>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // 전역 변수
        let currentPosition = null;
        let selectedPosition = null;
        let map = null;
        let marker = null;
        let monitoringInterval = null;
        let isMonitoring = false;
        let alarmSound = null;
        let nearbyStations = [];
        let activePredictions = [];
        
        // 경고 상태 관리
        let currentWarningState = {
            isActive: false,
            lastWarningTrain: null,
            warningStartTime: null
        };

        // 전국 주요 역사 데이터
        const TRAIN_STATIONS = [
            // 서울 지역
            {name: '서울역', lat: 37.5547, lng: 126.9706, lines: ['1호선', 'KTX', 'SRT', '새마을호', '무궁화호'], type: 'major'},
            {name: '용산역', lat: 37.5297, lng: 126.9645, lines: ['KTX', 'SRT', '새마을호', '무궁화호'], type: 'major'},
            {name: '청량리역', lat: 37.5806, lng: 127.0472, lines: ['1호선', 'KTX', 'ITX-청춘', '무궁화호'], type: 'major'},
            {name: '영등포역', lat: 37.5150, lng: 126.9076, lines: ['1호선', '새마을호', '무궁화호'], type: 'regular'},
            {name: '수서역', lat: 37.4875, lng: 127.1017, lines: ['SRT', '분당선'], type: 'regular'},
            
            // 수도권
            {name: '수원역', lat: 37.2663, lng: 127.0011, lines: ['1호선', 'KTX', '새마을호', '무궁화호'], type: 'major'},
            {name: '안양역', lat: 37.4019, lng: 126.9227, lines: ['1호선', '무궁화호'], type: 'regular'},
            {name: '평택역', lat: 36.9912, lng: 127.0845, lines: ['KTX', '새마을호', '무궁화호'], type: 'regular'},
            
            // 충청권
            {name: '천안아산역', lat: 36.7947, lng: 127.1044, lines: ['KTX'], type: 'major'},
            {name: '대전역', lat: 36.3315, lng: 127.4344, lines: ['KTX', '새마을호', '무궁화호'], type: 'major'},
            {name: '오송역', lat: 36.6156, lng: 127.2900, lines: ['KTX'], type: 'regular'},
            
            // 전라권
            {name: '익산역', lat: 35.9482, lng: 126.9547, lines: ['KTX', '새마을호', '무궁화호'], type: 'major'},
            {name: '광주송정역', lat: 35.1401, lng: 126.7935, lines: ['KTX'], type: 'major'},
            {name: '목포역', lat: 34.7947, lng: 126.3849, lines: ['KTX', '새마을호', '무궁화호'], type: 'major'},
            
            // 경상권
            {name: '김천구미역', lat: 36.1203, lng: 128.3447, lines: ['KTX'], type: 'regular'},
            {name: '대구역', lat: 35.8794, lng: 128.6289, lines: ['새마을호', '무궁화호'], type: 'major'},
            {name: '동대구역', lat: 35.8790, lng: 128.6286, lines: ['KTX', '새마을호', '무궁화호'], type: 'major'},
            {name: '부산역', lat: 35.1155, lng: 129.0422, lines: ['KTX', '새마을호', '무궁화호'], type: 'major'},
            
            // 강원권
            {name: '강릉역', lat: 37.7635, lng: 128.8989, lines: ['KTX'], type: 'major'},
            {name: '춘천역', lat: 37.8853, lng: 127.7181, lines: ['ITX-청춘'], type: 'regular'}
        ];

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('시스템 초기화 시작');
            initializeApp();
        });

        function initializeApp() {
            alarmSound = document.getElementById('alarm-sound');
            initializeMap();
            setupEventListeners();
            requestLocationPermission();
            console.log('시스템 초기화 완료');
        }

        function setupEventListeners() {
            document.getElementById('start-monitoring').addEventListener('click', startGPSMonitoring);
            document.getElementById('stop-monitoring').addEventListener('click', stopGPSMonitoring);
            document.getElementById('retry-gps').addEventListener('click', requestLocationPermission);
            
            document.getElementById('start-manual-monitoring').addEventListener('click', startManualMonitoring);
            document.getElementById('stop-manual-monitoring').addEventListener('click', stopManualMonitoring);
        }

        function switchMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            if (mode === 'gps') {
                document.getElementById('gps-mode').classList.add('active');
            } else {
                document.getElementById('manual-mode').classList.add('active');
            }
            
            if (isMonitoring) {
                stopAllMonitoring();
            }
        }

        function initializeMap() {
            map = L.map('map').setView([37.5665, 126.9780], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', function(e) {
                setSelectedPosition(e.latlng.lat, e.latlng.lng);
            });

            // 역사 마커 추가
            TRAIN_STATIONS.forEach(station => {
                let markerColor = station.type === 'major' ? '#FF5722' : '#2196F3';
                let markerSize = station.type === 'major' ? 12 : 8;
                
                const stationMarker = L.marker([station.lat, station.lng])
                    .bindPopup(`<b>${station.name}</b><br>${station.lines.join(', ')}<br><small>(${station.type === 'major' ? '주요역' : '일반역'})</small>`)
                    .addTo(map);
                
                stationMarker.setIcon(L.divIcon({
                    html: `<div style="background:${markerColor};width:${markerSize}px;height:${markerSize}px;border-radius:50%;border:2px solid white;"></div>`,
                    iconSize: [markerSize + 4, markerSize + 4],
                    className: 'train-station-marker'
                }));
            });
        }

        function requestLocationPermission() {
            if (!navigator.geolocation) {
                updateGPSStatus('GPS 미지원', '이 브라우저는 GPS를 지원하지 않습니다');
                document.getElementById('retry-gps').style.display = 'block';
                return;
            }

            document.getElementById('gps-status-text').textContent = 'GPS 권한 요청 중...';
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 300000
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    updateGPSStatus('위치 확인 완료', `위도: ${currentPosition.lat.toFixed(6)}, 경도: ${currentPosition.lng.toFixed(6)}`);
                    console.log(`GPS 위치 확인: ${currentPosition.lat}, ${currentPosition.lng} (정확도: ${position.coords.accuracy}m)`);
                    
                    findNearbyStations(currentPosition);
                    document.getElementById('retry-gps').style.display = 'none';
                },
                function(error) {
                    let errorMsg = 'GPS 오류: ';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += '위치 권한이 거부되었습니다';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += '위치 정보를 사용할 수 없습니다';
                            break;
                        case error.TIMEOUT:
                            errorMsg += '위치 요청 시간이 초과되었습니다';
                            break;
                        default:
                            errorMsg += '알 수 없는 오류가 발생했습니다';
                            break;
                    }
                    
                    updateGPSStatus('GPS 오류', errorMsg);
                    document.getElementById('retry-gps').style.display = 'block';
                },
                options
            );
        }

        function updateGPSStatus(status, location) {
            document.getElementById('gps-status-text').textContent = status;
            document.getElementById('gps-location-text').textContent = location;
        }

        function setSelectedPosition(lat, lng) {
            selectedPosition = { lat: lat, lng: lng };
            
            if (marker) {
                map.removeLayer(marker);
            }
            
            marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup('선택한 위치').openPopup();
            
            document.getElementById('selected-lat').textContent = lat.toFixed(6);
            document.getElementById('selected-lng').textContent = lng.toFixed(6);
            document.getElementById('start-manual-monitoring').disabled = false;
            document.getElementById('manual-status-text').textContent = '위치 선택 완료';
            
            findNearbyStations(selectedPosition);
        }

        function findNearbyStations(position) {
            nearbyStations = TRAIN_STATIONS.filter(station => {
                const distance = calculateDistance(position.lat, position.lng, station.lat, station.lng);
                return distance <= 10000; // 10km 이내
            }).map(station => ({
                ...station,
                distance: calculateDistance(position.lat, position.lng, station.lat, station.lng)
            })).sort((a, b) => a.distance - b.distance);

            console.log(`근처 역 ${nearbyStations.length}개 발견:`);
            nearbyStations.slice(0, 5).forEach(station => {
                console.log(`  ${station.name}: ${Math.round(station.distance)}m`);
            });

            document.getElementById('nearby-stations-count').textContent = nearbyStations.length;
        }

        function startGPSMonitoring() {
            if (!currentPosition) {
                alert('GPS 위치 정보가 필요합니다');
                return;
            }
            
            startMonitoring(currentPosition, false);
        }

        function startManualMonitoring() {
            if (!selectedPosition) {
                alert('지도에서 위치를 선택해주세요');
                return;
            }
            
            startMonitoring(selectedPosition, true);
        }

        function startMonitoring(position, isManualMode) {
            isMonitoring = true;
            
            const prefix = isManualMode ? 'manual-' : '';
            
            document.getElementById(prefix.replace('-', '') + 'start-monitoring').style.display = 'none';
            document.getElementById(prefix.replace('-', '') + 'stop-monitoring').style.display = 'block';
            document.getElementById(prefix + 'monitoring-status').textContent = '예측 모니터링 중';
            document.getElementById(prefix + 'prediction-panel').style.display = 'block';
            
            const updateInterval = parseInt(document.getElementById(prefix + 'update-interval').value);
            
            console.log(`모니터링 시작 - 위치: ${position.lat}, ${position.lng}, 갱신주기: ${updateInterval}ms`);
            
            monitoringInterval = setInterval(() => {
                performTrainPrediction(position, isManualMode);
            }, updateInterval);
            
            performTrainPrediction(position, isManualMode);
        }

        function stopGPSMonitoring() {
            stopAllMonitoring();
            document.getElementById('start-monitoring').style.display = 'block';
            document.getElementById('stop-monitoring').style.display = 'none';
            document.getElementById('monitoring-status').textContent = '대기 중';
            document.getElementById('prediction-panel').style.display = 'none';
        }

        function stopManualMonitoring() {
            stopAllMonitoring();
            document.getElementById('start-manual-monitoring').style.display = 'block';
            document.getElementById('stop-manual-monitoring').style.display = 'none';
            document.getElementById('manual-monitoring-status').textContent = '대기 중';
            document.getElementById('manual-prediction-panel').style.display = 'none';
        }

        function stopAllMonitoring() {
            isMonitoring = false;
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            hideWarning();
            stopAlarm();
            currentWarningState.isActive = false;
            
            activePredictions = [];
            document.getElementById('train-list').style.display = 'none';
            
            console.log('모니터링 중지');
        }

        function performTrainPrediction(position, isManualMode) {
            const alertTime = parseInt(
                isManualMode ? 
                document.getElementById('manual-alert-time').value : 
                document.getElementById('alert-time').value
            );
            
            console.log(`예측 수행 - 경고시간: ${alertTime}초`);
            
            // 근처 역사들에 대해 모의 데이터 생성
            const stationsToCheck = nearbyStations.length > 0 ? 
                nearbyStations.filter(station => station.distance <= 5000).slice(0, 3) :
                TRAIN_STATIONS.filter(station => {
                    const distance = calculateDistance(position.lat, position.lng, station.lat, station.lng);
                    return distance <= 5000;
                }).slice(0, 3);

            let allTrainData = [];
            let allPredictions = [];

            stationsToCheck.forEach(station => {
                const stationTrains = generateMockTrainData(station);
                allTrainData = [...allTrainData, ...stationTrains];
                
                stationTrains.forEach(train => {
                    const prediction = predictTrainPassingTime(train, station, position);
                    if (prediction && prediction.timeToPass <= alertTime * 3) {
                        allPredictions.push(prediction);
                    }
                });
            });

            allPredictions.sort((a, b) => a.timeToPass - b.timeToPass);
            activePredictions = allPredictions;

            console.log(`총 ${allTrainData.length}개 열차, ${allPredictions.length}개 예측 생성`);

            // 경고 처리
            const imminentTrains = allPredictions.filter(p => p.timeToPass <= alertTime);
            
            if (imminentTrains.length > 0) {
                if (!currentWarningState.isActive) {
                    currentWarningState.isActive = true;
                    currentWarningState.warningStartTime = new Date();
                    triggerAlarm();
                }
                
                currentWarningState.lastWarningTrain = imminentTrains[0];
                showPredictionWarning(imminentTrains, isManualMode);
                
            } else {
                if (currentWarningState.isActive) {
                    hideWarning();
                    currentWarningState.isActive = false;
                    stopAlarm();
                }
            }

            // UI 업데이트
            displayPredictions(allPredictions, isManualMode);
            displayTrainInfo(allTrainData);
            updateMonitoringInfo(stationsToCheck.length, isManualMode, allPredictions.length);
        }

        function generateMockTrainData(station) {
            const trains = [];
            const hour = new Date().getHours();
            
            // 시간대별 운행 확률
            let probability = 0.7;
            if (hour >= 6 && hour <= 9) probability = 0.9;
            else if (hour >= 17 && hour <= 20) probability = 0.9;
            else if (hour >= 23 || hour <= 5) probability = 0.4;
            
            if (Math.random() > probability) {
                return trains;
            }

            // 역 타입별 열차 수
            const maxTrains = station.type === 'major' ? 6 : 3;
            const numTrains = Math.floor(Math.random() * maxTrains) + 1;

            for (let i = 0; i < numTrains; i++) {
                const trainType = selectTrainType(station.lines);
                const train = {
                    type: getTrainCategory(trainType),
                    station: station.name,
                    line: trainType,
                    trainNo: generateTrainNumber(trainType),
                    direction: Math.random() > 0.5 ? '상행' : '하행',
                    destination: getDestination(trainType),
                    arrivalMinutes: Math.floor(Math.random() * 60) + 1,
                    timestamp: new Date().toISOString()
                };
                
                train.arrivalMessage = `${train.arrivalMinutes}분 후 ${Math.random() > 0.5 ? '도착' : '통과'}`;
                train.arrivalCode = train.arrivalMinutes <= 10 ? '0' : '1';
                
                trains.push(train);
            }

            console.log(`${station.name}에 ${trains.length}개 열차 생성`);
            return trains;
        }

        function selectTrainType(availableLines) {
            // 지하철 노선
            const subwayLines = ['1호선', '2호선', '3호선', '4호선', '5호선', '6호선', '7호선', '8호선', '9호선'];
            const subwayInStation = availableLines.filter(line => subwayLines.includes(line));
            
            // 코레일 노선
            const korailLines = ['KTX', 'SRT', '새마을호', '무궁화호', 'ITX-청춘'];
            const korailInStation = availableLines.filter(line => korailLines.includes(line));
            
            // 버스 (모든 역에서 가능)
            const busTypes = ['간선버스', '지선버스', '마을버스', '광역버스'];
            
            // 가중치 기반 선택
            const allOptions = [
                ...subwayInStation.map(line => ({type: line, weight: 0.4})),
                ...korailInStation.map(line => ({type: line, weight: 0.4})),
                ...busTypes.map(type => ({type: type, weight: 0.2}))
            ];
            
            if (allOptions.length === 0) {
                return '간선버스';
            }
            
            const totalWeight = allOptions.reduce((sum, opt) => sum + opt.weight, 0);
            let random = Math.random() * totalWeight;
            
            for (const option of allOptions) {
                random -= option.weight;
                if (random <= 0) {
                    return option.type;
                }
            }
            
            return allOptions[0].type;
        }

        function getTrainCategory(trainType) {
            const subwayLines = ['1호선', '2호선', '3호선', '4호선', '5호선', '6호선', '7호선', '8호선', '9호선'];
            const korailLines = ['KTX', 'SRT', '새마을호', '무궁화호', 'ITX-청춘'];
            
            if (subwayLines.includes(trainType)) return 'subway';
            if (korailLines.includes(trainType)) return 'korail';
            return 'bus';
        }

        function generateTrainNumber(trainType) {
            const prefixes = {
                'KTX': '1',
                'SRT': '5',
                '새마을호': '3',
                '무궁화호': '8',
                'ITX-청춘': '2'
            };
            
            if (prefixes[trainType]) {
                const prefix = prefixes[trainType];
                const number = Math.floor(Math.random() * 999).toString().padStart(3, '0');
                return prefix + number;
            }
            
            // 지하철이나 버스
            return Math.floor(Math.random() * 9999) + 1;
        }

        function getDestination(trainType) {
            const destinations = {
                'KTX': ['부산', '대구동대구', '광주송정', '목포', '강릉'],
                'SRT': ['부산', '대전', '동대구', '목포'],
                '새마을호': ['부산', '대전', '대구', '광주', '목포', '여수'],
                '무궁화호': ['부산', '대전', '대구', '광주', '목포', '춘천', '강릉'],
                'ITX-청춘': ['춘천', '강릉'],
                '1호선': ['인천', '신도림', '동묘앞', '청량리'],
                '2호선': ['잠실', '강남', '홍대입구', '신도림'],
                '간선버스': ['강남터미널', '잠실', '홍대입구', '명동'],
                '지선버스': ['시청', '종로', '동대문', '을지로'],
                '마을버스': ['마을회관', '주민센터', '시장'],
                '광역버스': ['인천', '부천', '안양', '성남']
            };
            
            const dests = destinations[trainType] || ['터미널'];
            return dests[Math.floor(Math.random() * dests.length)];
        }

        function predictTrainPassingTime(train, station, gpsPosition) {
            const distanceToGPS = calculateDistance(
                gpsPosition.lat, gpsPosition.lng,
                station.lat, station.lng
            );
            
            // 기본 속도 (km/h)
            const speeds = {
                'subway': 35,
                'korail': 80,
                'bus': 25
            };
            
            const speed = speeds[train.type] || 30;
            
            // 열차가 역에 도착하는 시간 (분)
            const timeToStation = train.arrivalMinutes;
            
            // 역에서 GPS 위치까지 추가 시간 (분)
            let additionalTime = 0;
            if (distanceToGPS > 500) {
                const additionalDistance = (distanceToGPS - 500) / 1000; // km
                additionalTime = (additionalDistance / speed) * 60; // 분
            }
            
            const totalTimeMinutes = timeToStation + additionalTime;
            const totalTimeSeconds = totalTimeMinutes * 60;
            
            if (totalTimeSeconds < 0) return null;
            
            return {
                train: train,
                station: station,
                timeToPass: Math.round(totalTimeSeconds),
                confidence: Math.max(70, 95 - Math.floor(distanceToGPS / 100)),
                estimatedLocation: `${train.arrivalMinutes}분 거리`,
                gpsDistance: Math.round(distanceToGPS)
            };
        }

        function displayPredictions(predictions, isManualMode) {
            const prefix = isManualMode ? 'manual-' : '';
            const countdownElement = document.getElementById(prefix + 'countdown-display');
            const predictionsList = document.getElementById(prefix + 'predictions-list');
            
            if (predictions.length === 0) {
                countdownElement.textContent = '안전 구간';
                countdownElement.className = 'countdown-display countdown-safe';
                predictionsList.innerHTML = '<div style="text-align: center; color: #666;">근처에 접근하는 열차가 없습니다</div>';
                return;
            }
            
            const closestTrain = predictions[0];
            const minutes = Math.floor(closestTrain.timeToPass / 60);
            const seconds = closestTrain.timeToPass % 60;
            const timeDisplay = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${seconds}초`;
            
            countdownElement.textContent = `${timeDisplay} - ${closestTrain.train.line}`;
            
            if (closestTrain.timeToPass <= 60) {
                countdownElement.className = 'countdown-display countdown-danger';
            } else if (closestTrain.timeToPass <= 120) {
                countdownElement.className = 'countdown-display countdown-warning';
            } else {
                countdownElement.className = 'countdown-display countdown-safe';
            }
            
            predictionsList.innerHTML = '';
            predictions.slice(0, 5).forEach(prediction => {
                const predictionDiv = document.createElement('div');
                predictionDiv.className = 'prediction-item';
                
                if (prediction.timeToPass <= 60) {
                    predictionDiv.className += ' imminent';
                } else if (prediction.timeToPass <= 120) {
                    predictionDiv.className += ' warning';
                }
                
                const minutes = Math.floor(prediction.timeToPass / 60);
                const seconds = prediction.timeToPass % 60;
                const timeDisplay = minutes > 0 ? `${minutes}분 ${seconds}초` : `${seconds}초`;
                
                const typeIcon = prediction.train.type === 'subway' ? '🚇' : 
                                prediction.train.type === 'korail' ? '🚄' : '🚌';
                
                predictionDiv.innerHTML = `
                    <div style="font-weight: bold;">${typeIcon} ${prediction.train.line} - ${prediction.station.name}</div>
                    <div style="margin-top: 5px; color: #666;">
                        <strong>통과 예상: ${timeDisplay}</strong><br>
                        현재 위치: ${prediction.estimatedLocation}<br>
                        신뢰도: ${prediction.confidence}% | GPS 거리: ${prediction.gpsDistance}m
                    </div>
                `;
                
                predictionsList.appendChild(predictionDiv);
            });
        }

        function showPredictionWarning(imminentTrains, isManualMode) {
            const warningElement = isManualMode ? 
                document.getElementById('manual-warning') : 
                document.getElementById('gps-warning');
            
            const urgentTrain = imminentTrains[0];
            const timeLeft = urgentTrain.timeToPass;
            
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeDisplay = minutes > 0 ? `${minutes}분 ${seconds}초` : `${seconds}초`;
            
            const typeIcon = urgentTrain.train.type === 'subway' ? '🚇' : 
                            urgentTrain.train.type === 'korail' ? '🚄' : '🚌';
            
            warningElement.innerHTML = `
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">
                    ⚠️ 열차 접근 경고!
                </div>
                <div>${typeIcon} ${urgentTrain.train.line} - ${urgentTrain.station.name}</div>
                <div style="font-size: 18px; font-weight: bold; margin-top: 8px; color: #d32f2f;">
                    ${timeDisplay} 후 통과 예상
                </div>
                <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">
                    현재 위치: ${urgentTrain.estimatedLocation} (신뢰도: ${urgentTrain.confidence}%)
                </div>
            `;
            
            warningElement.classList.add('show');
            
            const indicator = isManualMode ? 
                document.getElementById('manual-status-indicator') : 
                document.getElementById('gps-status-indicator');
            
            indicator.className = 'status-indicator status-danger';
            indicator.textContent = '⚠️';
        }

        function hideWarning() {
            document.getElementById('gps-warning').classList.remove('show');
            document.getElementById('manual-warning').classList.remove('show');
            
            const indicators = [
                document.getElementById('gps-status-indicator'),
                document.getElementById('manual-status-indicator')
            ];
            
            indicators.forEach(indicator => {
                indicator.className = 'status-indicator status-safe';
                indicator.textContent = '📍';
            });
        }

        function displayTrainInfo(trainData) {
            const trainList = document.getElementById('train-list');
            const trainItems = document.getElementById('train-items');
            
            if (trainData.length === 0) {
                trainList.style.display = 'none';
                return;
            }
            
            trainItems.innerHTML = '';
            
            trainData.sort((a, b) => a.arrivalMinutes - b.arrivalMinutes);
            
            trainData.forEach(train => {
                const trainDiv = document.createElement('div');
                trainDiv.className = `train-item ${train.type}`;
                
                let statusColor = '#4caf50';
                let typeIcon = train.type === 'subway' ? '🚇' : 
                              train.type === 'korail' ? '🚄' : '🚌';
                
                if (train.arrivalMinutes <= 5) {
                    statusColor = '#f44336';
                    trainDiv.className += ' urgent';
                } else if (train.arrivalMinutes <= 10) {
                    statusColor = '#ff9800';
                    trainDiv.className += ' warning';
                }
                
                trainDiv.style.borderLeftColor = statusColor;
                
                trainDiv.innerHTML = `
                    <div class="train-line">${typeIcon} ${train.line} - ${train.station}</div>
                    <div class="train-info">
                        ${train.direction} | ${train.destination} 방면<br>
                        <span style="color:${statusColor};font-weight:bold;">${train.arrivalMessage}</span>
                        ${train.trainNo ? `<br><small>열차번호: ${train.trainNo}</small>` : ''}
                    </div>
                `;
                trainItems.appendChild(trainDiv);
            });
            
            trainList.style.display = 'block';
        }

        function triggerAlarm() {
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            if (alarmSound) {
                alarmSound.play().catch(e => console.log('알람음 재생 실패:', e));
                
                setTimeout(() => {
                    if (alarmSound && !alarmSound.paused) {
                        alarmSound.pause();
                        alarmSound.currentTime = 0;
                    }
                }, 3000);
            }
        }

        function stopAlarm() {
            if (alarmSound) {
                alarmSound.pause();
                alarmSound.currentTime = 0;
            }
        }

        function updateMonitoringInfo(stationCount, isManualMode, predictionsCount) {
            const prefix = isManualMode ? 'manual-' : '';
            
            document.getElementById(prefix + 'last-update').textContent = new Date().toLocaleTimeString();
            document.getElementById(prefix + 'active-predictions').textContent = `${predictionsCount}개`;
            
            const warningStatusElement = document.getElementById(prefix + 'warning-status');
            if (currentWarningState.isActive) {
                const duration = Math.floor((new Date() - currentWarningState.warningStartTime) / 1000);
                warningStatusElement.textContent = `경고 중 (${duration}초)`;
                warningStatusElement.style.color = '#f44336';
                warningStatusElement.style.fontWeight = 'bold';
            } else {
                warningStatusElement.textContent = '안전';
                warningStatusElement.style.color = '#4caf50';
                warningStatusElement.style.fontWeight = 'normal';
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }
    </script>
</body>
</html>
