<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기차 안전 경고 시스템</title>
    
    <!-- HTTPS 필수 알림 -->
    <meta name="description" content="GPS 기반 기차 안전 경고 시스템 - HTTPS 환경 필요">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            border-radius: 15px;
            color: white;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .https-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .https-warning.show {
            display: block;
        }

        .https-warning.hide {
            display: none;
        }

        .mode-selector {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .status-safe {
            background: #4caf50;
        }

        .status-warning {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        .status-danger {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        #map {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .info-panel {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-panel h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .warning-message {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            display: none;
            position: sticky;
            top: 10px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .warning-message.show {
            display: block;
            animation: shake 0.5s ease-in-out, persistentGlow 2s infinite;
        }

        @keyframes persistentGlow {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
                border-color: #ffc107;
            }
            50% { 
                box-shadow: 0 4px 20px rgba(255, 87, 34, 0.5);
                border-color: #ff5722;
            }
        }

        .warning-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .warning-time {
            font-size: 12px;
            opacity: 0.8;
            font-weight: normal;
        }

        .train-item.urgent {
            animation: urgentPulse 1s infinite;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .train-item.warning {
            animation: warningPulse 2s infinite;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }

        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .distance-input, select.distance-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            background: white;
            color: #333;
        }

        select.distance-input {
            cursor: pointer;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="m0 1 2 2 2-2z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 40px;
        }

        .train-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .train-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            font-size: 14px;
        }

        .train-item.subway {
            border-left-color: #2196f3;
        }

        .train-item.korail {
            border-left-color: #ff5722;
        }

        .train-item .train-line {
            font-weight: bold;
            color: #333;
        }

        .train-item .train-info {
            color: #666;
            margin-top: 5px;
        }

        .train-item .train-distance {
            color: #ff6b6b;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #c62828;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
            margin-top: 30px;
        }

        .nearby-stations {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }

        .station-item {
            background: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 5px;
            font-size: 13px;
            border-left: 3px solid #4caf50;
        }

        .gps-debug {
            background: #e1f5fe;
            border: 1px solid #b3e5fc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #01579b;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚆 기차 접근 알림 v1.3</h1>
            <p>GPS 기반 실시간 안전 모니터링</p>
        </div>

        <!-- HTTPS 경고 -->
        <div id="https-warning" class="https-warning">
            <strong>⚠️ 중요!</strong><br>
            GPS 기능을 사용하려면 <strong>HTTPS 환경</strong>이 필요합니다.<br>
            <small>GitHub Pages에 배포하면 자동으로 HTTPS가 적용됩니다.</small>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('gps')">GPS 기반 경고</button>
            <button class="mode-btn" onclick="switchMode('manual')">수동 위치 선택</button>
        </div>

        <!-- GPS 기반 모드 -->
        <div id="gps-mode" class="content-section active">
            <div class="status-card">
                <div id="gps-status-indicator" class="status-indicator status-safe">📍</div>
                <h3 id="gps-status-text">GPS 위치 확인 중...</h3>
                <p id="gps-location-text">위치 정보를 가져오고 있습니다</p>
            </div>

            <!-- GPS 디버그 정보 -->
            <div id="gps-debug" class="gps-debug" style="display:none;">
                <strong>GPS 디버그 정보:</strong><br>
                <span id="debug-info">확인 중...</span>
            </div>

            <div class="control-panel">
                <button id="start-monitoring" class="button btn-primary">모니터링 시작</button>
                <button id="stop-monitoring" class="button btn-danger" style="display:none;">모니터링 중지</button>
                <button id="retry-gps" class="button btn-secondary" style="display:none;">GPS 재시도</button>
                
                <div style="margin-top: 15px;">
                    <label for="alert-distance">경고 거리 (미터):</label>
                    <input type="number" id="alert-distance" class="distance-input" value="500" min="100" max="2000">
                    
                    <label for="update-interval">갱신 주기:</label>
                    <select id="update-interval" class="distance-input" style="height: 50px;">
                        <option value="5000">⚡ 5초 (고성능)</option>
                        <option value="10000">🔥 10초 (빠름)</option>
                        <option value="20000">⚖️ 20초 (균형)</option>
                        <option value="30000" selected>🔋 30초 (절약)</option>
                        <option value="60000">💤 60초 (저전력)</option>
                    </select>
                </div>
            </div>

            <div id="gps-warning" class="warning-message">
                <!-- JavaScript에서 동적으로 내용 생성 -->
            </div>

            <div class="info-panel">
                <h3>📊 모니터링 정보</h3>
                <div class="info-item">
                    <span>상태:</span>
                    <span id="monitoring-status">대기 중</span>
                </div>
                <div class="info-item">
                    <span>경고 상태:</span>
                    <span id="warning-status">안전</span>
                </div>
                <div class="info-item">
                    <span>갱신 주기:</span>
                    <span id="current-interval">30초</span>
                </div>
                <div class="info-item">
                    <span>마지막 업데이트:</span>
                    <span id="last-update">-</span>
                </div>
                <div class="info-item">
                    <span>근처 역 수:</span>
                    <span id="nearby-stations-count">0</span>
                </div>
                <div class="info-item">
                    <span>감지된 철도 노선:</span>
                    <span id="detected-lines">0개</span>
                </div>
            </div>

            <div id="nearby-stations" class="nearby-stations" style="display:none;">
                <h4>📍 근처 지하철역</h4>
                <div id="stations-list"></div>
            </div>
        </div>

        <!-- 수동 선택 모드 -->
        <div id="manual-mode" class="content-section">
            <div class="status-card">
                <div id="manual-status-indicator" class="status-indicator status-safe">📍</div>
                <h3 id="manual-status-text">위치를 선택해주세요</h3>
                <p>지도에서 모니터링할 위치를 클릭하세요</p>
            </div>

            <div id="map"></div>

            <div class="control-panel">
                <button id="start-manual-monitoring" class="button btn-primary" disabled>선택한 위치 모니터링</button>
                <button id="stop-manual-monitoring" class="button btn-danger" style="display:none;">모니터링 중지</button>
                
                <div style="margin-top: 15px;">
                    <label for="manual-alert-distance">경고 거리 (미터):</label>
                    <input type="number" id="manual-alert-distance" class="distance-input" value="500" min="100" max="2000">
                    
                    <label for="manual-update-interval">갱신 주기:</label>
                    <select id="manual-update-interval" class="distance-input" style="height: 50px;">
                        <option value="5000">⚡ 5초 (고성능)</option>
                        <option value="10000">🔥 10초 (빠름)</option>
                        <option value="20000">⚖️ 20초 (균형)</option>
                        <option value="30000" selected>🔋 30초 (절약)</option>
                        <option value="60000">💤 60초 (저전력)</option>
                    </select>
                </div>
            </div>

            <div id="manual-warning" class="warning-message">
                <!-- JavaScript에서 동적으로 내용 생성 -->
            </div>

            <div class="info-panel">
                <h3>📊 모니터링 정보</h3>
                <div class="info-item">
                    <span>상태:</span>
                    <span id="manual-monitoring-status">대기 중</span>
                </div>
                <div class="info-item">
                    <span>경고 상태:</span>
                    <span id="manual-warning-status">안전</span>
                </div>
                <div class="info-item">
                    <span>갱신 주기:</span>
                    <span id="manual-current-interval">30초</span>
                </div>
                <div class="info-item">
                    <span>마지막 업데이트:</span>
                    <span id="manual-last-update">-</span>
                </div>
                <div class="info-item">
                    <span>근처 역 수:</span>
                    <span id="manual-nearby-stations-count">0</span>
                </div>
                <div class="info-item">
                    <span>감지된 철도 노선:</span>
                    <span id="manual-detected-lines">0개</span>
                </div>
            </div>

            <div class="info-panel">
                <h3>📍 선택한 위치</h3>
                <div class="info-item">
                    <span>위도:</span>
                    <span id="selected-lat">-</span>
                </div>
                <div class="info-item">
                    <span>경도:</span>
                    <span id="selected-lng">-</span>
                </div>
                <div class="info-item">
                    <span>주소:</span>
                    <span id="selected-address">-</span>
                </div>
            </div>
        </div>

        <div class="train-list" id="train-list" style="display:none;">
            <h3>🚆 실시간 열차 정보</h3>
            <div id="train-items"></div>
        </div>

        <div id="error-display" class="error-message" style="display:none;"></div>

        <div class="footer">
            <p>안전을 위한 참고용으로만 사용해주세요</p>
            <p>© 2025 Train Safety Alert System</p>
        </div>
    </div>

    <!-- 오디오 요소 (알람음) -->
    <audio id="alarm-sound" preload="auto" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMe" type="audio/wav">
    </audio>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

<script>
    // 제공된 API 키를 변수로 저장
    const seoulSubwayApiKey = '4a4d5943506f73633531764f4d6854';
    const korailApiKey = 'b94e2e220ed1c348f7fe613a70da4ac557a1888a5d25f0e6e3d0e91e41ce4618';

    // 전역 변수
    let currentPosition = null;
    let selectedPosition = null;
    let map = null;
    let marker = null;
    let monitoringInterval = null;
    let isMonitoring = false;
    let alarmSound = null;
    let allStations = []; // 동적 로딩된 모든 역 정보

    // 초기화 및 이벤트 리스너
    document.addEventListener('DOMContentLoaded', () => {
        const warningElement = document.getElementById('https-warning');
        if (window.location.protocol !== 'https:') {
            warningElement.style.display = 'block';
        } else {
            warningElement.style.display = 'none';
        }
        initializeMap();
        initializeApp();
    });

    // 지도 초기화
    function initializeMap() {
        if (!map) {
            map = L.map('map').setView([37.5665, 126.9780], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            map.on('click', function(e) {
                if (document.getElementById('manual-mode').style.display === 'block') {
                    handleManualClick(e.latlng);
                }
            });
        }
    }

    // 모든 역 정보를 가져오는 함수
    async function fetchAllStations() {
        console.log("모든 역 정보 로딩 중...");
        try {
            // 서울시 지하철 API 호출 (샘플 URL)
            const seoulUrl = `http://openAPI.seoul.go.kr:8088/${seoulSubwayApiKey}/json/SearchInfoBySubwayNameService/1/1000/`;
            const seoulResponse = await fetch(seoulUrl);
            const seoulData = await seoulResponse.json();

            // 코레일 API 호출 (샘플 URL)
            const korailUrl = `http://apis.data.go.kr/3011000/TrainSttnInfoService/getTrainSttnInfo?serviceKey=${korailApiKey}&pageNo=1&numOfRows=1000&_type=json`;
            const korailResponse = await fetch(korailUrl);
            const korailData = await korailResponse.json();

            // API 응답에서 역 정보를 파싱하여 allStations 배열에 추가
            if (seoulData.SearchInfoBySubwayNameService && seoulData.SearchInfoBySubwayNameService.row) {
                seoulData.SearchInfoBySubwayNameService.row.forEach(station => {
                    allStations.push({ name: station.STATION_NM, lat: parseFloat(station.X_COORD), lng: parseFloat(station.Y_COORD), type: 'subway' });
                });
            }
            if (korailData.response && korailData.response.body && korailData.response.body.items && korailData.response.body.items.item) {
                korailData.response.body.items.item.forEach(station => {
                    allStations.push({ name: station.sttnNm, lat: parseFloat(station.sttnLat), lng: parseFloat(station.sttnLon), type: 'korail' });
                });
            }
            
            console.log("모든 역 정보 로딩 완료. 총 역 개수:", allStations.length);
        } catch (error) {
            console.error("역 정보 로딩 실패:", error);
            showError("역 정보를 불러오는 데 실패했습니다. 잠시 후 다시 시도해주세요.");
        }
    }

    // 두 지점 간의 거리 계산 (미터 단위)
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371e3; // Earth's radius in meters
        const φ1 = lat1 * Math.PI/180;
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lng2-lng1) * Math.PI/180;
        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // GPS 위치를 사용하여 가장 가까운 역을 찾는 함수
    function findNearestStation(lat, lng) {
        let minDistance = Infinity;
        let nearestStation = null;

        for (const station of allStations) {
            const distance = calculateDistance(lat, lng, station.lat, station.lng);
            if (distance < minDistance) {
                minDistance = distance;
                nearestStation = station;
            }
        }
        return { ...nearestStation, distance: minDistance };
    }

    // GPS 수신 성공 시 호출되는 함수
    function onGPSSuccess(position) {
        currentPosition = position;
        const { latitude, longitude } = position.coords;
        updateAutoDashboard(latitude, longitude);
        updateWarningSystem(latitude, longitude);
    }

    // GPS 수신 실패 시 호출되는 함수
    function onGPSFailure(error) {
        console.error("GPS 오류:", error);
        showError("GPS 위치를 가져오는 데 실패했습니다. 위치 정보가 켜져 있는지 확인해주세요.");
        stopMonitoring();
    }
    
    // GPS 모니터링 시작
    function startGPSMonitoring() {
        if (!isMonitoring) {
            isMonitoring = true;
            monitoringInterval = navigator.geolocation.watchPosition(onGPSSuccess, onGPSFailure, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
            document.getElementById('start-gps-btn').textContent = 'GPS 모니터링 중지';
            document.getElementById('start-gps-btn').classList.add('active');
            console.log("GPS 모니터링 시작");
        } else {
            stopGPSMonitoring();
        }
    }
    
    // GPS 모니터링 중지
    function stopGPSMonitoring() {
        if (isMonitoring && monitoringInterval) {
            navigator.geolocation.clearWatch(monitoringInterval);
            isMonitoring = false;
            document.getElementById('start-gps-btn').textContent = 'GPS 모니터링 시작';
            document.getElementById('start-gps-btn').classList.remove('active');
            console.log("GPS 모니터링 중지");
            updateAutoDashboard(null, null);
        }
    }

    // 자동 모드 대시보드 업데이트
    function updateAutoDashboard(lat, lng) {
        if (lat && lng) {
            const result = findNearestStation(lat, lng);
            document.getElementById('gps-status-text').textContent = '위치 확인 완료';
            document.getElementById('gps-location-text').textContent = `위도: ${lat.toFixed(6)}, 경도: ${lng.toFixed(6)}`;
            document.getElementById('nearest-station-auto').textContent = `가장 가까운 역: ${result.name} (${Math.round(result.distance)}m)`;
            document.getElementById('auto-warning-status').textContent = '✅ 안전';
        } else {
            document.getElementById('gps-status-text').textContent = 'GPS 모니터링 중지됨';
            document.getElementById('gps-location-text').textContent = '-';
            document.getElementById('nearest-station-auto').textContent = '-';
            document.getElementById('auto-warning-status').textContent = '-';
        }
    }
    
    // 수동 모드 대시보드 업데이트
    function updateManualDashboard(lat, lng, name, distance) {
        document.getElementById('manual-location-text').textContent = `위도: ${lat.toFixed(6)}, 경도: ${lng.toFixed(6)}`;
        document.getElementById('selected-station-name').textContent = `선택된 역: ${name}`;
        document.getElementById('manual-warning-status').textContent = `거리: ${Math.round(distance)}m`;
        updateManualWarningSystem(distance);
    }
    
    // 수동 모드 경고 시스템
    function updateManualWarningSystem(distance) {
        const manualWarningStatusElement = document.getElementById('manual-warning-status');
        const warningDistance = 3000; // 3km
        if (distance < warningDistance) {
            manualWarningStatusElement.textContent = `🚨 경고: ${Math.round(distance)}m 근접`;
            manualWarningStatusElement.style.color = 'red';
            manualWarningStatusElement.style.fontWeight = 'bold';
        } else {
            manualWarningStatusElement.textContent = '✅ 안전';
            manualWarningStatusElement.style.color = '#4caf50';
            manualWarningStatusElement.style.fontWeight = 'normal';
        }
    }

    // 경고 시스템 로직
    function updateWarningSystem(lat, lng) {
        const warningStatusElement = document.getElementById('warning-status');
        const result = findNearestStation(lat, lng);
        const warningDistance = 3000; // 3km

        if (result && result.distance < warningDistance) {
            warningStatusElement.textContent = `🚨 경고: ${result.name}역 ${Math.round(result.distance)}m 근접`;
            warningStatusElement.style.color = 'red';
            warningStatusElement.style.fontWeight = 'bold';
        } else {
            warningStatusElement.textContent = '✅ 안전';
            warningStatusElement.style.color = '#4caf50';
            warningStatusElement.style.fontWeight = 'normal';
        }
    }

    // 모드 전환
    function switchMode() {
        const autoMode = document.getElementById('auto-mode');
        const manualMode = document.getElementById('manual-mode');
        if (autoMode.style.display !== 'none') {
            autoMode.style.display = 'none';
            manualMode.style.display = 'block';
            stopGPSMonitoring();
            clearMap();
        } else {
            autoMode.style.display = 'block';
            manualMode.style.display = 'none';
            clearMap();
        }
    }

    // 수동 모드 클릭 핸들러
    function handleManualClick(latlng) {
        selectedPosition = latlng;
        if (marker) {
            map.removeLayer(marker);
        }
        marker = L.marker(selectedPosition).addTo(map);
        const result = findNearestStation(selectedPosition.lat, selectedPosition.lng);
        if (result) {
            updateManualDashboard(selectedPosition.lat, selectedPosition.lng, result.name, result.distance);
        }
    }

    // 맵 초기화
    function clearMap() {
        if (marker) {
            map.removeLayer(marker);
        }
        selectedPosition = null;
        // 맵 초기화 로직
    }

    // 에러 메시지 표시 함수
    function showError(message) {
        const errorDiv = document.getElementById('error-display');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    // 초기 실행
    function initializeApp() {
        fetchAllStations();
    }
</script>

</body>
</html>
