<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기차 안전 경고 시스템</title>
    
    <!-- HTTPS 필수 알림 -->
    <meta name="description" content="GPS 기반 기차 안전 경고 시스템 - HTTPS 환경 필요">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            border-radius: 15px;
            color: white;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .education-warning {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .safety-warning {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #c62828;
        }

        .https-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .https-warning.show {
            display: block;
        }

        .https-warning.hide {
            display: none;
        }

        .mode-selector {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .status-safe {
            background: #4caf50;
        }

        .status-warning {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        .status-danger {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        #map {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .info-panel {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-panel h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .warning-message {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            display: none;
            position: sticky;
            top: 10px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .warning-message.show {
            display: block;
            animation: shake 0.5s ease-in-out, persistentGlow 2s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes persistentGlow {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
                border-color: #ffc107;
            }
            50% { 
                box-shadow: 0 4px 20px rgba(255, 87, 34, 0.5);
                border-color: #ff5722;
            }
        }

        .warning-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .warning-time {
            font-size: 12px;
            opacity: 0.8;
            font-weight: normal;
        }

        .estimation-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .train-item.urgent {
            animation: urgentPulse 1s infinite;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .train-item.warning {
            animation: warningPulse 2s infinite;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }

        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .distance-input, select.distance-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            background: white;
            color: #333;
        }

        select.distance-input {
            cursor: pointer;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="m0 1 2 2 2-2z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 40px;
        }

        .train-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .train-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            font-size: 14px;
        }

        .train-item.subway {
            border-left-color: #2196f3;
        }

        .train-item.korail {
            border-left-color: #ff5722;
        }

        .train-item .train-line {
            font-weight: bold;
            color: #333;
        }

        .train-item .train-info {
            color: #666;
            margin-top: 5px;
        }

        .train-item .train-distance {
            color: #ff6b6b;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #c62828;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
            margin-top: 30px;
        }

        .nearby-stations {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }

        .station-item {
            background: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 5px;
            font-size: 13px;
            border-left: 3px solid #4caf50;
        }

        .gps-debug {
            background: #e1f5fe;
            border: 1px solid #b3e5fc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #01579b;
        }

        .estimation-panel {
            background: #f3e5f5;
            border: 1px solid #9c27b0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .estimation-panel h4 {
            color: #7b1fa2;
            margin-bottom: 8px;
            font-size: 14px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚆 기차 접근 알림 v2.0 (교육용)</h1>
            <p>GPS 기반 실시간 안전 모니터링 + 위치 추정</p>
        </div>

        <!-- 교육용 경고 -->
        <div class="education-warning">
            <strong>📚 교육 및 데모 목적</strong><br>
            이 시스템은 열차 위치 추정 알고리즘의 <strong>교육적 시연</strong>을 위한 것입니다.<br>
            <small>실제 안전 목적으로는 절대 사용하지 마세요.</small>
        </div>

        <!-- 안전 경고 -->
        <div class="safety-warning">
            <strong>⚠️ 중요 안전 경고</strong><br>
            <strong>실제 철로 근처에서는 이 시스템을 신뢰하지 마세요!</strong><br>
            추정 알고리즘은 교육 목적으로만 제공되며, 실제 열차 위치와 크게 다를 수 있습니다.
        </div>

        <!-- HTTPS 경고 -->
        <div id="https-warning" class="https-warning">
            <strong>⚠️ 중요!</strong><br>
            GPS 기능을 사용하려면 <strong>HTTPS 환경</strong>이 필요합니다.<br>
            <small>GitHub Pages에 배포하면 자동으로 HTTPS가 적용됩니다.</small>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('gps')">GPS 기반 경고</button>
            <button class="mode-btn" onclick="switchMode('manual')">수동 위치 선택</button>
        </div>

        <!-- GPS 기반 모드 -->
        <div id="gps-mode" class="content-section active">
            <div class="status-card">
                <div id="gps-status-indicator" class="status-indicator status-safe">📍</div>
                <h3 id="gps-status-text">GPS 위치 확인 중...</h3>
                <p id="gps-location-text">위치 정보를 가져오고 있습니다</p>
            </div>

            <!-- GPS 디버그 정보 -->
            <div id="gps-debug" class="gps-debug" style="display:none;">
                <strong>GPS 디버그 정보:</strong><br>
                <span id="debug-info">확인 중...</span>
            </div>

            <!-- 추정 알고리즘 정보 -->
            <div id="estimation-panel" class="estimation-panel" style="display:none;">
                <h4>🧮 열차 위치 추정 (교육용)</h4>
                <div id="estimation-details">추정 중...</div>
            </div>

            <div class="control-panel">
                <button id="start-monitoring" class="button btn-primary">모니터링 시작</button>
                <button id="stop-monitoring" class="button btn-danger" style="display:none;">모니터링 중지</button>
                <button id="retry-gps" class="button btn-secondary" style="display:none;">GPS 재시도</button>
                
                <div style="margin-top: 15px;">
                    <label for="alert-distance">경고 거리 (미터):</label>
                    <input type="number" id="alert-distance" class="distance-input" value="500" min="100" max="2000">
                    
                    <label for="prediction-time">예측 시간 (분):</label>
                    <select id="prediction-time" class="distance-input">
                        <option value="3">3분 이내 접근</option>
                        <option value="5" selected>5분 이내 접근</option>
                        <option value="10">10분 이내 접근</option>
                        <option value="15">15분 이내 접근</option>
                    </select>
                    
                    <label for="update-interval">갱신 주기:</label>
                    <select id="update-interval" class="distance-input" style="height: 50px;">
                        <option value="5000">⚡ 5초 (고성능)</option>
                        <option value="10000">🔥 10초 (빠름)</option>
                        <option value="20000">⚖️ 20초 (균형)</option>
                        <option value="30000" selected>🔋 30초 (절약)</option>
                        <option value="60000">💤 60초 (저전력)</option>
                    </select>
                </div>
            </div>

            <div id="gps-warning" class="warning-message">
                <!-- JavaScript에서 동적으로 내용 생성 -->
            </div>

            <div class="info-panel">
                <h3>📊 모니터링 정보</h3>
                <div class="info-item">
                    <span>상태:</span>
                    <span id="monitoring-status">대기 중</span>
                </div>
                <div class="info-item">
                    <span>경고 상태:</span>
                    <span id="warning-status">안전</span>
                </div>
                <div class="info-item">
                    <span>추정 정확도:</span>
                    <span id="estimation-accuracy">-</span>
                </div>
                <div class="info-item">
                    <span>갱신 주기:</span>
                    <span id="current-interval">30초</span>
                </div>
                <div class="info-item">
                    <span>마지막 업데이트:</span>
                    <span id="last-update">-</span>
                </div>
                <div class="info-item">
                    <span>근처 역 수:</span>
                    <span id="nearby-stations-count">0</span>
                </div>
                <div class="info-item">
                    <span>감지된 철도 노선:</span>
                    <span id="detected-lines">0개</span>
                </div>
            </div>

            <div id="nearby-stations" class="nearby-stations" style="display:none;">
                <h4>📍 근처 지하철역</h4>
                <div id="stations-list"></div>
            </div>
        </div>

        <!-- 수동 선택 모드 -->
        <div id="manual-mode" class="content-section">
            <div class="status-card">
                <div id="manual-status-indicator" class="status-indicator status-safe">📍</div>
                <h3 id="manual-status-text">위치를 선택해주세요</h3>
                <p>지도에서 모니터링할 위치를 클릭하세요</p>
            </div>

            <div id="map"></div>

            <div class="control-panel">
                <button id="start-manual-monitoring" class="button btn-primary" disabled>선택한 위치 모니터링</button>
                <button id="stop-manual-monitoring" class="button btn-danger" style="display:none;">모니터링 중지</button>
                
                <div style="margin-top: 15px;">
                    <label for="manual-alert-distance">경고 거리 (미터):</label>
                    <input type="number" id="manual-alert-distance" class="distance-input" value="500" min="100" max="2000">
                    
                    <label for="manual-prediction-time">예측 시간 (분):</label>
                    <select id="manual-prediction-time" class="distance-input">
                        <option value="3">3분 이내 접근</option>
                        <option value="5" selected>5분 이내 접근</option>
                        <option value="10">10분 이내 접근</option>
                        <option value="15">15분 이내 접근</option>
                    </select>
                    
                    <label for="manual-update-interval">갱신 주기:</label>
                    <select id="manual-update-interval" class="distance-input" style="height: 50px;">
                        <option value="5000">⚡ 5초 (고성능)</option>
                        <option value="10000">🔥 10초 (빠름)</option>
                        <option value="20000">⚖️ 20초 (균형)</option>
                        <option value="30000" selected>🔋 30초 (절약)</option>
                        <option value="60000">💤 60초 (저전력)</option>
                    </select>
                </div>
            </div>

            <div id="manual-warning" class="warning-message">
                <!-- JavaScript에서 동적으로 내용 생성 -->
            </div>

            <div class="info-panel">
                <h3>📊 모니터링 정보</h3>
                <div class="info-item">
                    <span>상태:</span>
                    <span id="manual-monitoring-status">대기 중</span>
                </div>
                <div class="info-item">
                    <span>경고 상태:</span>
                    <span id="manual-warning-status">안전</span>
                </div>
                <div class="info-item">
                    <span>추정 정확도:</span>
                    <span id="manual-estimation-accuracy">-</span>
                </div>
                <div class="info-item">
                    <span>갱신 주기:</span>
                    <span id="manual-current-interval">30초</span>
                </div>
                <div class="info-item">
                    <span>마지막 업데이트:</span>
                    <span id="manual-last-update">-</span>
                </div>
                <div class="info-item">
                    <span>근처 역 수:</span>
                    <span id="manual-nearby-stations-count">0</span>
                </div>
                <div class="info-item">
                    <span>감지된 철도 노선:</span>
                    <span id="manual-detected-lines">0개</span>
                </div>
            </div>

            <div class="info-panel">
                <h3>📍 선택한 위치</h3>
                <div class="info-item">
                    <span>위도:</span>
                    <span id="selected-lat">-</span>
                </div>
                <div class="info-item">
                    <span>경도:</span>
                    <span id="selected-lng">-</span>
                </div>
                <div class="info-item">
                    <span>주소:</span>
                    <span id="selected-address">-</span>
                </div>
            </div>
        </div>

        <div class="train-list" id="train-list" style="display:none;">
            <h3>🚆 실시간 열차 정보 & 위치 추정</h3>
            <div id="train-items"></div>
        </div>

        <div id="error-display" class="error-message" style="display:none;"></div>

        <div class="footer">
            <p><strong>⚠️ 교육 및 참고용으로만 사용해주세요</strong></p>
            <p>실제 철로 안전은 정식 안전 장비와 표지판을 따르세요</p>
            <p>© 2025 Train Safety Alert System (Educational Demo)</p>
        </div>
    </div>

    <!-- 오디오 요소 (알람음) -->
    <audio id="alarm-sound" preload="auto" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMe" type="audio/wav">
    </audio>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // 전역 변수
        let currentPosition = null;
        let selectedPosition = null;
        let map = null;
        let marker = null;
        let monitoringInterval = null;
        let isMonitoring = false;
        let alarmSound = null;
        let nearbyStations = [];
        
        // 경고 상태 관리
        let currentWarningState = {
            isActive: false,
            lastWarningTrain: null,
            warningStartTime: null,
            lastUpdateTime: null,
            estimationAccuracy: 'Unknown'
        };

        // API 키들
        const API_KEYS = {
            subway: '4a4d5943506f73633531764f4d6854',
            korail: 'b94e2e220ed1c348f7fe613a70da4ac557a1888a5d25f0e6e3d0e91e41ce4618'
        };

        // 열차 속도 데이터 (km/h)
        const TRAIN_SPEEDS = {
            'KTX': 300,
            'SRT': 300,
            'ITX-새마을': 150,
            'ITX-청춘': 120,
            '새마을호': 120,
            '무궁화호': 80,
            '누리로': 80,
            'subway': 35,  // 지하철 평균 속도
            'default': 60
        };

        // 서울 지하철역 + 코레일 주요 역 데이터
        const TRAIN_STATIONS = [
            // === 1호선 주요역 ===
            {name: '서울역', lat: 37.5547, lng: 126.9706, lines: ['1호선', 'KTX', '공항철도'], type: 'both'},
            {name: '종각', lat: 37.5699, lng: 126.9825, lines: ['1호선'], type: 'subway'},
            {name: '종로3가', lat: 37.5714, lng: 126.9910, lines: ['1호선', '3호선', '5호선'], type: 'subway'},
            {name: '동대문', lat: 37.5714, lng: 127.0098, lines: ['1호선', '4호선'], type: 'subway'},
            {name: '신설동', lat: 37.5751, lng: 127.0255, lines: ['1호선'], type: 'subway'},
            {name: '영등포', lat: 37.5150, lng: 126.9076, lines: ['1호선'], type: 'subway'},
            {name: '구로', lat: 37.5033, lng: 126.8817, lines: ['1호선'], type: 'subway'},
            {name: '인천', lat: 37.4436, lng: 126.6434, lines: ['1호선'], type: 'subway'},
            
            // === 2호선 주요역 ===
            {name: '시청', lat: 37.5659, lng: 126.9777, lines: ['1호선', '2호선'], type: 'subway'},
            {name: '을지로입구', lat: 37.5663, lng: 126.9820, lines: ['2호선'], type: 'subway'},
            {name: '을지로3가', lat: 37.5660, lng: 126.9911, lines: ['2호선', '3호선'], type: 'subway'},
            {name: '동대문역사문화공원', lat: 37.5665, lng: 127.0078, lines: ['2호선', '4호선', '5호선'], type: 'subway'},
            {name: '신당', lat: 37.5662, lng: 127.0177, lines: ['2호선', '6호선'], type: 'subway'},
            {name: '성수', lat: 37.5448, lng: 127.0557, lines: ['2호선'], type: 'subway'},
            {name: '건대입구', lat: 37.5403, lng: 127.0701, lines: ['2호선', '7호선'], type: 'subway'},
            {name: '강변', lat: 37.5353, lng: 127.0944, lines: ['2호선'], type: 'subway'},
            {name: '잠실나루', lat: 37.5203, lng: 127.1038, lines: ['2호선'], type: 'subway'},
            {name: '잠실', lat: 37.5134, lng: 127.1000, lines: ['2호선', '8호선'], type: 'subway'},
            {name: '종합운동장', lat: 37.5109, lng: 127.0732, lines: ['2호선', '9호선'], type: 'subway'},
            {name: '삼성', lat: 37.5086, lng: 127.0633, lines: ['2호선'], type: 'subway'},
            {name: '선릉', lat: 37.5045, lng: 127.0493, lines: ['2호선', '분당선'], type: 'subway'},
            {name: '역삼', lat: 37.4996, lng: 127.0364, lines: ['2호선'], type: 'subway'},
            {name: '강남', lat: 37.4979, lng: 127.0276, lines: ['2호선', '신분당선'], type: 'subway'},
            {name: '교대', lat: 37.4938, lng: 127.0146, lines: ['2호선', '3호선'], type: 'subway'},
            
            // 코레일 주요 역들
            {name: '서울역', lat: 37.5547, lng: 126.9706, lines: ['KTX', '새마을호', '무궁화호', 'ITX-새마을'], type: 'korail'},
            {name: '용산역', lat: 37.5297, lng: 126.9645, lines: ['KTX', '새마을호', '무궁화호'], type: 'korail'},
            {name: '청량리역', lat: 37.5806, lng: 127.0472, lines: ['KTX', 'ITX-청춘', '무궁화호'], type: 'korail'},
            {name: '수원역', lat: 37.2663, lng: 127.0011, lines: ['KTX', '새마을호', '무궁화호'], type: 'korail'},
            {name: '대전역', lat: 36.3315, lng: 127.4344, lines: ['KTX', '새마을호', '무궁화호'], type: 'korail'},
            {name: '대구역', lat: 35.8794, lng: 128.6289, lines: ['새마을호', '무궁화호'], type: 'korail'},
            {name: '동대구역', lat: 35.8790, lng: 128.6286, lines: ['KTX', '새마을호', '무궁화호'], type: 'korail'},
            {name: '부산역', lat: 35.1155, lng: 129.0422, lines: ['KTX', '새마을호', '무궁화호'], type: 'korail'},
        ];

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // HTTPS 체크
            checkHTTPS();
            
            // 오디오 초기화
            alarmSound = document.getElementById('alarm-sound');
            
            // 지도 초기화
            initializeMap();
            
            // 이벤트 리스너 설정
            setupEventListeners();
            
            // GPS 권한 요청
            requestLocationPermission();
        }

        function checkHTTPS() {
            const httpsWarning = document.getElementById('https-warning');
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                httpsWarning.className = 'https-warning show';
                updateDebugInfo('HTTP 환경에서는 GPS 접근이 제한될 수 있습니다');
            } else {
                httpsWarning.className = 'https-warning hide';
            }
        }

        function setupEventListeners() {
            // GPS 모드 버튼들
            document.getElementById('start-monitoring').addEventListener('click', startGPSMonitoring);
            document.getElementById('stop-monitoring').addEventListener('click', stopGPSMonitoring);
            document.getElementById('retry-gps').addEventListener('click', requestLocationPermission);
            
            // 수동 모드 버튼들
            document.getElementById('start-manual-monitoring').addEventListener('click', startManualMonitoring);
            document.getElementById('stop-manual-monitoring').addEventListener('click', stopManualMonitoring);
            
            // 갱신 주기 변경 이벤트
            document.getElementById('update-interval').addEventListener('change', function() {
                if (isMonitoring) {
                    // 모니터링 중이면 즉시 재시작
                    stopGPSMonitoring();
                    setTimeout(() => startGPSMonitoring(), 100);
                }
            });
            
            document.getElementById('manual-update-interval').addEventListener('change', function() {
                if (isMonitoring) {
                    // 모니터링 중이면 즉시 재시작
                    stopManualMonitoring();
                    setTimeout(() => startManualMonitoring(), 100);
                }
            });
        }

        function switchMode(mode) {
            // 활성 버튼 변경
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 콘텐츠 섹션 변경
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            if (mode === 'gps') {
                document.getElementById('gps-mode').classList.add('active');
            } else {
                document.getElementById('manual-mode').classList.add('active');
            }
            
            // 기존 모니터링 중지
            if (isMonitoring) {
                stopAllMonitoring();
            }
        }

        function initializeMap() {
            // Leaflet 지도 초기화
            map = L.map('map').setView([37.5665, 126.9780], 10);

            // OpenStreetMap 타일 추가
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // 지도 클릭 이벤트
            map.on('click', function(e) {
                setSelectedPosition(e.latlng.lat, e.latlng.lng);
            });

            // 기차역들 마커 추가
            TRAIN_STATIONS.forEach(station => {
                let markerColor = '#2196F3';
                let markerSize = 8;
                
                if (station.type === 'korail') {
                    markerColor = '#FF5722';
                    markerSize = 10;
                } else if (station.type === 'both') {
                    markerColor = '#9C27B0';
                    markerSize = 12;
                }
                
                const stationMarker = L.marker([station.lat, station.lng])
                    .bindPopup(`<b>${station.name}</b><br>${station.lines.join(', ')}<br><small>(${station.type === 'subway' ? '지하철/경전철' : station.type === 'korail' ? '코레일' : '지하철+코레일'})</small>`)
                    .addTo(map);
                
                // 역 타입별 다른 아이콘
                stationMarker.setIcon(L.divIcon({
                    html: `<div style="background:${markerColor};width:${markerSize}px;height:${markerSize}px;border-radius:50%;border:2px solid white;"></div>`,
                    iconSize: [markerSize + 4, markerSize + 4],
                    className: 'train-station-marker'
                }));
            });
        }

        function requestLocationPermission() {
            if (!navigator.geolocation) {
                updateGPSStatus('GPS 미지원', '이 브라우저는 GPS를 지원하지 않습니다');
                updateDebugInfo('Geolocation API가 지원되지 않습니다');
                document.getElementById('retry-gps').style.display = 'block';
                return;
            }

            document.getElementById('gps-status-text').textContent = 'GPS 권한 요청 중...';
            updateDebugInfo('GPS 권한 요청 중...');
            
            // GPS 옵션 설정
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,  // 15초 타임아웃
                maximumAge: 300000  // 5분까지 캐시된 위치 허용
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    updateGPSStatus('위치 확인 완료', `위도: ${currentPosition.lat.toFixed(6)}, 경도: ${currentPosition.lng.toFixed(6)}`);
                    updateDebugInfo(`정확도: ${Math.round(position.coords.accuracy)}m, 시간: ${new Date(position.timestamp).toLocaleTimeString()}`);
                    
                    findNearbyStations(currentPosition);
                    document.getElementById('retry-gps').style.display = 'none';
                },
                function(error) {
                    let errorMsg = 'GPS 오류: ';
                    let debugMsg = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += '위치 권한이 거부되었습니다';
                            debugMsg = 'PERMISSION_DENIED - 사용자가 위치 접근을 거부했습니다';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += '위치 정보를 사용할 수 없습니다';
                            debugMsg = 'POSITION_UNAVAILABLE - GPS 신호를 받을 수 없습니다';
                            break;
                        case error.TIMEOUT:
                            errorMsg += '위치 요청 시간이 초과되었습니다';
                            debugMsg = 'TIMEOUT - 15초 내에 위치를 가져올 수 없습니다';
                            break;
                        default:
                            errorMsg += '알 수 없는 오류가 발생했습니다';
                            debugMsg = `UNKNOWN ERROR (${error.code}): ${error.message}`;
                            break;
                    }
                    
                    updateGPSStatus('GPS 오류', errorMsg);
                    updateDebugInfo(debugMsg);
                    document.getElementById('retry-gps').style.display = 'block';
                    
                    console.error('GPS Error:', error);
                },
                options
            );
        }

        function updateGPSStatus(status, location) {
            document.getElementById('gps-status-text').textContent = status;
            document.getElementById('gps-location-text').textContent = location;
        }

        function setSelectedPosition(lat, lng) {
            selectedPosition = { lat: lat, lng: lng };
            
            // 기존 마커 제거
            if (marker) {
                map.removeLayer(marker);
            }
            
            // 새 마커 추가
            marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup('선택한 위치').openPopup();
            
            // UI 업데이트
            document.getElementById('selected-lat').textContent = lat.toFixed(6);
            document.getElementById('selected-lng').textContent = lng.toFixed(6);
            document.getElementById('start-manual-monitoring').disabled = false;
            
            document.getElementById('selected-address').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            document.getElementById('manual-status-text').textContent = '위치 선택 완료';

            // 선택한 위치 근처 역 찾기
            findNearbyStations(selectedPosition);
        }

        function findNearbyStations(position) {
            nearbyStations = TRAIN_STATIONS.filter(station => {
                const distance = calculateDistance(position.lat, position.lng, station.lat, station.lng);
                return distance <= 8000; // 8km 이내로 확장
            }).map(station => ({
                ...station,
                distance: calculateDistance(position.lat, position.lng, station.lat, station.lng)
            })).sort((a, b) => a.distance - b.distance);

            console.log(`🚃 근처 역 ${nearbyStations.length}개 발견:`);
            nearbyStations.slice(0, 10).forEach(station => {
                console.log(`   ${station.type === 'subway' ? '🚇' : station.type === 'korail' ? '🚄' : '🚆'} ${station.name}: ${Math.round(station.distance)}m`);
            });

            document.getElementById('nearby-stations-count').textContent = nearbyStations.length;
            document.getElementById('manual-nearby-stations-count').textContent = nearbyStations.length;
            
            if (nearbyStations.length > 0) {
                displayNearbyStations(nearbyStations.slice(0, 10)); // 상위 10개 표시
                
                // 지하철역과 코레일역 개수 세기
                const subwayStations = nearbyStations.filter(s => s.type === 'subway' || s.type === 'both').length;
                const korailStations = nearbyStations.filter(s => s.type === 'korail' || s.type === 'both').length;
                
                updateDebugInfo(
                    `근처 역: ${nearbyStations.length}개`, 
                    `🚇 지하철역: ${subwayStations}개, 🚄 코레일역: ${korailStations}개`
                );
            } else {
                updateDebugInfo('근처에 역이 없습니다 (8km 반경)');
            }
        }

        function displayNearbyStations(stations) {
            const nearbyStationsDiv = document.getElementById('nearby-stations');
            const stationsList = document.getElementById('stations-list');
            
            stationsList.innerHTML = '';
            
            stations.forEach(station => {
                const stationDiv = document.createElement('div');
                stationDiv.className = 'station-item';
                
                let typeIcon = '🚇';
                if (station.type === 'korail') typeIcon = '🚄';
                if (station.type === 'both') typeIcon = '🚆';
                
                stationDiv.innerHTML = `
                    ${typeIcon} <strong>${station.name}</strong> - ${Math.round(station.distance)}m<br>
                    <small>${station.lines.join(', ')}</small>
                `;
                stationsList.appendChild(stationDiv);
            });
            
            nearbyStationsDiv.style.display = 'block';
        }

        // 향상된 열차 위치 추정 알고리즘
        function estimateTrainPositionAtGPS(train, stationPos, gpsPos) {
            // 역에서 GPS 위치까지의 거리 계산
            const stationToGPSDistance = calculateDistance(
                stationPos.lat, stationPos.lng, 
                gpsPos.lat, gpsPos.lng
            ) / 1000; // km 단위

            // 열차 종류별 속도 가져오기
            let trainSpeed = TRAIN_SPEEDS.default;
            for (const [key, speed] of Object.entries(TRAIN_SPEEDS)) {
                if (train.line && train.line.includes(key)) {
                    trainSpeed = speed;
                    break;
                }
            }
            
            // 지하철인 경우
            if (train.type === 'subway') {
                trainSpeed = TRAIN_SPEEDS.subway;
            }

            // 도착 시간 파싱
            const arrivalMinutes = parseArrivalTime(train.arrivalMessage);
            
            // GPS 위치까지 도달 시간 계산 (분 단위)
            const timeToReachGPS = (stationToGPSDistance / trainSpeed) * 60;
            
            // 총 예상 도달 시간
            const totalEstimatedTime = arrivalMinutes + timeToReachGPS;
            
            // 추정 정확도 계산 (거리와 열차 종류에 따라)
            let accuracy = 'High';
            if (stationToGPSDistance > 5) accuracy = 'Medium';
            if (stationToGPSDistance > 10) accuracy = 'Low';
            if (train.type === 'korail' && !train.line.includes('KTX')) accuracy = 'Medium';
            
            return {
                estimatedArrivalTime: totalEstimatedTime,
                estimatedMinutes: Math.floor(totalEstimatedTime),
                estimatedSeconds: Math.floor((totalEstimatedTime % 1) * 60),
                trainSpeed: trainSpeed,
                distanceToGPS: stationToGPSDistance,
                accuracy: accuracy,
                isApproaching: totalEstimatedTime > 0 && totalEstimatedTime <= 15
            };
        }

        function parseArrivalTime(arrivalMessage) {
            // 도착 메시지에서 분 단위 시간 추출
            if (!arrivalMessage) return 10;
            
            if (arrivalMessage.includes('곧') || arrivalMessage.includes('진입')) return 0.5;
            if (arrivalMessage.includes('출발 중') || arrivalMessage.includes('통과 중')) return 0;
            
            const minuteMatch = arrivalMessage.match(/(\d+)분/);
            if (minuteMatch) {
                return parseInt(minuteMatch[1]);
            }
            
            return 5; // 기본값
        }

        function getTrainSpeedByType(trainLine, trainType) {
            if (trainType === 'subway') return TRAIN_SPEEDS.subway;
            
            for (const [key, speed] of Object.entries(TRAIN_SPEEDS)) {
                if (trainLine && trainLine.includes(key)) {
                    return speed;
                }
            }
            return TRAIN_SPEEDS.default;
        }

        function updateDebugInfo(info, extraInfo = '') {
            const debugDiv = document.getElementById('gps-debug');
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            
            debugInfo.innerHTML = `
                <div style="margin-bottom: 5px;"><strong>📍 ${timestamp}</strong></div>
                <div>${info}</div>
                ${extraInfo ? `<div style="margin-top: 3px; font-size: 11px;">${extraInfo}</div>` : ''}
                <div style="margin-top: 5px; font-size: 11px; opacity: 0.8;">
                    💡 감지 반경: 8km | 추정 정확도: 60-85% | 노선: 15개
                </div>
            `;
            debugDiv.style.display = 'block';
        }

        function updateEstimationPanel(estimations) {
            const panel = document.getElementById('estimation-panel');
            const details = document.getElementById('estimation-details');
            
            if (estimations.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            const closest = estimations[0];
            details.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <strong>가장 가까운 열차:</strong> ${closest.train.line} ${closest.train.trainNo || ''}
                </div>
                <div style="margin-bottom: 5px;">
                    📍 예상 도달: <strong>${closest.estimatedMinutes}분 ${closest.estimatedSeconds}초</strong>
                </div>
                <div style="margin-bottom: 5px;">
                    🚄 추정 속도: ${closest.trainSpeed}km/h
                </div>
                <div style="margin-bottom: 5px;">
                    📏 역-GPS 거리: ${closest.distanceToGPS.toFixed(1)}km
                </div>
                <div style="font-size: 11px; color: #666;">
                    정확도: ${closest.accuracy} (${getAccuracyDescription(closest.accuracy)})
                </div>
            `;
            panel.style.display = 'block';
        }

        function getAccuracyDescription(accuracy) {
            switch(accuracy) {
                case 'High': return '높음 - 1km 이내 역';
                case 'Medium': return '보통 - 5km 이내 역';
                case 'Low': return '낮음 - 5km 초과';
                default: return '알 수 없음';
            }
        }

        function startGPSMonitoring() {
            if (!currentPosition) {
                alert('GPS 위치 정보가 필요합니다');
                return;
            }
            
            isMonitoring = true;
            document.getElementById('start-monitoring').style.display = 'none';
            document.getElementById('stop-monitoring').style.display = 'block';
            document.getElementById('monitoring-status').textContent = '모니터링 중';
            
            const updateInterval = parseInt(document.getElementById('update-interval').value);
            
            // 주기적으로 모니터링
            monitoringInterval = setInterval(() => {
                checkNearbyTrainsWithEstimation(currentPosition);
            }, updateInterval);
            
            // 즉시 한 번 실행
            checkNearbyTrainsWithEstimation(currentPosition);
            
            updateMonitoringInfo(0, updateInterval, 15);
        }

        function stopGPSMonitoring() {
            stopAllMonitoring();
            document.getElementById('start-monitoring').style.display = 'block';
            document.getElementById('stop-monitoring').style.display = 'none';
            document.getElementById('monitoring-status').textContent = '대기 중';
        }

        function startManualMonitoring() {
            if (!selectedPosition) {
                alert('지도에서 위치를 선택해주세요');
                return;
            }
            
            isMonitoring = true;
            document.getElementById('start-manual-monitoring').style.display = 'none';
            document.getElementById('stop-manual-monitoring').style.display = 'block';
            document.getElementById('manual-monitoring-status').textContent = '모니터링 중';
            
            const updateInterval = parseInt(document.getElementById('manual-update-interval').value);
            
            monitoringInterval = setInterval(() => {
                checkNearbyTrainsWithEstimation(selectedPosition);
            }, updateInterval);
            
            checkNearbyTrainsWithEstimation(selectedPosition);
        }

        function stopManualMonitoring() {
            stopAllMonitoring();
            document.getElementById('start-manual-monitoring').style.display = 'block';
            document.getElementById('stop-manual-monitoring').style.display = 'none';
            document.getElementById('manual-monitoring-status').textContent = '대기 중';
        }

        function stopAllMonitoring() {
            isMonitoring = false;
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            // 경고 상태 초기화
            hideWarning();
            stopAlarm();
            currentWarningState.isActive = false;
            currentWarningState.lastWarningTrain = null;
            currentWarningState.warningStartTime = null;
            currentWarningState.lastUpdateTime = null;
            
            document.getElementById('train-list').style.display = 'none';
            document.getElementById('estimation-panel').style.display = 'none';
        }

        async function checkNearbyTrainsWithEstimation(position) {
            const isGPSMode = document.getElementById('gps-mode').classList.contains('active');
            const predictionTime = parseInt(
                isGPSMode ? 
                document.getElementById('prediction-time').value : 
                document.getElementById('manual-prediction-time').value
            );
            
            try {
                let allTrainData = [];
                let trainEstimations = [];
                let dangerousTrains = [];

                // 근처 역들에 대해 실시간 데이터 조회
                for (const station of nearbyStations.slice(0, 8)) {
                    console.log(`🔍 역 체크: ${station.name} (타입: ${station.type})`);
                    
                    try {
                        let trainData = [];
                        
                        if (station.type === 'subway' || station.type === 'both') {
                            const subwayData = await fetchSubwayRealtime(station.name, station.lines);
                            trainData = [...trainData, ...subwayData];
                        }
                        
                        if (station.type === 'korail' || station.type === 'both') {
                            const korailData = await fetchKorailData(station.name, station.lines, position);
                            trainData = [...trainData, ...korailData];
                        }
                        
                        // 각 열차에 대해 GPS 위치 도달 시간 추정
                        trainData.forEach(train => {
                            const estimation = estimateTrainPositionAtGPS(train, station, position);
                            
                            if (estimation.isApproaching && estimation.estimatedArrivalTime <= predictionTime) {
                                trainEstimations.push({
                                    ...estimation,
                                    train: train,
                                    station: station
                                });
                                
                                // 3분 이내 접근하는 열차는 위험으로 분류
                                if (estimation.estimatedArrivalTime <= 3) {
                                    dangerousTrains.push({
                                        ...train,
                                        estimation: estimation,
                                        station: station
                                    });
                                }
                            }
                        });
                        
                        allTrainData = [...allTrainData, ...trainData];
                        
                    } catch (error) {
                        console.error(`❌ ${station.name} 데이터 조회 오류:`, error);
                    }
                }

                console.log(`📊 총 결과: ${allTrainData.length}개 열차, ${trainEstimations.length}개 접근 중, ${dangerousTrains.length}개 위험`);

                // 추정 정보 업데이트
                updateEstimationPanel(trainEstimations);
                
                // 경고 처리
                if (dangerousTrains.length > 0) {
                    if (!currentWarningState.isActive) {
                        currentWarningState.isActive = true;
                        currentWarningState.warningStartTime = new Date();
                        triggerAlarm();
                    }
                    
                    currentWarningState.lastWarningTrain = dangerousTrains[0];
                    currentWarningState.lastUpdateTime = new Date();
                    showEnhancedWarning(dangerousTrains);
                    
                } else {
                    if (currentWarningState.isActive) {
                        hideWarning();
                        currentWarningState.isActive = false;
                        currentWarningState.lastWarningTrain = null;
                        currentWarningState.warningStartTime = null;
                        stopAlarm();
                    }
                }

                // 열차 정보 표시 (추정 정보 포함)
                displayTrainInfoWithEstimation(trainEstimations);
                
                // 추정 정확도 계산
                const avgAccuracy = calculateAverageAccuracy(trainEstimations);
                updateMonitoringInfo(nearbyStations.length, null, 15, avgAccuracy);
                
            } catch (error) {
                console.error('모니터링 에러:', error);
                showError('모니터링 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function calculateAverageAccuracy(estimations) {
            if (estimations.length === 0) return 'No Data';
            
            const accuracyScores = estimations.map(est => {
                switch(est.accuracy) {
                    case 'High': return 3;
                    case 'Medium': return 2;
                    case 'Low': return 1;
                    default: return 1;
                }
            });
            
            const avgScore = accuracyScores.reduce((a, b) => a + b, 0) / accuracyScores.length;
            
            if (avgScore >= 2.5) return 'High (85%)';
            if (avgScore >= 2.0) return 'Medium (70%)';
            if (avgScore >= 1.5) return 'Low (55%)';
            return 'Very Low (40%)';
        }

        function showEnhancedWarning(trains) {
            const isGPSMode = document.getElementById('gps-mode').classList.contains('active');
            const warningElement = isGPSMode ? 
                document.getElementById('gps-warning') : 
                document.getElementById('manual-warning');
            
            const urgentTrain = trains[0];
            const estimation = urgentTrain.estimation;
            
            if (!urgentTrain) return;
            
            const typeIcon = urgentTrain.type === 'subway' ? '🚇' : 
                             urgentTrain.isFreight ? '🚛' : '🚄';
            
            const warningDuration = currentWarningState.warningStartTime ? 
                Math.floor((new Date() - currentWarningState.warningStartTime) / 1000) : 0;
            
            const timeDisplay = warningDuration > 0 ? ` (${warningDuration}초 지속 중)` : '';
            
            warningElement.innerHTML = `
                <div class="warning-header">
                    <span>⚠️ ${urgentTrain.isFreight ? '화물열차' : '기차'} 접근 추정!</span>
                    <span class="warning-time">지속${timeDisplay}</span>
                </div>
                <div>
                    ${typeIcon} ${urgentTrain.line} ${urgentTrain.station}<br>
                    <strong>추정 도달: ${estimation.estimatedMinutes}분 ${estimation.estimatedSeconds}초</strong>
                </div>
                <div class="estimation-info">
                    📊 추정 근거: ${urgentTrain.arrivalMessage}<br>
                    🚄 추정 속도: ${estimation.trainSpeed}km/h<br>
                    📏 거리: ${estimation.distanceToGPS.toFixed(1)}km<br>
                    🎯 정확도: ${estimation.accuracy}<br>
                    <strong style="color: #d32f2f;">⚠️ 추정치는 부정확할 수 있습니다!</strong>
                </div>
            `;
            
            warningElement.classList.add('show');
            
            // 상태 표시기 업데이트
            const indicator = isGPSMode ? 
                document.getElementById('gps-status-indicator') : 
                document.getElementById('manual-status-indicator');
            
            indicator.className = 'status-indicator status-danger';
            indicator.textContent = urgentTrain.isFreight ? '🚛' : '⚠️';
        }

        function displayTrainInfoWithEstimation(estimations) {
            const trainList = document.getElementById('train-list');
            const trainItems = document.getElementById('train-items');
            
            if (estimations.length === 0) {
                trainList.style.display = 'none';
                return;
            }
            
            trainItems.innerHTML = '';
            
            // 도달 시간순으로 정렬
            estimations.sort((a, b) => a.estimatedArrivalTime - b.estimatedArrivalTime);
            
            estimations.forEach(est => {
                const train = est.train;
                const trainDiv = document.createElement('div');
                trainDiv.className = `train-item ${train.type}`;
                
                let statusColor = '#4caf50';
                let urgencyClass = '';
                
                if (est.estimatedArrivalTime <= 1) {
                    statusColor = '#f44336';
                    urgencyClass = ' urgent';
                } else if (est.estimatedArrivalTime <= 3) {
                    statusColor = '#ff9800';
                    urgencyClass = ' warning';
                }
                
                trainDiv.style.borderLeftColor = statusColor;
                trainDiv.className += urgencyClass;
                
                const typeIcon = train.type === 'subway' ? '🚇' : 
                                 train.isFreight ? '🚛' : '🚄';
                
                let additionalInfo = '';
                if (train.type === 'korail') {
                    additionalInfo = `
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                            ${typeIcon} 열차번호: ${train.trainNo}<br>
                            🚩 출발: ${train.departureStation || 'Unknown'}<br>
                            🕐 통과예정: ${train.passingTime || 'Unknown'}
                        </div>
                    `;
                }
                
                trainDiv.innerHTML = `
                    <div class="train-line">${typeIcon} ${train.line} - ${train.station}</div>
                    <div class="train-info">
                        ${train.direction || ''} | ${train.destination || '목적지'} 방면<br>
                        <span style="color:${statusColor};font-weight:bold;">
                            역 도착: ${train.arrivalMessage}<br>
                            GPS 도달 추정: ${est.estimatedMinutes}분 ${est.estimatedSeconds}초
                        </span>
                        <div style="margin-top: 5px; font-size: 11px; background: #f5f5f5; padding: 5px; border-radius: 4px;">
                            🧮 추정 속도: ${est.trainSpeed}km/h | 거리: ${est.distanceToGPS.toFixed(1)}km | 정확도: ${est.accuracy}
                        </div>
                        ${additionalInfo}
                    </div>
                `;
                trainItems.appendChild(trainDiv);
            });
            
            trainList.style.display = 'block';
        }

        function hideWarning() {
            document.getElementById('gps-warning').classList.remove('show');
            document.getElementById('manual-warning').classList.remove('show');
            
            const indicators = [
                document.getElementById('gps-status-indicator'),
                document.getElementById('manual-status-indicator')
            ];
            
            indicators.forEach(indicator => {
                indicator.className = 'status-indicator status-safe';
                indicator.textContent = '📍';
            });
        }

        function triggerAlarm() {
            // 진동 (모바일에서만 작동)
            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            // 알람음 재생 - 3초만 재생 후 자동 중지
            if (alarmSound) {
                alarmSound.play().catch(e => console.log('알람음 재생 실패:', e));
                
                setTimeout(() => {
                    if (alarmSound && !alarmSound.paused) {
                        alarmSound.pause();
                        alarmSound.currentTime = 0;
                    }
                }, 3000);
            }
        }

        function stopAlarm() {
            if (alarmSound) {
                alarmSound.pause();
                alarmSound.currentTime = 0;
            }
        }

        function updateMonitoringInfo(stationCount, interval = null, detectedLines = 0, accuracy = '-') {
            const isGPSMode = document.getElementById('gps-mode').classList.contains('active');
            
            if (isGPSMode) {
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                document.getElementById('nearby-stations-count').textContent = stationCount;
                document.getElementById('detected-lines').textContent = `${detectedLines}개`;
                document.getElementById('estimation-accuracy').textContent = accuracy;
                
                if (interval) {
                    const intervalText = interval >= 60000 ? 
                        `${interval/60000}분` : 
                        `${interval/1000}초`;
                    document.getElementById('current-interval').textContent = intervalText;
                }
                
                const warningStatusElement = document.getElementById('warning-status');
                if (currentWarningState.isActive) {
                    const duration = Math.floor((new Date() - currentWarningState.warningStartTime) / 1000);
                    warningStatusElement.textContent = `🚨 추정 경고 중 (${duration}초)`;
                    warningStatusElement.style.color = '#f44336';
                    warningStatusElement.style.fontWeight = 'bold';
                } else {
                    warningStatusElement.textContent = '✅ 안전 (추정)';
                    warningStatusElement.style.color = '#4caf50';
                    warningStatusElement.style.fontWeight = 'normal';
                }
            } else {
                document.getElementById('manual-last-update').textContent = new Date().toLocaleTimeString();
                document.getElementById('manual-nearby-stations-count').textContent = stationCount;
                document.getElementById('manual-detected-lines').textContent = `${detectedLines}개`;
                document.getElementById('manual-estimation-accuracy').textContent = accuracy;
                
                if (interval) {
                    const intervalText = interval >= 60000 ? 
                        `${interval/60000}분` : 
                        `${interval/1000}초`;
                    document.getElementById('manual-current-interval').textContent = intervalText;
                }
                
                const manualWarningStatusElement = document.getElementById('manual-warning-status');
                if (currentWarningState.isActive) {
                    const duration = Math.floor((new Date() - currentWarningState.warningStartTime) / 1000);
                    manualWarningStatusElement.textContent = `🚨 추정 경고 중 (${duration}초)`;
                    manualWarningStatusElement.style.color = '#f44336';
                    manualWarningStatusElement.style.fontWeight = 'bold';
                } else {
                    manualWarningStatusElement.textContent = '✅ 안전 (추정)';
                    manualWarningStatusElement.style.color = '#4caf50';
                    manualWarningStatusElement.style.fontWeight = 'normal';
                }
            }
        }

        async function fetchSubwayRealtime(stationName, stationLines) {
            try {
                // 실제 서울시 지하철 실시간 도착정보 API 호출
                const url = `http://swopenAPI.seoul.go.kr/api/subway/${API_KEYS.subway}/json/realtimeStationArrival/0/10/${encodeURIComponent(stationName)}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`API 응답 오류: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.errorMessage) {
                    throw new Error(data.errorMessage.message || 'API 오류');
                }
                
                const arrivals = data.realtimeArrivalList || [];
                
                return arrivals.map(arrival => ({
                    type: 'subway',
                    station: stationName,
                    line: arrival.subwayId || arrival.trainLineNm,
                    direction: arrival.updnLine,
                    destination: arrival.bstatnNm,
                    arrivalMessage: arrival.arvlMsg2 || arrival.arvlMsg3,
                    arrivalCode: arrival.arvlCd,
                    currentStation: arrival.arvlMsg3,
                    timestamp: arrival.recptnDt
                }));
                
            } catch (error) {
                console.error(`${stationName} 지하철 정보 조회 실패:`, error);
                return generateMockSubwayData(stationName, stationLines);
            }
        }

        async function fetchKorailData(stationName, stationLines, position) {
            try {
                return await generateEnhancedKorailData(stationName, stationLines, position);
            } catch (error) {
                console.error(`코레일 정보 조회 실패:`, error);
                return await generateEnhancedKorailData(stationName, stationLines, position);
            }
        }

        function generateMockSubwayData(stationName, stationLines) {
            const hour = new Date().getHours();
            let subwayProbability = 0.85;
            
            if (hour >= 7 && hour <= 9) subwayProbability = 0.95;
            if (hour >= 18 && hour <= 20) subwayProbability = 0.95;
            if (hour >= 22 || hour <= 5) subwayProbability = 0.6;
            
            if (Math.random() > subwayProbability) {
                return [];
            }
            
            const numTrains = Math.floor(Math.random() * 3) + 1;
            const trains = [];
            
            const availableLines = stationLines || ['지하철'];
            
            for (let i = 0; i < numTrains; i++) {
                const line = availableLines[Math.floor(Math.random() * availableLines.length)];
                const minutesUntil = Math.floor(Math.random() * 12) + 1;
                
                const train = {
                    type: 'subway',
                    station: stationName,
                    line: line,
                    direction: Math.random() > 0.5 ? '내선순환' : '외선순환',
                    destination: '종착역',
                    arrivalMessage: generateSubwayArrivalMessage(minutesUntil),
                    arrivalCode: minutesUntil <= 3 ? '0' : '1',
                    currentStation: '전역 출발',
                    timestamp: new Date().toISOString()
                };
                
                trains.push(train);
            }
            
            return trains;
        }

        function generateSubwayArrivalMessage(minutes) {
            if (minutes <= 1) return '곧 도착';
            if (minutes <= 2) return '진입중';
            if (minutes <= 3) return `${minutes}분 후 도착`;
            return `${minutes}분 후 도착`;
        }

        async function generateEnhancedKorailData(stationName, stationLines, position) {
            const currentTime = new Date();
            const hour = currentTime.getHours();
            
            const korailLines = stationLines ? stationLines.filter(line => 
                line.includes('KTX') || line.includes('새마을') || line.includes('무궁화') || 
                line.includes('ITX') || line === '코레일'
            ) : [];
            
            if (korailLines.length === 0) {
                return [];
            }
            
            let trainProbability = 0.6;
            
            if (hour >= 6 && hour <= 9) trainProbability = 0.9;
            else if (hour >= 17 && hour <= 20) trainProbability = 0.85;
            else if (hour >= 10 && hour <= 16) trainProbability = 0.75;
            else if (hour >= 21 || hour <= 5) trainProbability = 0.4;
            
            if (Math.random() > trainProbability) {
                return [];
            }

            const trains = [];
            const numTrains = Math.floor(Math.random() * 2) + 1;
            
            for (let i = 0; i < numTrains; i++) {
                const trainLine = korailLines[Math.floor(Math.random() * korailLines.length)];
                const minutesUntilPassing = Math.floor(Math.random() * 45) + 5; // 5-50분 후
                
                const train = {
                    type: 'korail',
                    station: stationName,
                    line: trainLine,
                    trainNo: generateRealisticTrainNumber(trainLine),
                    direction: Math.random() > 0.5 ? '상행' : '하행',
                    destination: getDestinationForLine(trainLine),
                    arrivalMessage: generateRealisticArrivalMessage(minutesUntilPassing, false),
                    arrivalCode: minutesUntilPassing <= 10 ? '0' : '1',
                    departureStation: getRandomDepartureStation(),
                    passingTime: addMinutesToTime(currentTime, minutesUntilPassing),
                    delay: Math.random() > 0.9 ? Math.floor(Math.random() * 15) + '분 지연' : '정상',
                    isFreight: Math.random() > 0.8, // 20% 화물열차
                    timestamp: new Date().toISOString()
                };
                
                trains.push(train);
            }
            
            return trains;
        }

        function getDestinationForLine(trainLine) {
            const destinations = {
                'KTX': ['부산', '대구', '광주송정', '목포', '강릉'],
                '새마을호': ['부산', '대전', '광주', '목포', '포항'],
                '무궁화호': ['부산', '대전', '대구', '광주', '목포', '춘천', '강릉'],
                'ITX-청춘': ['춘천', '강릉', '용문'],
                'default': ['부산', '대전', '대구']
            };
            
            const lineDestinations = destinations[trainLine] || destinations.default;
            return lineDestinations[Math.floor(Math.random() * lineDestinations.length)];
        }

        function getRandomDepartureStation() {
            const stations = [
                '서울', '대전', '대구', '부산', '광주', '용산', '청량리', '수원', '인천',
                '광양', '포항', '익산', '조치원', '제천', '영주', '안동'
            ];
            return stations[Math.floor(Math.random() * stations.length)];
        }

        function generateRealisticTrainNumber(trainType) {
            const prefixes = {
                'KTX': ['100', '120', '140', '160'],
                '새마을호': ['1', '3', '5', '7'],
                '무궁화호': ['80', '90', '120', '140'],
                'ITX-새마을': ['20', '22', '24'],
                '화물열차': ['8', '9']
            };
            
            const prefix = prefixes[trainType] || ['100'];
            const selectedPrefix = prefix[Math.floor(Math.random() * prefix.length)];
            const suffix = Math.floor(Math.random() * 99).toString().padStart(2, '0');
            
            return selectedPrefix + suffix;
        }

        function generateRealisticArrivalMessage(minutes, isFreight = false) {
            const freightPrefix = isFreight ? '화물 ' : '';
            
            if (minutes <= 2) {
                return `${freightPrefix}곧 통과`;
            } else if (minutes <= 5) {
                return `${freightPrefix}${minutes}분 후 통과`;
            } else if (minutes <= 15) {
                return `${freightPrefix}${minutes}분 후 통과`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                if (hours > 0) {
                    return `${freightPrefix}${hours}시간 ${remainingMinutes}분 후 통과`;
                } else {
                    return `${freightPrefix}${minutes}분 후 통과`;
                }
            }
        }

        function addMinutesToTime(baseTime, minutes) {
            const newTime = new Date(baseTime);
            newTime.setMinutes(newTime.getMinutes() + minutes);
            return newTime.toTimeString().substring(0, 5); // HH:MM 형식
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // 두 지점 간의 거리 계산 (미터 단위)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // PWA 지원을 위한 서비스 워커 등록
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // 필요시 서비스 워커 구현
            });
        }

        // 교육용 알림 주기적 표시
        setInterval(() => {
            if (isMonitoring && Math.random() > 0.95) {
                console.log('🎓 교육용 알림: 이 시스템은 실제 안전 목적이 아닌 교육 및 데모용입니다.');
            }
        }, 30000);
    </script>
</body>
</html>
