<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ì°¨ ì•ˆì „ ê²½ê³  ì‹œìŠ¤í…œ</title>
    
    <!-- HTTPS í•„ìˆ˜ ì•Œë¦¼ -->
    <meta name="description" content="GPS ê¸°ë°˜ ê¸°ì°¨ ì•ˆì „ ê²½ê³  ì‹œìŠ¤í…œ - HTTPS í™˜ê²½ í•„ìš”">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            border-radius: 15px;
            color: white;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .https-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .https-warning.show {
            display: block;
        }

        .https-warning.hide {
            display: none;
        }

        .mode-selector {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .status-safe {
            background: #4caf50;
        }

        .status-warning {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        .status-danger {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        #map {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .info-panel {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-panel h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .warning-message {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            display: none;
            position: sticky;
            top: 10px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .warning-message.show {
            display: block;
            animation: shake 0.5s ease-in-out, persistentGlow 2s infinite;
        }

        @keyframes persistentGlow {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
                border-color: #ffc107;
            }
            50% { 
                box-shadow: 0 4px 20px rgba(255, 87, 34, 0.5);
                border-color: #ff5722;
            }
        }

        .warning-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .warning-time {
            font-size: 12px;
            opacity: 0.8;
            font-weight: normal;
        }

        .train-item.urgent {
            animation: urgentPulse 1s infinite;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .train-item.warning {
            animation: warningPulse 2s infinite;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }

        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes warningPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .distance-input, select.distance-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            background: white;
            color: #333;
        }

        select.distance-input {
            cursor: pointer;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="m0 1 2 2 2-2z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 40px;
        }

        .train-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .train-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            font-size: 14px;
        }

        .train-item.subway {
            border-left-color: #2196f3;
        }

        .train-item.korail {
            border-left-color: #ff5722;
        }

        .train-item .train-line {
            font-weight: bold;
            color: #333;
        }

        .train-item .train-info {
            color: #666;
            margin-top: 5px;
        }

        .train-item .train-distance {
            color: #ff6b6b;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #c62828;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
            margin-top: 30px;
        }

        .nearby-stations {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }

        .station-item {
            background: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 5px;
            font-size: 13px;
            border-left: 3px solid #4caf50;
        }

        .gps-debug {
            background: #e1f5fe;
            border: 1px solid #b3e5fc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #01579b;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš† ê¸°ì°¨ ì ‘ê·¼ ì•Œë¦¼ v1.3</h1>
            <p>GPS ê¸°ë°˜ ì‹¤ì‹œê°„ ì•ˆì „ ëª¨ë‹ˆí„°ë§</p>
        </div>

        <!-- HTTPS ê²½ê³  -->
        <div id="https-warning" class="https-warning">
            <strong>âš ï¸ ì¤‘ìš”!</strong><br>
            GPS ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ <strong>HTTPS í™˜ê²½</strong>ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
            <small>GitHub Pagesì— ë°°í¬í•˜ë©´ ìë™ìœ¼ë¡œ HTTPSê°€ ì ìš©ë©ë‹ˆë‹¤.</small>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('gps')">GPS ê¸°ë°˜ ê²½ê³ </button>
            <button class="mode-btn" onclick="switchMode('manual')">ìˆ˜ë™ ìœ„ì¹˜ ì„ íƒ</button>
        </div>

        <!-- GPS ê¸°ë°˜ ëª¨ë“œ -->
        <div id="gps-mode" class="content-section active">
            <div class="status-card">
                <div id="gps-status-indicator" class="status-indicator status-safe">ğŸ“</div>
                <h3 id="gps-status-text">GPS ìœ„ì¹˜ í™•ì¸ ì¤‘...</h3>
                <p id="gps-location-text">ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤</p>
            </div>

            <!-- GPS ë””ë²„ê·¸ ì •ë³´ -->
            <div id="gps-debug" class="gps-debug" style="display:none;">
                <strong>GPS ë””ë²„ê·¸ ì •ë³´:</strong><br>
                <span id="debug-info">í™•ì¸ ì¤‘...</span>
            </div>

            <div class="control-panel">
                <button id="start-monitoring" class="button btn-primary">ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
                <button id="stop-monitoring" class="button btn-danger" style="display:none;">ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
                <button id="retry-gps" class="button btn-secondary" style="display:none;">GPS ì¬ì‹œë„</button>
                
                <div style="margin-top: 15px;">
                    <label for="alert-distance">ê²½ê³  ê±°ë¦¬ (ë¯¸í„°):</label>
                    <input type="number" id="alert-distance" class="distance-input" value="500" min="100" max="2000">
                    
                    <label for="update-interval">ê°±ì‹  ì£¼ê¸°:</label>
                    <select id="update-interval" class="distance-input" style="height: 50px;">
                        <option value="5000">âš¡ 5ì´ˆ (ê³ ì„±ëŠ¥)</option>
                        <option value="10000">ğŸ”¥ 10ì´ˆ (ë¹ ë¦„)</option>
                        <option value="20000">âš–ï¸ 20ì´ˆ (ê· í˜•)</option>
                        <option value="30000" selected>ğŸ”‹ 30ì´ˆ (ì ˆì•½)</option>
                        <option value="60000">ğŸ’¤ 60ì´ˆ (ì €ì „ë ¥)</option>
                    </select>
                </div>
            </div>

            <div id="gps-warning" class="warning-message">
                <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë‚´ìš© ìƒì„± -->
            </div>

            <div class="info-panel">
                <h3>ğŸ“Š ëª¨ë‹ˆí„°ë§ ì •ë³´</h3>
                <div class="info-item">
                    <span>ìƒíƒœ:</span>
                    <span id="monitoring-status">ëŒ€ê¸° ì¤‘</span>
                </div>
                <div class="info-item">
                    <span>ê²½ê³  ìƒíƒœ:</span>
                    <span id="warning-status">ì•ˆì „</span>
                </div>
                <div class="info-item">
                    <span>ê°±ì‹  ì£¼ê¸°:</span>
                    <span id="current-interval">30ì´ˆ</span>
                </div>
                <div class="info-item">
                    <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</span>
                    <span id="last-update">-</span>
                </div>
                <div class="info-item">
                    <span>ê·¼ì²˜ ì—­ ìˆ˜:</span>
                    <span id="nearby-stations-count">0</span>
                </div>
                <div class="info-item">
                    <span>ê°ì§€ëœ ì² ë„ ë…¸ì„ :</span>
                    <span id="detected-lines">0ê°œ</span>
                </div>
            </div>

            <div id="nearby-stations" class="nearby-stations" style="display:none;">
                <h4>ğŸ“ ê·¼ì²˜ ì§€í•˜ì² ì—­</h4>
                <div id="stations-list"></div>
            </div>
        </div>

        <!-- ìˆ˜ë™ ì„ íƒ ëª¨ë“œ -->
        <div id="manual-mode" class="content-section">
            <div class="status-card">
                <div id="manual-status-indicator" class="status-indicator status-safe">ğŸ“</div>
                <h3 id="manual-status-text">ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
                <p>ì§€ë„ì—ì„œ ëª¨ë‹ˆí„°ë§í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”</p>
            </div>

            <div id="map"></div>

            <div class="control-panel">
                <button id="start-manual-monitoring" class="button btn-primary" disabled>ì„ íƒí•œ ìœ„ì¹˜ ëª¨ë‹ˆí„°ë§</button>
                <button id="stop-manual-monitoring" class="button btn-danger" style="display:none;">ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
                
                <div style="margin-top: 15px;">
                    <label for="manual-alert-distance">ê²½ê³  ê±°ë¦¬ (ë¯¸í„°):</label>
                    <input type="number" id="manual-alert-distance" class="distance-input" value="500" min="100" max="2000">
                    
                    <label for="manual-update-interval">ê°±ì‹  ì£¼ê¸°:</label>
                    <select id="manual-update-interval" class="distance-input" style="height: 50px;">
                        <option value="5000">âš¡ 5ì´ˆ (ê³ ì„±ëŠ¥)</option>
                        <option value="10000">ğŸ”¥ 10ì´ˆ (ë¹ ë¦„)</option>
                        <option value="20000">âš–ï¸ 20ì´ˆ (ê· í˜•)</option>
                        <option value="30000" selected>ğŸ”‹ 30ì´ˆ (ì ˆì•½)</option>
                        <option value="60000">ğŸ’¤ 60ì´ˆ (ì €ì „ë ¥)</option>
                    </select>
                </div>
            </div>

            <div id="manual-warning" class="warning-message">
                <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë‚´ìš© ìƒì„± -->
            </div>

            <div class="info-panel">
                <h3>ğŸ“Š ëª¨ë‹ˆí„°ë§ ì •ë³´</h3>
                <div class="info-item">
                    <span>ìƒíƒœ:</span>
                    <span id="manual-monitoring-status">ëŒ€ê¸° ì¤‘</span>
                </div>
                <div class="info-item">
                    <span>ê²½ê³  ìƒíƒœ:</span>
                    <span id="manual-warning-status">ì•ˆì „</span>
                </div>
                <div class="info-item">
                    <span>ê°±ì‹  ì£¼ê¸°:</span>
                    <span id="manual-current-interval">30ì´ˆ</span>
                </div>
                <div class="info-item">
                    <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</span>
                    <span id="manual-last-update">-</span>
                </div>
                <div class="info-item">
                    <span>ê·¼ì²˜ ì—­ ìˆ˜:</span>
                    <span id="manual-nearby-stations-count">0</span>
                </div>
                <div class="info-item">
                    <span>ê°ì§€ëœ ì² ë„ ë…¸ì„ :</span>
                    <span id="manual-detected-lines">0ê°œ</span>
                </div>
            </div>

            <div class="info-panel">
                <h3>ğŸ“ ì„ íƒí•œ ìœ„ì¹˜</h3>
                <div class="info-item">
                    <span>ìœ„ë„:</span>
                    <span id="selected-lat">-</span>
                </div>
                <div class="info-item">
                    <span>ê²½ë„:</span>
                    <span id="selected-lng">-</span>
                </div>
                <div class="info-item">
                    <span>ì£¼ì†Œ:</span>
                    <span id="selected-address">-</span>
                </div>
            </div>
        </div>

        <div class="train-list" id="train-list" style="display:none;">
            <h3>ğŸš† ì‹¤ì‹œê°„ ì—´ì°¨ ì •ë³´</h3>
            <div id="train-items"></div>
        </div>

        <div id="error-display" class="error-message" style="display:none;"></div>

        <div class="footer">
            <p>ì•ˆì „ì„ ìœ„í•œ ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•´ì£¼ì„¸ìš”</p>
            <p>Â© 2025 Train Safety Alert System</p>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ ìš”ì†Œ (ì•ŒëŒìŒ) -->
    <audio id="alarm-sound" preload="auto" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMe" type="audio/wav">
    </audio>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

<script>
    // ì œê³µëœ API í‚¤ë¥¼ ë³€ìˆ˜ë¡œ ì €ì¥
    const seoulSubwayApiKey = '4a4d5943506f73633531764f4d6854';
    const korailApiKey = 'b94e2e220ed1c348f7fe613a70da4ac557a1888a5d25f0e6e3d0e91e41ce4618';

    // ì „ì—­ ë³€ìˆ˜
    let currentPosition = null;
    let selectedPosition = null;
    let map = null;
    let marker = null;
    let monitoringInterval = null;
    let isMonitoring = false;
    let alarmSound = null;
    let allStations = []; // ë™ì  ë¡œë”©ëœ ëª¨ë“  ì—­ ì •ë³´

    // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.addEventListener('DOMContentLoaded', () => {
        const warningElement = document.getElementById('https-warning');
        if (window.location.protocol !== 'https:') {
            warningElement.style.display = 'block';
        } else {
            warningElement.style.display = 'none';
        }
        initializeMap();
        initializeApp();
    });

    // ì§€ë„ ì´ˆê¸°í™”
    function initializeMap() {
        if (!map) {
            map = L.map('map').setView([37.5665, 126.9780], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            map.on('click', function(e) {
                if (document.getElementById('manual-mode').style.display === 'block') {
                    handleManualClick(e.latlng);
                }
            });
        }
    }

    // ëª¨ë“  ì—­ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    async function fetchAllStations() {
        console.log("ëª¨ë“  ì—­ ì •ë³´ ë¡œë”© ì¤‘...");
        try {
            // ì„œìš¸ì‹œ ì§€í•˜ì²  API í˜¸ì¶œ (ìƒ˜í”Œ URL)
            const seoulUrl = `http://openAPI.seoul.go.kr:8088/${seoulSubwayApiKey}/json/SearchInfoBySubwayNameService/1/1000/`;
            const seoulResponse = await fetch(seoulUrl);
            const seoulData = await seoulResponse.json();

            // ì½”ë ˆì¼ API í˜¸ì¶œ (ìƒ˜í”Œ URL)
            const korailUrl = `http://apis.data.go.kr/3011000/TrainSttnInfoService/getTrainSttnInfo?serviceKey=${korailApiKey}&pageNo=1&numOfRows=1000&_type=json`;
            const korailResponse = await fetch(korailUrl);
            const korailData = await korailResponse.json();

            // API ì‘ë‹µì—ì„œ ì—­ ì •ë³´ë¥¼ íŒŒì‹±í•˜ì—¬ allStations ë°°ì—´ì— ì¶”ê°€
            if (seoulData.SearchInfoBySubwayNameService && seoulData.SearchInfoBySubwayNameService.row) {
                seoulData.SearchInfoBySubwayNameService.row.forEach(station => {
                    allStations.push({ name: station.STATION_NM, lat: parseFloat(station.X_COORD), lng: parseFloat(station.Y_COORD), type: 'subway' });
                });
            }
            if (korailData.response && korailData.response.body && korailData.response.body.items && korailData.response.body.items.item) {
                korailData.response.body.items.item.forEach(station => {
                    allStations.push({ name: station.sttnNm, lat: parseFloat(station.sttnLat), lng: parseFloat(station.sttnLon), type: 'korail' });
                });
            }
            
            console.log("ëª¨ë“  ì—­ ì •ë³´ ë¡œë”© ì™„ë£Œ. ì´ ì—­ ê°œìˆ˜:", allStations.length);
        } catch (error) {
            console.error("ì—­ ì •ë³´ ë¡œë”© ì‹¤íŒ¨:", error);
            showError("ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
    }

    // ë‘ ì§€ì  ê°„ì˜ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„)
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371e3; // Earth's radius in meters
        const Ï†1 = lat1 * Math.PI/180;
        const Ï†2 = lat2 * Math.PI/180;
        const Î”Ï† = (lat2-lat1) * Math.PI/180;
        const Î”Î» = (lng2-lng1) * Math.PI/180;
        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // GPS ìœ„ì¹˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ì¥ ê°€ê¹Œìš´ ì—­ì„ ì°¾ëŠ” í•¨ìˆ˜
    function findNearestStation(lat, lng) {
        let minDistance = Infinity;
        let nearestStation = null;

        for (const station of allStations) {
            const distance = calculateDistance(lat, lng, station.lat, station.lng);
            if (distance < minDistance) {
                minDistance = distance;
                nearestStation = station;
            }
        }
        return { ...nearestStation, distance: minDistance };
    }

    // GPS ìˆ˜ì‹  ì„±ê³µ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function onGPSSuccess(position) {
        currentPosition = position;
        const { latitude, longitude } = position.coords;
        updateAutoDashboard(latitude, longitude);
        updateWarningSystem(latitude, longitude);
    }

    // GPS ìˆ˜ì‹  ì‹¤íŒ¨ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function onGPSFailure(error) {
        console.error("GPS ì˜¤ë¥˜:", error);
        showError("GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìœ„ì¹˜ ì •ë³´ê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
        stopMonitoring();
    }
    
    // GPS ëª¨ë‹ˆí„°ë§ ì‹œì‘
    function startGPSMonitoring() {
        if (!isMonitoring) {
            isMonitoring = true;
            monitoringInterval = navigator.geolocation.watchPosition(onGPSSuccess, onGPSFailure, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
            document.getElementById('start-gps-btn').textContent = 'GPS ëª¨ë‹ˆí„°ë§ ì¤‘ì§€';
            document.getElementById('start-gps-btn').classList.add('active');
            console.log("GPS ëª¨ë‹ˆí„°ë§ ì‹œì‘");
        } else {
            stopGPSMonitoring();
        }
    }
    
    // GPS ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
    function stopGPSMonitoring() {
        if (isMonitoring && monitoringInterval) {
            navigator.geolocation.clearWatch(monitoringInterval);
            isMonitoring = false;
            document.getElementById('start-gps-btn').textContent = 'GPS ëª¨ë‹ˆí„°ë§ ì‹œì‘';
            document.getElementById('start-gps-btn').classList.remove('active');
            console.log("GPS ëª¨ë‹ˆí„°ë§ ì¤‘ì§€");
            updateAutoDashboard(null, null);
        }
    }

    // ìë™ ëª¨ë“œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    function updateAutoDashboard(lat, lng) {
        if (lat && lng) {
            const result = findNearestStation(lat, lng);
            document.getElementById('gps-status-text').textContent = 'ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ';
            document.getElementById('gps-location-text').textContent = `ìœ„ë„: ${lat.toFixed(6)}, ê²½ë„: ${lng.toFixed(6)}`;
            document.getElementById('nearest-station-auto').textContent = `ê°€ì¥ ê°€ê¹Œìš´ ì—­: ${result.name} (${Math.round(result.distance)}m)`;
            document.getElementById('auto-warning-status').textContent = 'âœ… ì•ˆì „';
        } else {
            document.getElementById('gps-status-text').textContent = 'GPS ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨';
            document.getElementById('gps-location-text').textContent = '-';
            document.getElementById('nearest-station-auto').textContent = '-';
            document.getElementById('auto-warning-status').textContent = '-';
        }
    }
    
    // ìˆ˜ë™ ëª¨ë“œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    function updateManualDashboard(lat, lng, name, distance) {
        document.getElementById('manual-location-text').textContent = `ìœ„ë„: ${lat.toFixed(6)}, ê²½ë„: ${lng.toFixed(6)}`;
        document.getElementById('selected-station-name').textContent = `ì„ íƒëœ ì—­: ${name}`;
        document.getElementById('manual-warning-status').textContent = `ê±°ë¦¬: ${Math.round(distance)}m`;
        updateManualWarningSystem(distance);
    }
    
    // ìˆ˜ë™ ëª¨ë“œ ê²½ê³  ì‹œìŠ¤í…œ
    function updateManualWarningSystem(distance) {
        const manualWarningStatusElement = document.getElementById('manual-warning-status');
        const warningDistance = 3000; // 3km
        if (distance < warningDistance) {
            manualWarningStatusElement.textContent = `ğŸš¨ ê²½ê³ : ${Math.round(distance)}m ê·¼ì ‘`;
            manualWarningStatusElement.style.color = 'red';
            manualWarningStatusElement.style.fontWeight = 'bold';
        } else {
            manualWarningStatusElement.textContent = 'âœ… ì•ˆì „';
            manualWarningStatusElement.style.color = '#4caf50';
            manualWarningStatusElement.style.fontWeight = 'normal';
        }
    }

    // ê²½ê³  ì‹œìŠ¤í…œ ë¡œì§
    function updateWarningSystem(lat, lng) {
        const warningStatusElement = document.getElementById('warning-status');
        const result = findNearestStation(lat, lng);
        const warningDistance = 3000; // 3km

        if (result && result.distance < warningDistance) {
            warningStatusElement.textContent = `ğŸš¨ ê²½ê³ : ${result.name}ì—­ ${Math.round(result.distance)}m ê·¼ì ‘`;
            warningStatusElement.style.color = 'red';
            warningStatusElement.style.fontWeight = 'bold';
        } else {
            warningStatusElement.textContent = 'âœ… ì•ˆì „';
            warningStatusElement.style.color = '#4caf50';
            warningStatusElement.style.fontWeight = 'normal';
        }
    }

    // ëª¨ë“œ ì „í™˜
    function switchMode() {
        const autoMode = document.getElementById('auto-mode');
        const manualMode = document.getElementById('manual-mode');
        if (autoMode.style.display !== 'none') {
            autoMode.style.display = 'none';
            manualMode.style.display = 'block';
            stopGPSMonitoring();
            clearMap();
        } else {
            autoMode.style.display = 'block';
            manualMode.style.display = 'none';
            clearMap();
        }
    }

    // ìˆ˜ë™ ëª¨ë“œ í´ë¦­ í•¸ë“¤ëŸ¬
    function handleManualClick(latlng) {
        selectedPosition = latlng;
        if (marker) {
            map.removeLayer(marker);
        }
        marker = L.marker(selectedPosition).addTo(map);
        const result = findNearestStation(selectedPosition.lat, selectedPosition.lng);
        if (result) {
            updateManualDashboard(selectedPosition.lat, selectedPosition.lng, result.name, result.distance);
        }
    }

    // ë§µ ì´ˆê¸°í™”
    function clearMap() {
        if (marker) {
            map.removeLayer(marker);
        }
        selectedPosition = null;
        // ë§µ ì´ˆê¸°í™” ë¡œì§
    }

    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showError(message) {
        const errorDiv = document.getElementById('error-display');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    // ì´ˆê¸° ì‹¤í–‰
    function initializeApp() {
        fetchAllStations();
    }
</script>

</body>
</html>
